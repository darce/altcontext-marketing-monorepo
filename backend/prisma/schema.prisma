generator client {
  provider   = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
}

enum ConsentStatus {
  pending
  express
  implied
  withdrawn
}

enum LinkSource {
  form_submit
  same_ip_ua_window
  manual_merge
}

enum ValidationStatus {
  accepted
  rejected
  invalid
}

enum TrafficSource {
  direct
  organic_search
  paid_search
  social
  email
  referral
  campaign
  internal
  unknown
}

enum DeviceType {
  desktop
  mobile
  tablet
  bot
  unknown
}

model Tenant {
  id        String   @id @default(dbgenerated("uuidv7()")) @db.Uuid
  name      String
  slug      String   @unique
  plan      String   @default("free")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  visitors           Visitor[]
  sessions           Session[]
  events             Event[]
  leads              Lead[]
  leadIdentities     LeadIdentity[]
  formSubmissions    FormSubmission[]
  consentEvents      ConsentEvent[]
  ingestRejections   IngestRejection[]
  dailyMetricRollups DailyMetricRollup[]
  dailyIngestRollups DailyIngestRollup[]
  apiKeys            ApiKey[]
  users              User[]
  authSessions       AuthSession[]

  @@map("tenants")
}

model ApiKey {
  id        String    @id @default(dbgenerated("uuidv7()")) @db.Uuid
  tenantId  String    @map("tenant_id") @db.Uuid
  keyHash   String    @unique @map("key_hash") @db.VarChar(64)
  keyPrefix String    @map("key_prefix") @db.VarChar(16)
  label     String?   @db.VarChar(255)
  scope     String    @db.VarChar(20) // "ingest" or "admin"
  expiresAt DateTime? @map("expires_at")
  revokedAt DateTime? @map("revoked_at")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("api_keys")
}

model User {
  id        String   @id @default(dbgenerated("uuidv7()")) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  email     String
  name      String?
  role      String   @default("member")
  passwordHash String? @map("password_hash") @db.VarChar(255)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  authSessions AuthSession[]

  @@unique([tenantId, email])
  @@map("users")
}

model AuthSession {
  id        String   @id @default(dbgenerated("uuidv7()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, userId], map: "auth_sessions_tenant_id_user_id_idx")
  @@index([tenantId, expiresAt], map: "auth_sessions_tenant_id_expires_at_idx")
  @@map("auth_sessions")
}

model Visitor {
  id          String   @id @default(dbgenerated("(uuidv7())::text"))
  tenantId    String   @map("tenant_id") @db.Uuid
  anonId      String   @map("anon_id")
  firstSeenAt DateTime @default(now()) @map("first_seen_at")
  lastSeenAt  DateTime @default(now()) @map("last_seen_at")
  firstIpHash String?  @map("first_ip_hash") @db.VarChar(128)
  lastIpHash  String?  @map("last_ip_hash") @db.VarChar(128)
  firstUaHash String?  @map("first_ua_hash") @db.VarChar(128)
  lastUaHash  String?  @map("last_ua_hash") @db.VarChar(128)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  sessions        Session[]
  events          Event[]
  leadIdentities  LeadIdentity[]
  formSubmissions FormSubmission[]

  @@unique([tenantId, anonId])
  @@index([tenantId, lastSeenAt], map: "visitors_tenant_id_last_seen_at_idx")
  @@map("visitors")
}

model Session {
  id          String    @id @default(dbgenerated("(uuidv7())::text"))
  tenantId    String    @map("tenant_id") @db.Uuid
  visitorId   String    @map("visitor_id")
  startedAt   DateTime  @default(now()) @map("started_at")
  endedAt     DateTime? @map("ended_at")
  lastEventAt DateTime  @default(now()) @map("last_event_at")
  landingPath String?   @map("landing_path") @db.Text
  referrer    String?   @db.Text
  utmSource   String?   @map("utm_source") @db.VarChar(255)
  utmMedium   String?   @map("utm_medium") @db.VarChar(255)
  utmCampaign String?   @map("utm_campaign") @db.VarChar(255)
  utmTerm     String?   @map("utm_term") @db.VarChar(255)
  utmContent  String?   @map("utm_content") @db.VarChar(255)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  visitor         Visitor          @relation(fields: [visitorId], references: [id], onDelete: Cascade)
  events          Event[]
  formSubmissions FormSubmission[]

  @@index([tenantId, visitorId, startedAt], map: "sessions_tenant_id_visitor_id_started_at_idx")
  @@index([tenantId, visitorId, lastEventAt], map: "sessions_tenant_id_visitor_id_last_event_at_idx")
  @@map("sessions")
}

model Event {
  id            String        @id @default(dbgenerated("(uuidv7())::text"))
  tenantId      String        @map("tenant_id") @db.Uuid
  visitorId     String        @map("visitor_id")
  sessionId     String?       @map("session_id")
  dedupeKey     String?       @map("dedupe_key") @db.VarChar(64)
  eventType     String        @map("event_type") @db.VarChar(64)
  path          String?       @db.Text
  timestamp     DateTime      @default(now())
  ipHash        String?       @map("ip_hash") @db.VarChar(128)
  uaHash        String?       @map("ua_hash") @db.VarChar(128)
  props         Json?
  propertyId    String        @default("default") @map("property_id") @db.VarChar(128)
  trafficSource TrafficSource @default(unknown) @map("traffic_source")
  deviceType    DeviceType    @default(unknown) @map("device_type")
  countryCode   String?       @map("country_code") @db.VarChar(2)
  isEntrance    Boolean       @default(false) @map("is_entrance")
  isExit        Boolean       @default(false) @map("is_exit")
  isConversion  Boolean       @default(false) @map("is_conversion")
  createdAt     DateTime      @default(now()) @map("created_at")

  tenant  Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  visitor Visitor  @relation(fields: [visitorId], references: [id], onDelete: Cascade)
  session Session? @relation(fields: [sessionId], references: [id], onDelete: SetNull)

  @@unique([tenantId, dedupeKey])
  @@index([tenantId, visitorId, timestamp], map: "events_tenant_id_visitor_id_timestamp_idx")
  @@index([tenantId, eventType, timestamp], map: "events_tenant_id_event_type_timestamp_idx")
  @@index([tenantId, path, timestamp], map: "events_tenant_id_path_timestamp_idx")
  @@index([tenantId, sessionId, timestamp], map: "events_tenant_id_session_id_timestamp_idx")
  @@index([tenantId, propertyId, timestamp], map: "events_tenant_id_property_id_timestamp_idx")
  @@index([tenantId, trafficSource, timestamp], map: "events_tenant_id_traffic_source_timestamp_idx")
  @@map("events")
}

model Lead {
  id              String        @id @default(dbgenerated("(uuidv7())::text"))
  tenantId        String        @map("tenant_id") @db.Uuid
  emailNormalized String        @map("email_normalized") @db.VarChar(320)
  // Generated in DB: split_part(email_normalized, '@', 2)
  emailDomain     String?       @map("email_domain") @default(dbgenerated("split_part((email_normalized)::text, '@'::text, 2)")) @db.VarChar(255) @ignore
  consentStatus   ConsentStatus @default(pending) @map("consent_status")
  firstCapturedAt DateTime      @default(now()) @map("first_captured_at")
  lastCapturedAt  DateTime      @default(now()) @map("last_captured_at")
  sourceChannel   String?       @map("source_channel") @db.VarChar(255)
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  tenant        Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  identities    LeadIdentity[]
  submissions   FormSubmission[]
  consentEvents ConsentEvent[]

  @@unique([tenantId, emailNormalized])
  @@index([tenantId, lastCapturedAt], map: "leads_tenant_id_last_captured_at_idx")
  @@map("leads")
}

model LeadIdentity {
  id         String     @id @default(dbgenerated("(uuidv7())::text"))
  tenantId   String     @map("tenant_id") @db.Uuid
  leadId     String     @map("lead_id")
  visitorId  String     @map("visitor_id")
  linkSource LinkSource @default(form_submit) @map("link_source")
  confidence Float      @default(1)
  linkedAt   DateTime   @default(now()) @map("linked_at")
  createdAt  DateTime   @default(now()) @map("created_at")

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  lead    Lead    @relation(fields: [leadId], references: [id], onDelete: Cascade)
  visitor Visitor @relation(fields: [visitorId], references: [id], onDelete: Cascade)

  @@unique([tenantId, leadId, visitorId, linkSource], map: "lead_identities_tenant_id_lead_visitor_source_key")
  @@index([tenantId, leadId, linkedAt], map: "lead_identities_tenant_id_lead_id_linked_at_idx")
  @@index([tenantId, visitorId, linkedAt], map: "lead_identities_tenant_id_visitor_id_linked_at_idx")
  @@map("lead_identities")
}

model FormSubmission {
  id               String           @id @default(dbgenerated("(uuidv7())::text"))
  tenantId         String           @map("tenant_id") @db.Uuid
  leadId           String?          @map("lead_id")
  visitorId        String?          @map("visitor_id")
  sessionId        String?          @map("session_id")
  formName         String           @map("form_name") @db.VarChar(255)
  payload          Json?
  submittedAt      DateTime         @default(now()) @map("submitted_at")
  validationStatus ValidationStatus @default(accepted) @map("validation_status")
  createdAt        DateTime         @default(now()) @map("created_at")

  tenant  Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  lead    Lead?    @relation(fields: [leadId], references: [id], onDelete: SetNull)
  visitor Visitor? @relation(fields: [visitorId], references: [id], onDelete: SetNull)
  session Session? @relation(fields: [sessionId], references: [id], onDelete: SetNull)

  @@index([tenantId, leadId, submittedAt], map: "form_submissions_tenant_id_lead_id_submitted_at_idx")
  @@index([tenantId, visitorId, submittedAt], map: "form_submissions_tenant_id_visitor_id_submitted_at_idx")
  @@index([tenantId, sessionId, submittedAt], map: "form_submissions_tenant_id_session_id_submitted_at_idx")
  @@map("form_submissions")
}

model ConsentEvent {
  id        String        @id @default(dbgenerated("(uuidv7())::text"))
  tenantId  String        @map("tenant_id") @db.Uuid
  leadId    String        @map("lead_id")
  status    ConsentStatus
  source    String        @db.VarChar(128)
  ipHash    String?       @map("ip_hash") @db.VarChar(128)
  timestamp DateTime      @default(now())
  createdAt DateTime      @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  lead   Lead   @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([tenantId, leadId, timestamp], map: "consent_events_tenant_id_lead_id_timestamp_idx")
  @@map("consent_events")
}

model IngestRejection {
  id         String   @id @default(dbgenerated("(uuidv7())::text"))
  tenantId   String   @map("tenant_id") @db.Uuid
  propertyId String   @map("property_id") @db.VarChar(128)
  endpoint   String   @db.VarChar(64)
  reason     String   @db.VarChar(64)
  statusCode Int      @map("status_code")
  occurredAt DateTime @default(now()) @map("occurred_at")
  createdAt  DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, propertyId, occurredAt], map: "ingest_rejections_tenant_id_property_id_occurred_at_idx")
  @@index([tenantId, endpoint, occurredAt], map: "ingest_rejections_tenant_id_endpoint_occurred_at_idx")
  @@map("ingest_rejections")
}

model DailyMetricRollup {
  id                      String   @id @default(dbgenerated("(uuidv7())::text"))
  tenantId                String   @map("tenant_id") @db.Uuid
  propertyId              String   @map("property_id") @db.VarChar(128)
  day                     DateTime @db.Date
  uniqueVisitors          Int      @default(0) @map("unique_visitors")
  returningVisitors       Int      @default(0) @map("returning_visitors")
  totalPageViews          Int      @default(0) @map("total_page_views")
  totalEntrances          Int      @default(0) @map("total_entrances")
  totalExits              Int      @default(0) @map("total_exits")
  totalConversions        Int      @default(0) @map("total_conversions")
  formStarts              Int      @default(0) @map("form_starts")
  formSubmits             Int      @default(0) @map("form_submits")
  newLeads                Int      @default(0) @map("new_leads")
  timeToFirstCaptureSumMs BigInt   @default(0) @map("time_to_first_capture_sum_ms")
  timeToFirstCaptureCount Int      @default(0) @map("time_to_first_capture_count")
  trafficSourceBreakdown  Json?    @map("traffic_source_breakdown")
  topLandingPaths         Json?    @map("top_landing_paths")
  generatedAt             DateTime @default(now()) @map("generated_at")
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, propertyId, day], map: "daily_metric_rollups_tenant_id_property_day_key")
  @@index([tenantId, day], map: "daily_metric_rollups_tenant_id_day_idx")
  @@map("daily_metric_rollups")
}

model DailyIngestRollup {
  id             String   @id @default(dbgenerated("(uuidv7())::text"))
  tenantId       String   @map("tenant_id") @db.Uuid
  propertyId     String   @map("property_id") @db.VarChar(128)
  day            DateTime @db.Date
  eventsAccepted Int      @default(0) @map("events_accepted")
  eventsRejected Int      @default(0) @map("events_rejected")
  leadsAccepted  Int      @default(0) @map("leads_accepted")
  leadsRejected  Int      @default(0) @map("leads_rejected")
  p95TtfbMs      Int?     @map("p95_ttfb_ms")
  errorBreakdown Json?    @map("error_breakdown")
  generatedAt    DateTime @default(now()) @map("generated_at")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, propertyId, day], map: "daily_ingest_rollups_tenant_id_property_day_key")
  @@index([tenantId, day], map: "daily_ingest_rollups_tenant_id_day_idx")
  @@map("daily_ingest_rollups")
}

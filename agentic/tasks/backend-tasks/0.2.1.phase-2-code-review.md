# Phase 2 Code Review

Review of `backend/src/` Phase 2 implementation (dashboard rollups and metrics) against the task spec (`0.2.backend-phase-2-dashboard-rollups-and-metrics.md`), instructions (`agentic/instructions/`), and the backend roadmap.

## Pre-Review: Run Deterministic Gates

> [!IMPORTANT]
> Before spending review time on style, types, or formatting, run the automated quality gates. These catch violations deterministically — do not waste inference or reviewer attention on anything the toolchain already covers.

```sh
make -C backend audit          # typecheck + lint + format + dead-exports + duplicates
```

If `make` is unavailable, run individually:

```sh
npm --prefix backend run typecheck   # tsc --noEmit (strict mode, noUncheckedIndexedAccess)
npm --prefix backend run lint        # eslint (floating promises, no-any, node: prefix, arrow callbacks, unused vars, type imports)
npm --prefix backend run format      # prettier --check
npm --prefix backend run dead-exports # ts-prune: find exports with zero consumers
npm --prefix backend run duplicates  # jscpd: detect copy-paste clones
```

Refer to [`backend/verification.md`](../../agentic/instructions/backend/verification.md) for the full matrix of which language-standard rules are enforced by tooling vs. which require manual review.

---

## Checklist Compliance

### Rollup Engine (`services/metrics/rollups.ts`)

| Checklist item | Status | Notes |
|---|---|---|
| `computeDailyMetrics` computes all MVP metrics | ✅ | 6 parallel SQL queries: traffic totals, form metrics, new leads, time-to-capture, traffic source breakdown, landing paths |
| Ingest rollup computed in parallel | ✅ | 3 parallel queries: events accepted, leads accepted/rejected, p95 latency |
| Property-aware filtering | ✅ | Conditional SQL fragments for non-default properties via `isDefaultProperty` guard |
| Upsert (idempotent) | ✅ | `prisma.dailyMetricRollup.upsert` + `prisma.dailyIngestRollup.upsert` with composite unique key |
| `rollupDateRange` batched | ✅ | Days sliced by `batchSize`, each batch `Promise.all` |
| `getRollupFreshness` | ✅ | Queries latest rollup day, computes lag against UTC today |
| No serial independent awaits | ✅ | Two `Promise.all` blocks (6-way + 3-way), then dual upsert `Promise.all` |

### Summary Aggregation (`services/metrics/summary.ts`)

| Checklist item | Status | Notes |
|---|---|---|
| `fetchMetricsSummary` fetches window + comparison | ✅ | 5-way `Promise.all` |
| `aggregateWindow` reduces daily rows | ✅ | Sums all numeric fields, accumulates traffic source counts |
| Comparison deltas | ✅ | `toMetricValue` computes `(current - baseline) / baseline` |
| Zero-fill trend | ✅ | `buildTrend` fills missing days with zeroes |
| `trafficSourceMix` normalized | ✅ | Uses all `TrafficSource` enum keys, proportional to total |
| Shared date utilities from `schemas/metrics.ts` | ✅ | `formatIsoDay`, `addUtcDays`, `dayDiffInclusive`, `startOfUtcDay` all imported |

### Route + Schema

| Checklist item | Status | Notes |
|---|---|---|
| `GET /v1/metrics/summary` registered | ✅ | `routes/metrics.ts` → `app.ts` |
| Admin auth required | ✅ | `assertAdminRequest` from `lib/admin-auth.ts` |
| Zod validation at boundary | ✅ | `summaryQuerySchema.parse(request.query)` |
| Rate limited | ✅ | 60/min |
| `compareTo` boolean coercion | ✅ | Handles `"1"`, `"true"`, `"yes"`, `"on"` |
| Window ≤ 366 days guard | ✅ | `superRefine` validation |

### Scripts

| Checklist item | Status | Notes |
|---|---|---|
| `rollups-run.ts` — default window | ✅ | Uses `env.ROLLUP_BATCH_DAYS` + `env.ROLLUP_DEFAULT_PROPERTY_ID` |
| `rollups-backfill.ts` — CLI with `--from/--to/--property-id` | ✅ | Manual arg parser, validates from ≤ to |
| `rollups-status.ts` — freshness report | ✅ | Prints rollup counts + lag days |
| All scripts: `process.exitCode = 1` | ✅ | All three use `.catch()` → `process.exitCode = 1` |
| All scripts: `prisma.$disconnect()` in `finally` | ✅ | All three |
| All scripts: `void run()` prefix | ✅ | All three |

### Tests

| Checklist item | Status | Notes |
|---|---|---|
| Auth tests (missing key, wrong key, unconfigured) | ✅ | `metrics.test.ts` |
| Full summary response contract | ✅ | Validates all metric fields, trend array, ingest block |
| Empty window returns zeroed metrics | ✅ | `metrics.test.ts` |
| Idempotent upsert | ✅ | `rollups.test.ts` — run twice, count stays 1 |
| Recompute after data change | ✅ | `rollups.test.ts` |
| Multi-day window | ✅ | `rollups.test.ts` |
| UTC day boundary correctness | ✅ | `rollups.test.ts` |
| Schema validation tests | ✅ | `schemas.test.ts` — parse, coercion, rejection |

---

## Language Standards Compliance

### Automatically verified (tooling)

Run `make -C backend check` — all three gates must pass. These cover:

- No floating promises (`@typescript-eslint/no-floating-promises`)
- Consistent type imports (`@typescript-eslint/consistent-type-imports`)
- No unused variables (`@typescript-eslint/no-unused-vars`)
- Strict types, no implicit any (`tsconfig.json` strict mode)
- No unchecked indexed access
- Formatting

### Manually verified

| Rule | Status | Notes |
|---|---|---|
| Arrow functions only | ✅ | Zero `function` declarations across all Phase 2 files |
| No `any` casts | ✅ | Zero `any` usage |
| `node:*` imports | ✅ | `admin-auth.ts` uses `node:crypto` (only Node builtin in Phase 2) |
| Shared schemas not duplicated | ✅ | `rollups-backfill.ts` imports shared `parseIsoDay` from `schemas/metrics.ts` |
| No dead exports | ✅ | Removed unused `daysBetween` export from `summary.ts` |
| No blind casts on untrusted data | ✅ | Raw SQL results typed via narrow interfaces + safe converters |
| Centralised error handling | ✅ | App-level Zod handler + shared `assertAdminRequest` |
| Use write results, not re-reads | ✅ | No transactions; upserts are standalone |
| No serial independent awaits | ✅ | Extensive `Promise.all` throughout |
| Metric columns reflect real data | ✅ | `eventsRejected`/`leadsRejected` populated from persisted `ingest_rejections` + submission status |
| Column names match data source | ✅ | Renamed rollup field to `p95TtfbMs` |
| Percentile aggregation correctness | ✅ | Replaced max-of-dailies with event-weighted approximation and explicit TTFB naming |

---

## Bugs (Resolved)

### B1: p95 latency aggregation semantics — resolved

**File**: `services/metrics/summary.ts` lines 191–195

`aggregateWindow` now computes an event-weighted approximation across daily `p95TtfbMs` values instead of taking max-per-day. Field semantics were also made explicit (`TTFB`, not ingest runtime latency).

**Implemented**:
1. Weighted approximation at window-aggregation time.
2. Response and schema naming updated to `p95TtfbMs`.

### B2: `eventsRejected` hardcoded to `0` — resolved

**File**: `services/metrics/rollups.ts` line 352

Implemented `ingest_rejections` persistence and wired app-level Zod 400 handling for ingest endpoints (`/v1/events`, `/v1/leads/capture`). Rollups now aggregate real rejection counts from that table.

### B3: `p95LatencyMs` stores browser TTFB, not API ingest latency — resolved

**File**: `services/metrics/rollups.ts` lines 314–322

Schema/model/response field renamed to `p95TtfbMs` so consumers are not misled about metric source.

---

## Antipatterns (Resolved)

### A1: Duplicated `parseIsoDay` — resolved

**File**: `scripts/rollups-backfill.ts` lines 51–67

`rollups-backfill.ts` now imports `parseIsoDay` from `schemas/metrics.ts`.

### A2: Dead export `daysBetween` — resolved

**File**: `services/metrics/summary.ts` line 415

Removed dead export from `summary.ts`; no zero-consumer export remains for this helper.

### A3: Duplicated upsert field maps — resolved

**File**: `services/metrics/rollups.ts` lines 354–420

`metricRollupValues` and `ingestRollupValues` objects now drive both `create` and `update` paths for each upsert.

---

## Remediation Checklist

> Mark items `[x]` as each fix is applied. Items are ordered by severity.

- [x] **B1** — Fix p95 aggregation or rename field to `peakP95`
- [x] **B2** — Mark `eventsRejected` as stub with TODO comment, or drop column
- [x] **B3** — Rename `p95LatencyMs` → `p95TtfbMs` (schema migration required)
- [x] **A1** — Replace local `parseIsoDay` in `rollups-backfill.ts` with import from `schemas/metrics.ts`
- [x] **A2** — Remove dead `daysBetween` export from `summary.ts`
- [x] **A3** — Extract shared upsert field objects in `rollups.ts`
- [x] Run `make -C backend check` — all gates green
- [x] Run `make -C backend test` — all tests pass
- [x] Verify no new lint warnings introduced

---

## Verification Protocol

1. **Automated gates first**: `make -C backend audit` must pass before any manual review begins. This runs typecheck + lint + format + dead-exports + duplicates.
2. **Manual review**: Walk the "Rules not yet enforced by tooling" list from `backend/verification.md` against every changed file. Only 6 rules remain manual after the ESLint hardening.
3. **Remediation**: Apply fixes from the checklist above.
4. **Re-run gates**: `make -C backend audit && make -C backend test` after all fixes.
5. **Sign-off**: All remediation items checked, all gates green, ready for PR.

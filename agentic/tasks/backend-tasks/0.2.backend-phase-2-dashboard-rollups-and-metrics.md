# Backend Phase 2: Dashboard Rollups and Metrics API

## Problem Statement

Phase 0-1 capture is implemented and code-reviewed. Dashboard-ready metrics are still missing. The backend needs a durable read model and an internal summary endpoint so marketing can query core funnel and traffic KPIs without scanning raw event tables. This phase must keep ingestion non-blocking and add operationally safe, repeatable rollup workflows.

Several code-review findings from `0.1.1.phase-0-1-code-review.md` affect metric accuracy and must be resolved as prerequisites or early tasks in this phase.

## Workflow Principles

- Keep write-path latency low; analytical reads should query rollups, not raw events.
- Admin/internal metrics endpoints must reuse the existing `ADMIN_API_KEY` + `x-admin-key` auth pattern.
- Use deterministic metric definitions with UTC day boundaries to avoid drift.
- Rollup jobs must be idempotent and safe to re-run for backfill/repair.

## Terminology

- **Rollup**: Pre-aggregated daily metrics derived from raw events, sessions, `web_traffic_logs`, form submissions, and leads.
- **Summary Window**: Caller-selected date range (e.g., 7d/30d/90d) for dashboard totals/trends.
- **Comparison Window**: A second date range of equal length immediately preceding the summary window, used to compute period-over-period deltas.
- **Freshness**: Lag between current time and last successfully rolled-up UTC day.
- **Ingest Reliability**: Delivery quality indicators (success ratio, p95 TTFB approximation, ingest failures).

## Current State Analysis

### Implemented (confirmed in source)

- Capture endpoints (`/v1/events`, `/v1/leads/capture`) with Zod validation.
- Consent/unsubscribe/delete workflows with PIPEDA payload scrub.
- CORS via `@fastify/cors` with `CORS_ALLOWED_ORIGINS`.
- Central Zod error handler in `app.ts` (code review A1 resolved).
- Admin auth (`ADMIN_API_KEY`, timing-safe `x-admin-key` check) on `POST /v1/leads/delete`.
- Shared UTM schema extracted to `schemas/shared.ts` (code review A2 resolved).
- `WebTrafficLog` model with rich dimensions: `trafficSource`, `deviceType`, geo fields, web vitals (`fcpMs`, `lcpMs`, `inpMs`, `clsScore`, `ttfbMs`), engagement (`engagedTimeMs`, `scrollDepthPercent`), and funnel flags (`isEntrance`, `isExit`, `isConversion`).
- Form POST fallback: 303 redirect for `application/x-www-form-urlencoded` requests.
- 90-day event retention purge script (`scripts/purge-retention.ts`).

### Not yet implemented

- Infrastructure-level ingest failure accounting beyond validation-path rejection capture remains open.

### Code review items affecting Phase 2 metric accuracy

| Review ID | Issue                                                    | Phase 2 Impact                                        | Resolution                                                          |
| --------- | -------------------------------------------------------- | ----------------------------------------------------- | ------------------------------------------------------------------- |
| G3        | Session `endedAt` never backfilled on inactivity timeout | Session duration metrics use stale `endedAt` values   | Fix in session service before rollup derivation                     |
| G4        | Purge script leaves orphaned sessions/visitors           | Visitor/session counts inflate over time              | Extend purge to clean orphaned rows                                 |
| G5        | No event dedup (stretch)                                 | Duplicate beacon retries inflate rollup counts        | Accept for now; document as known limitation; add dedup index later |
| B3        | Race on upsert + consent read                            | Possible duplicate consent events under burst         | Low risk; pass upsert result directly instead of re-reading         |
| A3        | HMAC instance per call                                   | Minor perf overhead on every request                  | Optional; cache key material if profiling shows cost                |
| E1        | Serial heuristic link round-trips                        | Not directly metric-affecting, but slows lead capture | Batch with `Promise.all` when convenient                            |

## Proposed Solution

1. **Prerequisites**: Extract shared admin auth, fix session `endedAt` backfill, extend purge script.
2. **Rollup scaffolding**: Add `DailyMetricRollup` + `DailyIngestRollup` models, migration, env config, Make targets.
3. **Rollup generation**: Derive all roadmap §8 MVP metrics from the data model with UTC day boundaries.
4. **Summary API**: Serve KPI windows from rollups via `GET /v1/metrics/summary` with admin auth, comparison windows, and freshness metadata.
5. **Tests**: Idempotency, auth, response contract, edge cases.

## MVP Metric Definitions (Roadmap §8)

Each metric maps to specific tables and formulas:

| Metric                       | Source Table(s)                 | Formula                                                                                 |
| ---------------------------- | ------------------------------- | --------------------------------------------------------------------------------------- |
| Unique visitors (daily)      | `web_traffic_logs`              | `COUNT(DISTINCT visitor_id) WHERE occurred_at IN day`                                   |
| Returning visitors %         | `web_traffic_logs` + `visitors` | Visitors with `first_seen_at < day_start` ÷ total unique visitors                       |
| Traffic source mix           | `web_traffic_logs`              | `GROUP BY traffic_source`, count per source ÷ total                                     |
| Landing page conversion rate | `web_traffic_logs`              | Entrances with `is_conversion = true` ÷ total entrances (per path)                      |
| Form completion rate         | `events`                        | `event_type = 'form_submit'` ÷ `event_type = 'form_start'` per day                      |
| Lead capture rate            | `leads` + `web_traffic_logs`    | New leads (by `first_captured_at` in day) ÷ unique visitors                             |
| Time-to-first-capture        | `leads` + `visitors`            | `AVG(lead.first_captured_at - visitor.first_seen_at)` for leads captured in day         |
| Ingest success %             | `DailyIngestRollup`             | `events_accepted ÷ (events_accepted + events_rejected)`                                 |
| Ingest p95 TTFB              | `DailyIngestRollup`             | Stored from browser `ttfbMs` daily p95 and aggregated with event-weighted approximation |

## Rollup Schema

```prisma
model DailyMetricRollup {
  id                      String   @id @default(uuid())
  propertyId              String   @db.VarChar(128) @map("property_id")
  day                     DateTime @db.Date
  uniqueVisitors          Int      @default(0) @map("unique_visitors")
  returningVisitors       Int      @default(0) @map("returning_visitors")
  totalPageViews          Int      @default(0) @map("total_page_views")
  totalEntrances          Int      @default(0) @map("total_entrances")
  totalExits              Int      @default(0) @map("total_exits")
  totalConversions        Int      @default(0) @map("total_conversions")
  formStarts              Int      @default(0) @map("form_starts")
  formSubmits             Int      @default(0) @map("form_submits")
  newLeads                Int      @default(0) @map("new_leads")
  timeToFirstCaptureSumMs BigInt   @default(0) @map("time_to_first_capture_sum_ms")
  timeToFirstCaptureCount Int      @default(0) @map("time_to_first_capture_count")
  trafficSourceBreakdown  Json?    @map("traffic_source_breakdown")
  topLandingPaths         Json?    @map("top_landing_paths")
  generatedAt             DateTime @default(now()) @map("generated_at")
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")

  @@unique([propertyId, day], map: "daily_metric_rollups_property_day_key")
  @@index([day], map: "daily_metric_rollups_day_idx")
  @@map("daily_metric_rollups")
}

model DailyIngestRollup {
  id              String   @id @default(uuid())
  propertyId      String   @db.VarChar(128) @map("property_id")
  day             DateTime @db.Date
  eventsAccepted  Int      @default(0) @map("events_accepted")
  eventsRejected  Int      @default(0) @map("events_rejected")
  leadsAccepted   Int      @default(0) @map("leads_accepted")
  leadsRejected   Int      @default(0) @map("leads_rejected")
  p95TtfbMs       Int?     @map("p95_ttfb_ms")
  errorBreakdown  Json?    @map("error_breakdown")
  generatedAt     DateTime @default(now()) @map("generated_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@unique([propertyId, day], map: "daily_ingest_rollups_property_day_key")
  @@index([day], map: "daily_ingest_rollups_day_idx")
  @@map("daily_ingest_rollups")
}
```

## Patterns to Follow

### Daily Rollup Upsert Pattern

```typescript
const upsertDailyMetric = async (tx, day, propertyId, values) =>
  tx.dailyMetricRollup.upsert({
    where: { propertyId_day: { propertyId, day } },
    update: { ...values, generatedAt: new Date() },
    create: { propertyId, day, ...values },
  });
```

### Admin Auth Extraction (reuse existing pattern)

```typescript
// lib/admin-auth.ts — extract from routes/leads.ts
import { timingSafeEqual } from "node:crypto";
import { env } from "../config/env.js";

export const assertAdminRequest = (request, reply) => {
  if (!env.ADMIN_API_KEY) {
    request.log.error("ADMIN_API_KEY is not configured");
    return reply
      .code(503)
      .send({ ok: false, error: "admin_auth_not_configured" });
  }
  const requestKey = request.headers["x-admin-key"];
  if (typeof requestKey !== "string" || !hasValidAdminKey(requestKey)) {
    return reply.code(401).send({ ok: false, error: "unauthorized" });
  }
};

const hasValidAdminKey = (requestKey: string): boolean => {
  const configuredKey = env.ADMIN_API_KEY;
  if (!configuredKey) return false;
  const configured = Buffer.from(configuredKey);
  const supplied = Buffer.from(requestKey);
  if (configured.length !== supplied.length) return false;
  return timingSafeEqual(configured, supplied);
};
```

### Summary Endpoint

```typescript
const getMetricsSummary = async (request, reply) => {
  assertAdminRequest(request, reply);
  const query = summaryQuerySchema.parse(request.query);
  const summary = await metricsService.fetchSummary(query);
  return reply.code(200).send({ ok: true, ...summary });
};
```

## Functions to Change

| File                                       | Change                                                                                               |
| ------------------------------------------ | ---------------------------------------------------------------------------------------------------- |
| `backend/src/lib/admin-auth.ts`            | **New.** Extract `hasValidAdminKey` + `assertAdminRequest` from `routes/leads.ts`.                   |
| `backend/src/routes/leads.ts`              | Import auth helpers from `lib/admin-auth.ts`; remove local `hasValidAdminKey`.                       |
| `backend/src/services/visitors.ts`         | Fix G3: backfill previous session `endedAt` when a new session is created due to inactivity timeout. |
| `backend/src/scripts/purge-retention.ts`   | Fix G4: after event purge, delete orphaned sessions (no events) and visitors (no sessions).          |
| `backend/prisma/schema.prisma`             | Add `DailyMetricRollup` and `DailyIngestRollup` models.                                              |
| `backend/prisma/migrations/*`              | New migration for rollup tables and indexes.                                                         |
| `backend/src/config/env.ts`                | Add `ROLLUP_BATCH_DAYS` (default 7) and `ROLLUP_DEFAULT_PROPERTY_ID` (default `"default"`).          |
| `backend/src/routes/metrics.ts`            | **New.** `GET /v1/metrics/summary` with admin auth, query validation, summary response.              |
| `backend/src/schemas/metrics.ts`           | **New.** Zod schemas for summary query (`from`, `to`, `propertyId`, `compareTo`).                    |
| `backend/src/services/metrics/rollups.ts`  | **New.** Daily rollup generation: query raw tables, upsert per day+property, idempotent.             |
| `backend/src/services/metrics/summary.ts`  | **New.** Read rollups for window, compute derived ratios, format response contract.                  |
| `backend/src/scripts/rollups-backfill.ts`  | **New.** CLI: accept `--from`, `--to`, `--property-id`; call rollup service for each day.            |
| `backend/src/app.ts`                       | Register `metricsRoutes`.                                                                            |
| `backend/Makefile`                         | Add `rollups-run`, `rollups-backfill`, `rollups-status` targets.                                     |
| `backend/test/integration/metrics.test.ts` | **New.** Endpoint auth + response contract tests.                                                    |
| `backend/test/integration/rollups.test.ts` | **New.** Rollup idempotency and date-window recompute tests.                                         |

## Summary Response Contract

```jsonc
{
  "ok": true,
  "window": { "from": "2026-01-14", "to": "2026-02-13" },
  "compareTo": { "from": "2025-12-15", "to": "2026-01-13" }, // null if not requested
  "freshness": {
    "rolledUpThrough": "2026-02-12",
    "lagDays": 1,
    "generatedAt": "2026-02-13T04:00:00Z",
  },
  "metrics": {
    "uniqueVisitors": { "value": 1420, "delta": 0.12 },
    "returningVisitorsPct": { "value": 0.34, "delta": -0.02 },
    "totalPageViews": { "value": 5800, "delta": 0.08 },
    "leadCaptureRate": { "value": 0.023, "delta": 0.005 },
    "formCompletionRate": { "value": 0.41, "delta": 0.03 },
    "landingPageConversionRate": { "value": 0.06, "delta": 0.01 },
    "avgTimeToFirstCaptureHrs": { "value": 18.5, "delta": -2.1 },
    "trafficSourceMix": {
      "direct": 0.45,
      "organic_search": 0.25,
      "social": 0.15,
      "referral": 0.1,
      "paid_search": 0.03,
      "email": 0.02,
    },
  },
  "ingest": {
    "successPct": 0.997,
    "p95TtfbMs": 42,
    "totalEventsAccepted": 5800,
    "totalEventsRejected": 18,
  },
  "trend": [
    {
      "day": "2026-02-07",
      "uniqueVisitors": 190,
      "pageViews": 780,
      "newLeads": 4,
    },
    // ... one entry per day in window
  ],
}
```

`compareTo` semantics: when provided, the API computes the same metrics for the comparison window and returns `delta` as `(current - comparison) / comparison` (percentage change). When omitted, `delta` fields are `null`.

## Related Files

| File                                                                          | Note                                                                    |
| ----------------------------------------------------------------------------- | ----------------------------------------------------------------------- |
| `agentic/roadmaps/backend-marketing-server-roadmap.md`                        | Source of Phase 2 scope and acceptance criteria (§7, §8, §11, §12).     |
| `agentic/tasks/backend-tasks/0.1.backend-phase-0-1-foundation-and-capture.md` | Prior slice that delivered ingestion, identity, consent baseline.       |
| `agentic/tasks/backend-tasks/0.1.1.phase-0-1-code-review.md`                  | Code review findings — prerequisites G3, G4, B3, auth extraction.       |
| `agentic/instructions/05-backend-service-rules.md`                            | Auth and API behavior constraints for internal/admin routes.            |
| `agentic/instructions/language-standards.md`                               | Shared TS standards (no redundant casts, no serial independent awaits). |

---

# Consolidated Checklist

## Completed (Phase 0-1 + Code Review Fixes)

- [x] Phase 0-1 backend capture/identity baseline implemented.
- [x] Consent/unsubscribe workflow and consent audit log operational.
- [x] Backend-side no-JS form capture fallback (303 redirect for form-encoded).
- [x] Central Zod error handler in `app.ts` (code review A1).
- [x] CORS configured via `@fastify/cors` (code review A4 / G1).
- [x] Admin auth on `POST /v1/leads/delete` with `ADMIN_API_KEY` (code review A5).
- [x] Shared UTM schema extracted to `schemas/shared.ts` (code review A2).
- [x] `deleteLeadByEmail` scrubs form submission `payload` before cascade (code review B1).

## Phase 0: Prerequisites and Rollup Scaffolding

- [x] Extract `hasValidAdminKey` + `assertAdminRequest` to `lib/admin-auth.ts`; update `routes/leads.ts` to import.
- [x] Fix G3: backfill previous session `endedAt` in visitor service when new session starts on inactivity timeout.
- [x] Fix G4: extend `purge-retention.ts` to delete orphaned sessions (no events) and visitors (no sessions).
- [x] Add `DailyMetricRollup` and `DailyIngestRollup` models to Prisma schema.
- [x] Consolidate prerelease schema into a single `init` migration containing rollup indexes.
- [x] Add `ROLLUP_BATCH_DAYS` and `ROLLUP_DEFAULT_PROPERTY_ID` to env config.
- [x] Add script stubs and Make targets for `rollups-run`, `rollups-backfill`, `rollups-status`.

## Phase 1: Daily Rollup Generation

- [x] Implement daily KPI derivation from `web_traffic_logs`, `events`, `sessions`, `leads`, and `form_submissions`.
- [x] Compute all 7 roadmap §8 MVP traffic/funnel metrics per UTC day per property.
- [x] Compute ingest reliability aggregates (success %, rejection count, p95 TTFB approximation).
- [x] Store traffic source breakdown and top landing paths as JSON columns.
- [x] Ensure rollup upsert is idempotent — re-running for the same day+property overwrites with fresh values.
- [x] Add property-aware aggregation; default to `"default"` for single-property installs.

## Phase 2: Metrics Summary API

- [x] Add `schemas/metrics.ts` with Zod query validation for `from`, `to`, `propertyId`, optional `compareTo`.
- [x] Implement `GET /v1/metrics/summary` reusing `assertAdminRequest` from `lib/admin-auth.ts`.
- [x] Return all MVP metrics with `value` and `delta` (null when `compareTo` absent).
- [x] Return daily `trend` array for sparkline/chart rendering.
- [x] Return `trafficSourceMix` as proportional breakdown.
- [x] Include `freshness` metadata (`rolledUpThrough`, `lagDays`, `generatedAt`).
- [x] Include `ingest` reliability summary.
- [x] Register `metricsRoutes` in `app.ts`.

## Phase 3: Tests

- [x] Unit tests for metric formulas and edge cases (empty windows, single-day, timezone boundaries).
- [x] Integration tests for endpoint auth (missing key, wrong key, valid key, unconfigured key).
- [x] Integration tests for response contract shape stability.
- [x] Database tests for rollup upsert idempotency and backfill correctness across day ranges.
- [x] Performance smoke check for 30-day summary latency on local seeded dataset.

## Stretch Goals

- [x] Add materialized-view option for heavy aggregations.
- [x] Add lightweight in-memory caching for hot summary windows.
- [x] Add discrepancy monitor comparing raw-event counts vs rollup totals.
- [x] Add event dedup index to `events` table (code review G5) to improve rollup accuracy.
- [x] Fix B3: pass upsert result directly in `captureLead` instead of re-reading consent status.
- [x] Fix A3: cache HMAC key material to avoid per-call `createHmac` overhead.
- [x] Batch heuristic link creation with `Promise.all` (code review E1).

## Success Criteria

- [x] `GET /v1/metrics/summary` returns dashboard-ready MVP metrics for 7/30/90-day windows.
- [x] Re-running rollups for the same date range yields deterministic, identical values.
- [x] Metrics endpoint is protected by `ADMIN_API_KEY` and not publicly accessible.
- [x] `compareTo` windows produce correct period-over-period `delta` values.
- [x] Freshness metadata accurately reflects rollup lag.
- [x] All code review prerequisites (G3, G4, auth extraction) resolved before rollup generation.
- [x] Roadmap acceptance checklist item "Dashboard summary endpoint returns MVP metrics" can be marked complete.
- [x] Phase 2.1 code review findings (B1/B2/B3, A1/A2/A3) are resolved and re-verified.

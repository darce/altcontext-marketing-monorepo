# 0.8.2.1 PG18 Upgrade Review Findings

> **Status:** F1, F2, F3, F5 implemented ✅ · F4 PG18 runtime verification pending.

> Full-checklist code review of all uncommitted PG18 upgrade changes.
> Reviewed against the 21-pattern [code review checklist](../../instructions/backend/code-review-checklist.md)
> (patterns #1–#15 original + #16–#21 added for PG18 scope).
>
> Pre-requisites: PG18 migration task implemented (0.8.2).

## Applicable Instruction Files

Standard backend files per the [routing table](../../instructions.md#backend-tasks).

| File | Load when… |
|------|------------|
| [`backend/service-rules.md`](../../instructions/backend/service-rules.md) | Service and migration changes |
| [`backend/verification.md`](../../instructions/backend/verification.md) | Gate and manual verification rules |
| [`backend/code-review-checklist.md`](../../instructions/backend/code-review-checklist.md) | Defect pattern reference (21 patterns) |

## Verification Environment Used For This Review

- Local DB engine: PostgreSQL **17.7** (`server_version_num = 170007`)
- Because local is PG17, PG18-only behavior is called out explicitly as pending where applicable.

## Full Checklist Sweep (21 Patterns)

| # | Pattern | Verdict | Notes |
|---|---------|---------|-------|
| 1 | Stale Agent Comments | ✅ Clean | No narration-style comments in diff |
| 2 | Config Mismatches (Dockerfile ↔ fly.toml) | ✅ Clean | `docker-compose.oci.yml` → `postgres:18-alpine` |
| 3 | Documentation Drift | ✅ Clean | Checklist, verification.md updated |
| 4 | Semantic Naming Errors | ✅ Clean | No new columns |
| 5 | Hardcoded Metric Stubs | ✅ Clean | No metric logic changes |
| 6 | Incorrect Percentile Aggregation | N/A | Not touched |
| 7 | Duplicated Logic | ✅ Clean | Schema resolution centralized in `database-schema.ts` |
| 8 | Missing Access Control | N/A | No new endpoints |
| 9 | Transaction Re-reads | ✅ Clean | `seed-baseline.ts` now uses `RETURNING id` |
| 10 | Orphaned PII | N/A | Not touched |
| 11 | SQL Composition Type Inconsistency | ✅ Clean | No sql helper changes |
| 12 | pg Driver JSONB Serialization | N/A | No JSONB changes |
| 13 | Raw SQL Column Drift | ✅ Clean | `email_domain` removed from INSERT/UPDATE, `@ignore` in schema |
| 14 | Schema-Coupled Test Mocks | ✅ Fixed | `consent.test.ts` decoupled (F5) |
| 15 | Stale Task Checklists | ✅ | 0.8.2 task items checked off |
| 16 | Version-Gated SQL Feature Assumptions | ✅ Clean | VIRTUAL/STORED gate, uuidv7 shim, parameter ACL gate all correct; PG17 env stated |
| 17 | Prisma Default Semantics Drift | ⚠️ F2 | Documented as intentional drift; decision recorded |
| 18 | Scope-Leaky "Remaining Usage" Claims | ✅ Clean | F3 properly scoped to `src/` vs `test/` |
| 19 | Split Schema Resolution Sources | ⚠️ Minor | See note below |
| 20 | Destructive Test Target Collisions | ✅ Clean | `altcontext_test` ≠ `altcontext_dev`; separate `db-create-test` target |
| 21 | SECURITY DEFINER Privilege / Search Path | ✅ Clean | REVOKE PUBLIC, GRANT app_user, `SET search_path = pg_catalog`, `format('%I', ...)` |

**#19 note:** Three `resolveDatabaseSchema()` call sites exist: `db.ts`, `sql.ts`, `materialized-view.ts`.
The `sql.ts` duplication is architecturally required (import cycle with `db.ts`).
`materialized-view.ts` could import the already-resolved `databaseSchema` from `db.ts` (it already imports `query`/`sql` from there).
Not a correctness bug — `resolveDatabaseSchema` has conflict detection — but a minor DRY improvement.

---

## Findings

### F1 — Phase 3 SQL example is invalid as written (Checklist #16)

**Severity:** Bug (task-design SQL example)
**Files:** `agentic/tasks/backend-tasks/0.8.2.pg18-upgrade-migration.md` (Phase 3), `backend/src/services/leads.ts:106`

The task example uses:

```sql
INSERT ... ON CONFLICT ... DO UPDATE ... RETURNING old.id IS NULL AS is_new
```

This expression is invalid in the tested syntax path; probe result:

- `ERROR: missing FROM-clause entry for table "old"` when run against `INSERT ... ON CONFLICT ... RETURNING old.id...` on PG17.
- Current implementation uses `("xmax" = 0) AS is_new`, which is valid and passing tests.

**Recommended action:** Keep `xmax` approach for now and mark Phase 3 SQL snippet as invalid/out-of-scope unless a tested PG18 `MERGE` rewrite is intentionally adopted.

- [x] Update 0.8.2 task text so Phase 3 does not prescribe invalid SQL.

---

### F2 — Prisma default drift is real, but root-cause wording was incorrect (Checklist #17)

**Severity:** Medium (schema maintenance risk)
**Files:** `backend/prisma/schema.prisma`, `backend/prisma/migrations/20260217133000_pg18_upgrade/migration.sql`

Drift is confirmed via:

```sh
cd backend && DATABASE_URL=... npx prisma migrate diff --from-config-datasource --to-schema prisma/schema.prisma --exit-code
```

Diff output shows `id` defaults as DB-generated `uuidv7()` in DB vs `None` in Prisma datamodel comparison for affected tables.

Correction to prior wording: `@default(uuid())` here should not be described as "maps to `gen_random_uuid()`" in this codebase context; the issue is Prisma/schema-vs-DB default mismatch after raw SQL default changes.

**Recommended action:** Resolve explicitly as one of:
1. Use DB-generated defaults in Prisma schema (and validate Prisma create paths).
2. Keep client-side/default-agnostic Prisma model behavior, but document intentional drift and avoid schema-drift-generated corrective migrations for these defaults.

- [x] Decide/document default strategy (DB-generated parity vs intentional Prisma drift).
- [x] Record the decision in 0.8.2 task notes to prevent future revert churn.

---

### F3 — `randomUUID()` finding needed scope correction (Checklist #18)

**Severity:** Low (finding accuracy)
**File:** `backend/test/helpers/seed-baseline.ts`

The previous statement "only remaining `randomUUID` import in repo" was inaccurate. `randomUUID()` appears across multiple test files by design.

Accurate scoped statement:
- Runtime/service layer (`backend/src`) no longer uses `randomUUID()` for row IDs.
- `backend/test/helpers/seed-baseline.ts` still injects explicit UUIDv4 IDs, making seeded data less representative of DB-generated UUIDv7 behavior.

**Recommended action:** Keep the seed helper recommendation, but scope it as a test-helper representativeness improvement, not a global "last usage" cleanup.

- [x] Refactor `seed-baseline.ts` to omit explicit `id` values and use DB defaults + `RETURNING id`.

---

### F4 — Parameter ACL verification must be environment-scoped (Checklist #16)

**Severity:** Low (verification gap)
**Files:** `backend/prisma/migrations/20260217133000_pg18_upgrade/migration.sql`, `backend/src/lib/db.ts`

Migration behavior is version-gated:
- `REVOKE ALL ON PARAMETER "app.current_tenant_id" FROM app_user` runs only when `server_version_num >= 180000`.

In current local PG17, direct call succeeds (expected):

```sql
SET ROLE app_user;
SELECT set_config('app.current_tenant_id', '...', true);
```

So the open issue is not "REVOKE silently no-ops" in this environment; it is that PG18 ACL enforcement is not yet directly verified in a PG18 runtime.

**Recommended action:** Add PG18-targeted verification/test coverage rather than speculative behavior claims.

- [ ] In a PG18 environment, verify `app_user` cannot call `set_config('app.current_tenant_id', ...)` directly.
- [x] Add integration coverage gated by server version (or run only in PG18 CI profile).

---

### F5 — Schema-coupled unit test matcher remains a valid pre-existing finding (Checklist #14)

**Severity:** Low (test resilience)
**File:** `backend/test/unit/consent.test.ts:74`, `backend/test/unit/consent.test.ts:123`

Two checks still use coupled pattern matching:

- `text.includes('INSERT INTO "consent_events"')`

This is brittle if schema qualification changes SQL text shape.

**Recommended action:** Use decoupled checks (`includes("INSERT INTO") && includes('"consent_events"')`).

- [x] Update both matcher sites in `consent.test.ts`.

---

## Consolidated Checklist

### Findings to resolve

- [x] **F1:** Correct Phase 3 SQL guidance in 0.8.2 task doc.
- [x] **F2:** Decide and document Prisma default strategy for uuidv7 defaults.
- [x] **F3:** Update `seed-baseline.ts` to DB-generated IDs.
- [ ] **F4:** Run/automate PG18 parameter ACL verification.
- [x] **F5:** Decouple brittle SQL matcher patterns in `consent.test.ts`.

### Gates

- [x] `make -C backend audit` passes after applied fixes.
- [x] `make -C backend test` passes after applied fixes.

## PG18 Migration Correctness Summary

| Concern | Status |
|---------|--------|
| uuidv7 shim (`to_regprocedure` guard, `gen_random_uuid` fallback on PG17) | ✅ Correct |
| uuidv7 defaults (`::text` cast on text-type id columns, no cast on uuid columns) | ✅ Correct |
| Composite index rebuilds (tenant_id leading, old standalone indexes dropped) | ✅ Correct |
| Virtual column gate (VIRTUAL on PG18, STORED on PG17) | ✅ Correct |
| `set_tenant_context` (SECURITY DEFINER, pinned search_path, `%I` quoting, tenant validation) | ✅ Correct |
| Parameter ACL (`REVOKE ON PARAMETER` gated on `>= 180000`) | ⏳ F4 pending PG18 runtime verification |
| `randomUUID()` removed from all `src/` service code | ✅ Verified (zero grep hits) |
| No `@prisma/client` imports in `src/` | ✅ Verified (zero grep hits) |
| Test isolation (`altcontext_test` ≠ `altcontext_dev`) | ✅ Correct |

## Success Criteria

- [x] Findings contain only environment-verified or explicitly scoped (PG18-pending) claims.
- [x] No scope-leaky grep claims ("only remaining usage") without explicit path scope.
- [x] Prisma default strategy is documented to prevent drift churn.
- [x] All 21 checklist patterns reviewed against uncommitted diff.
- [x] PG18 migration correctness verified (except F4 parameter ACL — requires PG18 runtime).

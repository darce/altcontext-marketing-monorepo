# Backend Phase 2B: Consolidate WebTrafficLog into Event (Greenfield) — ✅ CLOSED

> **Status**: All phases complete. Verified in codebase — zero `WebTrafficLog` / `web_traffic_log` references remain in `backend/src/` or `prisma/schema.prisma`. Promoted analytics columns live on `Event`. Canonical init migration regenerated. Completed before commit `5f68464`.

## Problem Statement

`WebTrafficLog` duplicates analytics data already represented by `Event`, `Session`, and `Visitor`, increasing write-path complexity and query surface area. For this greenfield project, we consolidate analytics fields onto `Event`, remove `WebTrafficLog`, and keep one canonical init schema with no data backfill/migration logic.

## Workflow Principles

- **Greenfield-first**: no row-level data migration/backfill SQL — the schema must be correct from the start.
- **Keep ingest non-blocking**: Phase 2 dashboard contracts (`GET /v1/metrics/summary`) must remain stable.
- **JSONB TTFB extraction**: after promotion, use `(e."props"->>'ttfbMs')::int` with `PERCENTILE_CONT(0.95)` over raw rows — do not average per-bucket percentiles.

## Terminology

- **WTL**: `WebTrafficLog`, the table being removed.
- **Promoted event fields**: seven analytics dimensions moved onto `Event`: `property_id`, `traffic_source`, `device_type`, `country_code`, `is_entrance`, `is_exit`, `is_conversion`.
- **JSONB props**: CWV metrics (`fcpMs`, `lcpMs`, `inpMs`, `ttfbMs`, `clsScore`) and engagement metrics (`engagedTimeMs`, `scrollDepthPercent`) stored in `Event.props` — not typed columns.
- **Canonical init migration**: single `backend/prisma/migrations/20260213214500_init/migration.sql` representing the full greenfield schema.

## Current State Analysis

- Phase 2 rollups and metrics endpoint are complete and verified.
- `WebTrafficLog` model lives at `schema.prisma` L120-178 (42 columns, 7 indexes).
- WTL relation fields on `Visitor` (L62), `Session` (L88), `Event` (L108).
- `ingestEvent` in `events.ts` builds `WebTrafficLogCreateInput` (L301) and calls `tx.webTrafficLog.create` (L349).
- `resolveTrafficSource` (L129) and `resolveDeviceType` (L183) already compute promoted values — they just write to WTL instead of Event.
- Rollup queries reference `web_traffic_logs` at 8 sites in `rollups.ts` (L82, L127, L139, L151, L163, L180, L236, L247, L279).
- Discrepancy queries reference `web_traffic_logs` in `rollups-discrepancy.ts` (L39, L88, L120).
- Purge script uses WTL relation for orphan detection in `purge-retention.ts` (L23, L33).
- Zod `trafficSchema` in `schemas/events.ts` carries 26 fields; only 9 will be persisted post-consolidation.

## Proposed Solution

1. Add seven promoted analytics columns plus two new indexes to `Event` in Prisma schema.
2. Remove the `WebTrafficLog` model and its three foreign-key relation fields.
3. Rewrite `ingestEvent` raw SQL INSERT to include promoted columns; pack CWV + engagement into `props`.
4. Rewrite all eight rollup queries + two discrepancy queries from `web_traffic_logs` to `events`.
5. Simplify purge script orphan detection (remove WTL relation checks).
6. Prune `trafficSchema` Zod to only validated/persisted fields (9 of 26).
7. Regenerate the single canonical init migration from the consolidated schema — no backfill SQL.

## Patterns to Follow

### Target `Event` Model (Prisma)

```prisma
model Event {
  id            String        @id @default(uuid())
  visitorId     String        @map("visitor_id")
  sessionId     String?       @map("session_id")
  dedupeKey     String?       @unique @db.VarChar(64) @map("dedupe_key")
  eventType     String        @db.VarChar(64) @map("event_type")
  path          String?       @db.Text
  timestamp     DateTime      @default(now())
  ipHash        String?       @db.VarChar(128) @map("ip_hash")
  uaHash        String?       @db.VarChar(128) @map("ua_hash")
  props         Json?

  // ── Promoted from WebTrafficLog ──
  propertyId    String        @default("default") @db.VarChar(128) @map("property_id")
  trafficSource TrafficSource @default(unknown) @map("traffic_source")
  deviceType    DeviceType    @default(unknown) @map("device_type")
  countryCode   String?       @db.VarChar(2) @map("country_code")
  isEntrance    Boolean       @default(false) @map("is_entrance")
  isExit        Boolean       @default(false) @map("is_exit")
  isConversion  Boolean       @default(false) @map("is_conversion")

  createdAt     DateTime      @default(now()) @map("created_at")

  visitor Visitor  @relation(fields: [visitorId], references: [id], onDelete: Cascade)
  session Session? @relation(fields: [sessionId], references: [id], onDelete: SetNull)

  @@index([visitorId, timestamp], map: "events_visitor_id_timestamp_idx")
  @@index([eventType, timestamp], map: "events_event_type_timestamp_idx")
  @@index([path, timestamp], map: "events_path_timestamp_idx")
  @@index([sessionId, timestamp], map: "events_session_id_timestamp_idx")
  @@index([propertyId, timestamp], map: "events_property_id_timestamp_idx")
  @@index([trafficSource, timestamp], map: "events_traffic_source_timestamp_idx")
  @@map("events")
}
```

**Removed**: `WebTrafficLog` model (L120-178), `webTrafficLog WebTrafficLog?` on `Event` (L108), `webTrafficLogs WebTrafficLog[]` on `Visitor` (L62) and `Session` (L88).

### Rewritten Ingest raw SQL INSERT (`events.ts`)

Replace the current INSERT (L250-280) to include promoted columns. CWV and engagement metrics go into `props` JSONB.

```typescript
// Build enriched props: merge user-supplied props with CWV + engagement
const enrichedProps = {
  ...body.props,
  ...(webVitals?.fcpMs != null && { fcpMs: webVitals.fcpMs }),
  ...(webVitals?.lcpMs != null && { lcpMs: webVitals.lcpMs }),
  ...(webVitals?.inpMs != null && { inpMs: webVitals.inpMs }),
  ...(webVitals?.ttfbMs != null && { ttfbMs: webVitals.ttfbMs }),
  ...(webVitals?.clsScore != null && { clsScore: webVitals.clsScore }),
  ...(body.traffic?.engagedTimeMs != null && { engagedTimeMs: body.traffic.engagedTimeMs }),
  ...(body.traffic?.scrollDepthPercent != null && { scrollDepthPercent: body.traffic.scrollDepthPercent }),
};
const serializedProps =
  Object.keys(enrichedProps).length > 0 ? JSON.stringify(enrichedProps) : serializedEventProps;

const trafficSource = resolveTrafficSource(body, referrerHost, requestHost);
const deviceType = resolveDeviceType(body.traffic?.deviceType, context.userAgent);
const propertyId = normalizeOptional(body.traffic?.propertyId) ?? trafficHost;
const countryCode = normalizeOptional(body.traffic?.countryCode)?.toUpperCase() ?? null;
const isEntrance = body.traffic?.isEntrance ?? body.eventType === "page_view";
const isExit = body.traffic?.isExit ?? false;
const isConversion = body.traffic?.isConversion ?? body.eventType === "form_submit";

const insertedRows = await tx.$queryRaw<Array<EventRecord>>`
  INSERT INTO ${EVENTS_TABLE} (
    "id", "visitor_id", "session_id", "dedupe_key",
    "event_type", "path", "timestamp",
    "ip_hash", "ua_hash", "props",
    "property_id", "traffic_source", "device_type",
    "country_code", "is_entrance", "is_exit", "is_conversion"
  )
  VALUES (
    ${eventId}, ${visitor.id}, ${session.id}, ${dedupeKey},
    ${body.eventType}, ${body.path}, ${occurredAt},
    ${context.ipHash}, ${context.uaHash}, ${serializedProps}::jsonb,
    ${propertyId}, ${trafficSource}::"TrafficSource", ${deviceType}::"DeviceType",
    ${countryCode}, ${isEntrance}, ${isExit}, ${isConversion}
  )
  ON CONFLICT ("dedupe_key") DO NOTHING
  RETURNING "id", "visitor_id" AS "visitorId", "session_id" AS "sessionId"
`;
```

**Delete**: the entire `trafficLogData` block (L301-347) and `tx.webTrafficLog.create` call (L349). Remove the `Prisma.WebTrafficLogCreateInput` type usage.

### Rewritten Rollup Queries (`rollups.ts`)

All queries switch from `web_traffic_logs w` to `events e`. Property filter becomes a direct `WHERE` clause instead of a subquery `EXISTS`.

```sql
-- Traffic totals (replaces L180 query)
SELECT
  COUNT(DISTINCT e."visitor_id")::int AS unique_visitors,
  COUNT(DISTINCT e."visitor_id") FILTER (WHERE v."first_seen_at" < $dayStart)::int AS returning_visitors,
  COUNT(*) FILTER (WHERE e."event_type" = 'page_view')::int AS total_page_views,
  COUNT(*) FILTER (WHERE e."is_entrance")::int AS total_entrances,
  COUNT(*) FILTER (WHERE e."is_exit")::int AS total_exits,
  COUNT(*) FILTER (WHERE e."is_conversion")::int AS total_conversions
FROM "events" e
INNER JOIN "visitors" v ON v."id" = e."visitor_id"
WHERE e."property_id" = $propertyId
  AND e."timestamp" >= $dayStart
  AND e."timestamp" < $dayEnd
```

```sql
-- Traffic source breakdown (replaces L236 query)
SELECT e."traffic_source"::text AS source, COUNT(*)::int AS count
FROM "events" e
WHERE e."property_id" = $propertyId
  AND e."timestamp" >= $dayStart AND e."timestamp" < $dayEnd
GROUP BY e."traffic_source"
```

```sql
-- p95 TTFB from JSONB props (replaces L279 query)
SELECT
  ROUND(PERCENTILE_CONT(0.95) WITHIN GROUP (
    ORDER BY (e."props"->>'ttfbMs')::int
  ))::int AS p95_ttfb_ms
FROM "events" e
WHERE e."property_id" = $propertyId
  AND e."timestamp" >= $dayStart AND e."timestamp" < $dayEnd
  AND e."props"->>'ttfbMs' IS NOT NULL
```

**Property filter change** (L127, L139, L151, L163): replace `EXISTS (SELECT 1 FROM web_traffic_logs w WHERE w."event_id" = e."id" AND w."property_id" = $propertyId)` with direct `AND e."property_id" = $propertyId`. Eliminates the subquery.

**Delete**: `const WEB_TRAFFIC_LOGS_TABLE = tableRef("web_traffic_logs")` at L82.

### Pruned Zod `trafficSchema` (`schemas/events.ts`)

Keep only fields that are persisted (promoted columns, CWV, engagement). Remove 16 marginal fields.

```typescript
const trafficSchema = z
  .object({
    propertyId: z.string().trim().min(1).max(128).optional(),
    deviceType: z.enum(["desktop", "mobile", "tablet", "bot", "unknown"]).optional(),
    countryCode: z.string().trim().length(2).toUpperCase().optional(),
    isEntrance: z.boolean().optional(),
    isExit: z.boolean().optional(),
    isConversion: z.boolean().optional(),
    engagedTimeMs: z.coerce.number().int().min(0).max(86_400_000).optional(),
    scrollDepthPercent: z.coerce.number().int().min(0).max(100).optional(),
    webVitals: webVitalsSchema,
  })
  .optional();
```

**Removed fields**: `host`, `pageTitle`, `language`, `browserName`, `browserVersion`, `osName`, `osVersion`, `region`, `city`, `timezone`, `screenWidth`, `screenHeight`, `viewportWidth`, `viewportHeight`.

### Purge Script Cleanup (`purge-retention.ts`)

Remove `webTrafficLogs: { none: {} }` from both orphan queries (L23, L33).

```typescript
// Orphan sessions — delete this line:
      webTrafficLogs: { none: {} },

// Orphan visitors — delete this line:
      webTrafficLogs: { none: {} },
```

## Functions to Change

| File | Line(s) | Change |
|------|---------|--------|
| `backend/prisma/schema.prisma` | 62 | Remove `webTrafficLogs WebTrafficLog[]` from `Visitor` |
| `backend/prisma/schema.prisma` | 88 | Remove `webTrafficLogs WebTrafficLog[]` from `Session` |
| `backend/prisma/schema.prisma` | 98-117 | Add 7 promoted columns + 2 new indexes to `Event`; remove `webTrafficLog WebTrafficLog?` relation (L108) |
| `backend/prisma/schema.prisma` | 120-178 | Delete entire `WebTrafficLog` model |
| `backend/prisma/migrations/…/migration.sql` | — | Regenerate canonical init migration from consolidated schema (`make -C backend db-reset`) |
| `backend/src/schemas/events.ts` | 15-40 | Prune `trafficSchema` to 9 fields (was 26) |
| `backend/src/services/events.ts` | 250-280 | Rewrite raw SQL INSERT to include promoted columns + enriched JSONB props |
| `backend/src/services/events.ts` | 296-300 | Move `referrer`/`referrerHost`/`requestHost`/`trafficHost`/`webVitals` extraction above the INSERT |
| `backend/src/services/events.ts` | 301-349 | Delete `trafficLogData` block + `tx.webTrafficLog.create` call |
| `backend/src/services/metrics/rollups.ts` | 82 | Delete `WEB_TRAFFIC_LOGS_TABLE` const |
| `backend/src/services/metrics/rollups.ts` | 127 | Replace WTL property-filter subquery with direct `e."property_id"` clause |
| `backend/src/services/metrics/rollups.ts` | 139 | Replace WTL JOIN in lead property filter with `events`-based filter |
| `backend/src/services/metrics/rollups.ts` | 151 | Replace WTL lead-visitor property filter |
| `backend/src/services/metrics/rollups.ts` | 163 | Replace WTL submission property filter |
| `backend/src/services/metrics/rollups.ts` | 180 | Rewrite traffic totals query from `web_traffic_logs` to `events` |
| `backend/src/services/metrics/rollups.ts` | 236 | Rewrite traffic source breakdown from `web_traffic_logs` to `events` |
| `backend/src/services/metrics/rollups.ts` | 247 | Rewrite landing paths query from `web_traffic_logs` to `events` |
| `backend/src/services/metrics/rollups.ts` | 279 | Rewrite p95 TTFB from `w."ttfb_ms"` to `(e."props"->>'ttfbMs')::int` |
| `backend/src/scripts/rollups-discrepancy.ts` | 39 | Delete `WEB_TRAFFIC_LOGS_TABLE` const |
| `backend/src/scripts/rollups-discrepancy.ts` | 88 | Replace WTL property-filter subquery with `e."property_id"` |
| `backend/src/scripts/rollups-discrepancy.ts` | 120 | Rewrite page-views raw query from `web_traffic_logs` to `events` |
| `backend/src/scripts/purge-retention.ts` | 23 | Remove `webTrafficLogs: { none: {} }` from orphan session query |
| `backend/src/scripts/purge-retention.ts` | 33 | Remove `webTrafficLogs: { none: {} }` from orphan visitor query |
| `backend/test/integration/rollups.test.ts` | — | Update seed helpers: create events with promoted columns instead of WTL rows |
| `backend/test/integration/routes.test.ts` | — | Assert promoted fields on Event rows; remove WTL assertions |

## Related Files

| File | Note |
|------|------|
| `agentic/roadmaps/epics/backend-marketing-server.md` | Source of Phase 2B scope and acceptance items (§11, §12). |
| `agentic/tasks/backend-tasks/0.2.backend-phase-2-dashboard-rollups-and-metrics.md` | Phase 2 baseline that must remain behaviorally intact. |
| `agentic/tasks/backend-tasks/0.2.2.phase-2-compliance-review.md` | Verification/compliance baseline to preserve. |
| `backend/src/routes/metrics.ts` | Summary endpoint contract — response shape must not regress. |
| `backend/src/routes/events.ts` | Event ingest route — calls `ingestEvent`, unchanged interface. |

## Agent Do / Don't (This Task)

### Do

- Use `make -C backend db-reset` to regenerate the canonical init migration.
- Verify `PERCENTILE_CONT(0.95)` operates on raw event rows after JSONB promotion.

### Do Not

- Leave `WebTrafficLogCreateInput` or `WEB_TRAFFIC_LOGS_TABLE` in dead code — remove fully.
- Add data backfill/transform SQL to the init migration.

## Manual Review Checklist

Per `backend/verification.md` § "Rules not yet enforced by tooling":

- [ ] Percentile correctness: `PERCENTILE_CONT(0.95)` of `(e."props"->>'ttfbMs')::int` is computed over raw rows for the day window, not averaged from sub-buckets.
- [ ] Metric columns populated from real data: all 7 promoted `Event` columns are populated from `resolveTrafficSource`, `resolveDeviceType`, and request body — no hardcoded stubs.
- [ ] Semantic naming: `trafficSource` (not `source`), `deviceType` (not `device`), `countryCode` (not `country`).
- [ ] No blind casts on untrusted data: JSONB extraction `(e."props"->>'ttfbMs')::int` is guarded by `IS NOT NULL` filter.
- [ ] Shared schemas not duplicated: `TrafficSource` and `DeviceType` enums remain in Prisma schema only; no local re-declarations.
- [ ] Write results used in transactions: `ingestEvent` uses the `RETURNING` result, not a re-query.

---

# Consolidated Checklist

## Completed

- [x] Phase 2 rollups + `/v1/metrics/summary` implemented and verified.
- [x] Phase 2.1 and 2.2 review findings resolved with passing audit/tests.

## Phase 0: Schema Scaffolding

- [ ] Add 7 promoted analytics columns to `Event` in `schema.prisma` (L98-117): `propertyId`, `trafficSource`, `deviceType`, `countryCode`, `isEntrance`, `isExit`, `isConversion`.
- [ ] Add 2 new compound indexes on `Event`: `(propertyId, timestamp)`, `(trafficSource, timestamp)`.
- [ ] Remove `webTrafficLog WebTrafficLog?` relation from `Event` (L108).
- [ ] Remove `webTrafficLogs WebTrafficLog[]` from `Visitor` (L62) and `Session` (L88).
- [ ] Delete entire `WebTrafficLog` model (L120-178) including all 7 indexes.
- [ ] Run `npx prisma generate` and confirm typecheck passes: `make -C backend check`.

## Phase 1: Ingest and Query Refactor

- [ ] Move `referrer`/`referrerHost`/`requestHost`/`trafficHost`/`webVitals` extraction above the raw SQL INSERT in `events.ts` (currently at L296-300).
- [ ] Rewrite the `INSERT INTO events` raw SQL (L250-280) to include all 7 promoted columns.
- [ ] Build enriched `props` JSONB: merge user `props` with CWV metrics (`fcpMs`, `lcpMs`, `inpMs`, `ttfbMs`, `clsScore`) and engagement metrics (`engagedTimeMs`, `scrollDepthPercent`).
- [ ] Delete `trafficLogData` block (L301-347) and `tx.webTrafficLog.create` call (L349).
- [ ] Remove `Prisma.WebTrafficLogCreateInput` type usage.
- [ ] Prune `trafficSchema` in `schemas/events.ts` (L15-40) to 9 persisted fields.
- [ ] Delete `WEB_TRAFFIC_LOGS_TABLE` const from `rollups.ts` (L82).
- [ ] Rewrite all 8 rollup queries (L127, L139, L151, L163, L180, L236, L247, L279) from `web_traffic_logs w` to `events e` with direct `property_id` filtering.
- [ ] Change 4 property-filter fragments (L127, L139, L151, L163) from `EXISTS (SELECT … FROM web_traffic_logs)` subqueries to direct `AND e."property_id" = $propertyId`.
- [ ] Rewrite p95 TTFB query (L279) to extract from JSONB: `(e."props"->>'ttfbMs')::int`.
- [ ] Delete `WEB_TRAFFIC_LOGS_TABLE` const from `rollups-discrepancy.ts` (L39).
- [ ] Rewrite WTL property-filter subquery in `rollups-discrepancy.ts` (L88) to direct `e."property_id"`.
- [ ] Rewrite page-views raw query in `rollups-discrepancy.ts` (L120) from `web_traffic_logs` to `events`.
- [ ] Remove `webTrafficLogs: { none: {} }` from orphan session query in `purge-retention.ts` (L23).
- [ ] Remove `webTrafficLogs: { none: {} }` from orphan visitor query in `purge-retention.ts` (L33).
- [ ] Run `make -C backend check` — all type and lint errors resolved.
- [ ] Run `make -C backend dead-exports` — no orphaned WTL-related exports.

## Phase 2: Greenfield Migration Consolidation

- [ ] Run `make -C backend db-reset` to regenerate `20260213214500_init` from consolidated schema.
- [ ] Inspect generated `migration.sql` — confirm `CREATE TABLE "events"` includes all 7 promoted columns, no `CREATE TABLE "web_traffic_logs"`, no `INSERT`/`UPDATE` backfill SQL.
- [ ] Confirm enums `TrafficSource` and `DeviceType` are still created (used by `Event`).
- [ ] Remove any leftover migration directories related to WTL if present.
- [ ] Run `make -C backend check` to verify migration + schema alignment.

## Phase 3: Tests and Verification

- [ ] Update test seed/fixture helpers: create `Event` rows with promoted columns instead of separate WTL rows.
- [ ] Update `rollups.test.ts` assertions to verify rollups read from `events`.
- [ ] Update `routes.test.ts` to assert promoted fields are persisted on `Event` and no WTL row is created.
- [ ] Run `make -C backend test` — full pass.
- [ ] Run `make -C backend audit` — full pass (check + dead-exports + duplicates).
- [ ] Re-run `rollups-discrepancy` script against a seeded test window — zero discrepancies.
- [ ] Complete Manual Review Checklist (above) — all 6 items verified.

## Stretch Goals

- [ ] Add a short benchmark note comparing rollup query latency before/after consolidation.
- [ ] Add a compact architecture decision record documenting why `WebTrafficLog` was removed.

## Success Criteria

- [ ] Zero references to `WebTrafficLog`, `web_traffic_logs`, or `WEB_TRAFFIC_LOGS_TABLE` in codebase (grep verification).
- [ ] `/v1/events` ingests analytics fields directly on `Event` rows.
- [ ] `GET /v1/metrics/summary` response contract unchanged — same JSON shape, same metric accuracy.
- [ ] `make -C backend audit` passes (typecheck + lint + format + dead-exports + duplicates).
- [ ] `make -C backend test` passes — all integration tests green.
- [ ] Canonical init migration (`20260213214500_init/migration.sql`) contains DDL only — no data migration SQL.
- [ ] `trafficSchema` Zod accepts only 9 persisted fields — no marginal fields validated.

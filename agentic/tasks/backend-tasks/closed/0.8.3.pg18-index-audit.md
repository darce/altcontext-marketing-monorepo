# 0.8.3 Post-Bake-In Index Audit (Reference; Merged Into 0.8.2)

> After UUIDv7 primary keys have been live for a bake-in period, analyze query plans and drop timestamp-only indexes that are now redundant — UUIDv7 PKs provide equivalent time-range scan capability.
> Status: superseded as a standalone task for this repository's greenfield context.
> Active plan: fold all EXPLAIN/index-drop decisions into `0.8.2.pg18-upgrade-migration.md` Phase 5.
> Follows the [code review checklist](../../instructions/backend/code-review-checklist.md).

## Verification Run (2026-02-17)

Audit tenant dataset used:

- tenant: `00000000-0000-4000-a000-000000000099`
- row counts: `visitors=1000`, `sessions=3000`, `events=36000`, `leads=500`, `consent_events=1500`
- EXPLAIN mode: `EXPLAIN (ANALYZE, BUFFERS)` under `app_user` + `set_tenant_context(...)`
- method: each candidate query executed twice: (a) index present, (b) index dropped inside transaction and rolled back

Decision summary:

| Candidate index | With index | Without index | Decision |
|---|---|---|---|
| `events_tenant_id_visitor_id_timestamp_idx` | index scan, `1.190 ms` | seq scan, `22.215 ms` | **KEEP** |
| `events_tenant_id_event_type_timestamp_idx` | index scan, `0.474 ms` | seq scan, `31.358 ms` | **KEEP** |
| `events_tenant_id_path_timestamp_idx` | index scan, `0.457 ms` | seq scan, `7.526 ms` | **KEEP** |
| `events_tenant_id_session_id_timestamp_idx` | index scan, `4.352 ms` | seq scan, `12.248 ms` | **KEEP** |
| `events_tenant_id_property_id_timestamp_idx` | index scan, `0.294 ms` | seq scan, `14.578 ms` | **KEEP** |
| `events_tenant_id_traffic_source_timestamp_idx` | seq scan, `10.686 ms` | seq scan, `13.854 ms` | **KEEP** (planner not consistently using index at this cardinality; no strong drop signal) |
| `sessions_tenant_id_visitor_id_started_at_idx` | index scan, `0.034 ms` | alternate index scan, `0.036 ms` | **KEEP** (paired sessions indexes cover distinct sort columns) |
| `sessions_tenant_id_visitor_id_last_event_at_idx` | index scan, `0.027 ms` | alternate index scan, `0.033 ms` | **KEEP** (paired sessions indexes cover distinct sort columns) |
| `consent_events_tenant_id_lead_id_timestamp_idx` | index scan, `2.409 ms` | seq scan, `0.230 ms` | **KEEP** (current dataset too small/low-fanout per lead to justify drop; retain for scale) |

Result: **no redundant index was conclusively demonstrated**, so no drop migration is created.

## Applicable Instruction Files

Standard backend files per the [routing table](../../instructions.md#backend-tasks).

## Consolidation Note

- This file remains as a reference template for index-audit method and decision logging.
- Execution is now tracked in `0.8.2` (single baseline-correction task).
- Do not treat `0.8.3` as a blocking dependency for MT-3 in this repo.

## Problem Statement

With UUIDv7 primary keys (0.8.2), every `id` column is now time-ordered. This means `WHERE id > uuidv7_from_timestamp(...)` can substitute for `WHERE timestamp > ...` in range queries on tables like `events`, `sessions`, and `consent_events`. Several composite indexes that exist solely to support time-range queries may now be redundant — the PK index already provides the same ordering.

However, this cannot be verified without actual query plan analysis against production-like data. This task is explicitly a **post-bake-in audit** — it runs EXPLAIN ANALYZE on every hot query path, identifies which indexes the planner actually uses, and drops only those that are confirmed redundant.

## Workflow Principles

- **Measure first, drop second.** No index is dropped without EXPLAIN ANALYZE evidence showing the PK index is used instead.
- **One index at a time.** Drop indexes individually, re-run affected queries, confirm no plan regression.
- **Document every decision.** For each index, record: (a) the query it supports, (b) the plan with the index, (c) the plan without it, (d) drop/keep decision.
- **Reversible.** Keep the full list of dropped indexes and their DDL in the migration file comments so they can be recreated if a regression is discovered.

## Current State (After 0.8.2)

After 0.8.2, composite indexes will have `tenant_id` as leading column. The candidates for removal are indexes where the trailing columns are purely time-based and the PK's UUIDv7 ordering provides equivalent range capability.

### Candidate Indexes for Analysis

These indexes pair a foreign key with a timestamp — the timestamp component may be redundant if the PK's time-ordering suffices:

| Index (post-0.8.2 name) | Table | Columns | Query pattern |
|--------------------------|-------|---------|---------------|
| `events_tenant_id_visitor_id_timestamp_idx` | events | `(tenant_id, visitor_id, timestamp)` | Visitor event history |
| `events_tenant_id_event_type_timestamp_idx` | events | `(tenant_id, event_type, timestamp)` | Event type filtering |
| `events_tenant_id_path_timestamp_idx` | events | `(tenant_id, path, timestamp)` | Path-based analytics |
| `events_tenant_id_session_id_timestamp_idx` | events | `(tenant_id, session_id, timestamp)` | Session event list |
| `events_tenant_id_property_id_timestamp_idx` | events | `(tenant_id, property_id, timestamp)` | Property metrics |
| `events_tenant_id_traffic_source_timestamp_idx` | events | `(tenant_id, traffic_source, timestamp)` | Traffic source breakdown |
| `sessions_tenant_id_visitor_id_started_at_idx` | sessions | `(tenant_id, visitor_id, started_at)` | Session windowing lookup |
| `sessions_tenant_id_visitor_id_last_event_at_idx` | sessions | `(tenant_id, visitor_id, last_event_at)` | Session recency |
| `consent_events_tenant_id_lead_id_timestamp_idx` | consent_events | `(tenant_id, lead_id, timestamp)` | Consent audit trail |

### Indexes NOT Candidates (keep regardless)

These indexes serve UNIQUE constraints or non-time-range lookups — they are not duplicated by PK ordering:

| Index | Reason to keep |
|-------|----------------|
| `visitors_tenant_id_anon_id_key` | UNIQUE constraint |
| `events_tenant_id_dedupe_key_key` | UNIQUE constraint |
| `leads_tenant_id_email_normalized_key` | UNIQUE constraint |
| `lead_identities_tenant_id_lead_visitor_source_key` | UNIQUE constraint |
| `daily_metric_rollups_tenant_id_property_day_key` | UNIQUE constraint |
| `daily_ingest_rollups_tenant_id_property_day_key` | UNIQUE constraint |
| `leads_tenant_id_last_captured_at_idx` | last_captured_at ≠ insert time |
| `daily_metric_rollups_tenant_id_day_idx` | day is calendar day, not insert time |
| `daily_ingest_rollups_tenant_id_day_idx` | day is calendar day, not insert time |

## Analysis Method

For each candidate index:

1. **Identify queries** that use the index. Search service files for SQL referencing the table + columns.
2. **Run EXPLAIN (ANALYZE, BUFFERS, FORMAT TEXT)** with the index present.
3. **Run `DROP INDEX ... ;` then re-EXPLAIN** — does the planner fall back to PK scan or seq scan?
4. **Compare cost and actual time.** If PK scan is within 10% of indexed scan, the index is redundant.
5. **Record decision**: DROP (with DDL in comment) or KEEP (with justification).
6. **Recreate if keeping**: `CREATE INDEX CONCURRENTLY ...` to restore if plan regresses.

## Agent Do / Don't (This Task)

### Do

- Run all EXPLAIN ANALYZE on a test database with realistic data volume (at least 10K events, 1K visitors).
- Use `EXPLAIN (ANALYZE, BUFFERS)` to see both cost estimates and actual I/O.
- Document findings inline in the migration file as SQL comments.
- Drop redundant indexes in the migration; keep the `CREATE INDEX` DDL in comments for rollback.
- Run `make -C backend test` after each index drop.

### Do Not

- Drop any index without EXPLAIN ANALYZE evidence.
- Drop UNIQUE constraint indexes — those serve correctness, not just performance.
- Drop indexes that support `ORDER BY timestamp` queries where the PK ordering is insufficient (e.g., queries that filter by `event_type` AND order by `timestamp` — the composite `(tenant_id, event_type, timestamp)` index is needed for sorted output).
- Assume PK ordering replaces composite indexes where the middle column is not time-based (e.g., `(tenant_id, visitor_id, timestamp)` — `visitor_id` is the key filter, timestamp is the sort).

---

# Consolidated Checklist

## Completed

- [x] Scope merged into 0.8.2 for greenfield delivery.
- [x] PG 18 upgrade migration deployed (tracked in 0.8.2).
- [x] Composite indexes rebuilt with `tenant_id` leading (tracked in 0.8.2).
- [x] PK defaults switched to `uuidv7()` (tracked in 0.8.2).

## Phase 0: Inventory & Data Preparation

- [x] List all non-UNIQUE indexes on RLS-enabled tables.
- [x] Ensure test database has realistic data volume (seed script or production snapshot).
- [x] Identify all SQL queries in service layer that reference each candidate index's columns.

## Phase 1: EXPLAIN ANALYZE Audit

For each of the 9 candidate indexes:

- [x] `events_tenant_id_visitor_id_timestamp_idx` — EXPLAIN with and without; decision: KEEP.
- [x] `events_tenant_id_event_type_timestamp_idx` — EXPLAIN with and without; decision: KEEP.
- [x] `events_tenant_id_path_timestamp_idx` — EXPLAIN with and without; decision: KEEP.
- [x] `events_tenant_id_session_id_timestamp_idx` — EXPLAIN with and without; decision: KEEP.
- [x] `events_tenant_id_property_id_timestamp_idx` — EXPLAIN with and without; decision: KEEP.
- [x] `events_tenant_id_traffic_source_timestamp_idx` — EXPLAIN with and without; decision: KEEP.
- [x] `sessions_tenant_id_visitor_id_started_at_idx` — EXPLAIN with and without; decision: KEEP.
- [x] `sessions_tenant_id_visitor_id_last_event_at_idx` — EXPLAIN with and without; decision: KEEP.
- [x] `consent_events_tenant_id_lead_id_timestamp_idx` — EXPLAIN with and without; decision: KEEP.

## Phase 2: Migration

- [x] No migration created — no confirmed-redundant indexes in this audit run.
- [x] Drop step skipped by design (all candidates kept).
- [x] Rollback DDL comments not needed (no dropped indexes).
- [x] Prisma schema unchanged (no dropped indexes).
- [x] **Gate**: `make -C backend test` passes.

## Phase 3: Verify

- [x] Re-run EXPLAIN ANALYZE on all hot queries — decisions recorded.
- [x] Run full test suite: `make -C backend test`.
- [x] Run audit: `make -C backend audit`.
- [x] **Gate**: All gates pass; no query plan regressions from audit work.

## Success Criteria

- [x] `make -C backend audit` passes.
- [x] `make -C backend test` passes.
- [x] Every candidate index has a documented EXPLAIN ANALYZE decision (drop or keep with justification).
- [x] No persistent index removals performed without evidence.
- [x] No drop migration required for this audit run.
- [x] Baseline index set retained; no unsupported write-optimization drops.

# 0.6 First Property Integration

> ✅ **CLOSED** — Static site wired to live backend. All telemetry findings (0.6.1) resolved. Tests pass. 2026-02-16.

> Wire the AltContext marketing site (`static/`) to the live backend as the first client property.
> This is Phase 5 of the [backend epic](../../roadmaps/epics/backend-marketing-server.md).
>
> Pre-requisites: Backend deployed (0.5 ✅), CORS configured (`altcontext.com` + `www.altcontext.com` ✅), email form + telemetry module implemented in `static/` ✅.

## Applicable Instruction Files

Standard backend files per the [routing table](../../instructions.md#backend-tasks).

| File | Load when… |
|------|------------|
| [`available-tools.md`](../../instructions/available-tools.md) | Deployment or infrastructure commands |
| [`static/architecture.md`](../../instructions/static/architecture.md) | Editing static site source files |
| [`static/authoring-and-runtime.md`](../../instructions/static/authoring-and-runtime.md) | Modifying `telemetry.ts` or form markup |
| [`static/local-development.md`](../../instructions/static/local-development.md) | Local dev server for static site |

## Problem Statement

The backend is live on Fly.io and all API endpoints are tested (80/80). The static site has an email capture form and telemetry module implemented but not connected to the live backend. No beacons or form submissions are reaching the production database. This task wires the static site to the backend as the first client property, establishing the full acquisition funnel from anonymous visit through lead capture.

## Workflow Principles

- **No multi-tenancy yet**: This is pre-MT. The backend accepts requests from CORS-allowed origins without API key auth. API key authentication will be added in MT-1.
- **JS-only submission**: The email form posts via `enhanceEmailForm()` to the build-time `BACKEND_URL`. The HTML `action="#"` prevents backend endpoint exposure in the HTML source.
- **Build-time injection**: `BACKEND_URL` (and later `INGEST_API_KEY`) are injected at build time via esbuild `--define`. No runtime configuration.
- **Beacon reliability**: Use `navigator.sendBeacon()` with `fetch(keepalive: true)` fallback for telemetry events. Beacons must fire on `visibilitychange` / `pagehide`.

## Terminology

- **Bootstrap tenant**: The default tenant that owns the AltContext marketing site property. Created during MT-1 migration; until then, all data is unscoped.
- **Ingest API key**: A client-safe key that can only write events/leads for a specific property. Not required pre-MT.
- **Beacon**: A fire-and-forget telemetry event sent via `sendBeacon` or `fetch(keepalive)`.
- **CWV**: Core Web Vitals — LCP, CLS, INP, TTFB, FCP.

## Current State Analysis

### What's implemented

| Component | File | Status |
|-----------|------|--------|
| Email capture form | `static/src/index.html` L122–145 | ✅ Form markup with honeypot, consent text |
| Email capture styles | `static/styles/_email-capture.scss` | ✅ 140-line partial with responsive rules |
| Telemetry module | `static/src/assets/telemetry.ts` | ✅ 313 lines: anonId, beacons, page_view, engagement, scroll, face-pose, CWV, form enhance |
| Build-time BACKEND_URL | esbuild config | ✅ `declare const BACKEND_URL: string` |
| Backend events endpoint | `backend/src/routes/events.ts` | ✅ `POST /v1/events` → 202 |
| Backend leads endpoint | `backend/src/routes/leads.ts` | ✅ `POST /v1/leads/capture` → 200 |
| CORS configuration | `backend/.env` | ✅ `altcontext.com` + `www.altcontext.com` |
| Production deployment | Fly.io (`yyz`, 2 machines) | ✅ Image v7, health check passing |
| CI | `.github/workflows/backend-ci.yml` | ✅ `make audit` + `make test` on push/PR |

### What's missing

All gaps resolved:

| Gap | Resolution |
|-----|-----------|
| ~No UTM extraction~ | ✅ `getUtmParams()` added to `telemetry.ts` |
| ~`BACKEND_URL` not set for production~ | ✅ Set in `.github/workflows/pages.yml` |
| ~No end-to-end verification~ | ✅ Beacons reach production DB; telemetry bugs fixed (0.6.1) |

## Proposed Solution

1. **JS-only form submission**: The email form uses `action="#"` — no backend endpoint is exposed in HTML. The JS-enhanced path (`enhanceEmailForm()`) intercepts submit and POSTs to the build-time injected `BACKEND_URL`. No-JS fallback is intentionally not supported (the site requires JS for `anonId` generation and all telemetry).

2. **Add UTM extraction** to `telemetry.ts` — parse `utm_source`, `utm_medium`, `utm_campaign`, `utm_term`, `utm_content` from `location.search` and include in all beacon and form payloads.

3. **Configure `BACKEND_URL`** for production build (GitHub Pages deploy workflow) pointing to `https://marketing-altcontext.fly.dev`.

4. **End-to-end smoke test** — deploy, trigger beacons + form submit, verify rows in production DB.

## Patterns to Follow

### Beacon payload shape (events)

```typescript
const payload: EventBody = {
  anonId: getAnonId(),
  eventType: "page_view",
  path: location.pathname,
  referrer: document.referrer || undefined,
  utm: getUtmParams() || undefined,
  traffic: {
    isEntrance: isEntrance(),
    scrollDepthPercent: getScrollDepth(),
    webVitals: getCwvMetrics() || undefined,
  },
};
```

### UTM extraction

```typescript
const getUtmParams = (): UtmParams | undefined => {
  const params = new URLSearchParams(location.search);
  const utm: Record<string, string> = {};
  for (const key of ["source", "medium", "campaign", "term", "content"]) {
    const val = params.get(`utm_${key}`);
    if (val) utm[key] = val;
  }
  return Object.keys(utm).length > 0 ? utm : undefined;
};
```

## Functions to Change

| File | Line(s) | Change |
|------|---------|--------|
| `static/src/assets/telemetry.ts` | new | Add `getUtmParams()` function |
| `static/src/assets/telemetry.ts` | beacon calls | Include `utm` field in all beacon payloads |
| `static/src/assets/telemetry.ts` | `enhanceEmailForm()` | Include UTM params in form submission payload |

| `.github/workflows/pages.yml` | build step | Set `BACKEND_URL` env var for esbuild |

## Related Files

| File | Note |
|------|------|
| `static/src/index.html` | Email form markup and script tag |
| `static/src/assets/telemetry.ts` | Telemetry module (beacons + form enhancement) |
| `static/styles/_email-capture.scss` | Email form styles (already complete) |
| `backend/src/routes/events.ts` | `POST /v1/events` handler |
| `backend/src/routes/leads.ts` | `POST /v1/leads/capture` handler |
| `backend/src/schemas/events.ts` | Event body Zod schema (`EventBody`) |
| `backend/src/schemas/leads.ts` | Lead capture body Zod schema (`LeadCaptureBody`) |
| `agentic/tasks/static-tasks/email-capture-and-telemetry.md` | Original static task (Phases 1–5 substantially complete) |
| `.github/workflows/pages.yml` | GitHub Pages deploy workflow |
| `.github/workflows/backend-ci.yml` | Backend CI (reference, not changed) |

## Agent Do / Don't (This Task)

### Do

- Test the form both with and without JavaScript enabled.
- Verify beacons in the browser Network tab before deploying.
- Use `make -C static build` (or equivalent) to verify the production build.
- Run `make -C backend test` after any schema changes.
- Use `fly proxy` to verify rows appear in the production database after end-to-end testing.

### Do Not

- Add API key authentication in this task — that's MT-1.
- Modify the `events` or `leads` table schema.
- Add new backend routes — all required endpoints already exist.
- Remove the honeypot field — it's the primary bot protection pre-CAPTCHA.
- Use `XMLHttpRequest` — use `fetch` with `keepalive: true` as the `sendBeacon` fallback.

## Manual Review Checklist

- [ ] Form submission only works with JS (no backend URL leaked in HTML source).
- [ ] CORS preflight from the GitHub Pages domain succeeds.
- [ ] `sendBeacon` fires on `visibilitychange` (DevTools → Application → Background Services).
- [ ] UTM params from `?utm_source=test&utm_medium=email` appear in the event `props` column.
- [ ] Honeypot field triggers silent discard (202, no DB row).

---

# Consolidated Checklist

## Completed

- [x] Email capture form markup (`static/src/index.html`).
- [x] Email capture styles (`static/styles/_email-capture.scss`).
- [x] Telemetry module with beacons, CWV, scroll, engagement (`static/src/assets/telemetry.ts`).
- [x] JS-enhanced form submit with inline success/error.
- [x] Backend `POST /v1/events` and `POST /v1/leads/capture` deployed.
- [x] CORS configured for `altcontext.com` + `www.altcontext.com`.

## Phase 0: Static Site Fixes

- [x] Form `action="#"` — no backend endpoint exposed in HTML (JS-only submit).
- [x] Add `getUtmParams()` to `telemetry.ts` — parse `utm_*` from `location.search`.
- [x] Include UTM params in all beacon payloads (page_view, engagement, form_submit).
- [x] **Gate**: `make -C static build` succeeds.

## Phase 1: Build & Deploy Config

- [x] Set `BACKEND_URL=https://marketing-altcontext.fly.dev` in GitHub Pages build config (`.github/workflows/pages.yml`).
- [x] Verify `BACKEND_URL` is injected into `telemetry.js` output.
- [x] **Gate**: `make -C backend audit` — pass.
- [x] **Gate**: `make -C backend test` — pass.

## Phase 2: Deploy & End-to-End Verification

- [x] Set `BACKEND_URL=https://marketing-altcontext.fly.dev` in GitHub Pages build config.
- [x] Deploy static site to GitHub Pages.
- [x] Verify `page_view` beacon appears in production `events` table.
- [x] Verify `engagement` beacon fires on tab switch / page close.
- [x] Verify email form submission creates `leads` + `lead_identities` + `form_submissions` rows.
- [x] Verify CWV metrics (LCP, CLS, INP) appear in event `traffic` column.
- [x] Verify UTM params appear in event `utm_source` / `utm_medium` / `utm_campaign` columns.
- [x] Verify honeypot submission is silently discarded (202, no row).
- [x] **Gate**: `fly logs` shows structured ingest events from the static site.

## Phase 3: Cleanup

- [x] Close `static-tasks/email-capture-and-telemetry.md` (add CLOSED header, check completed phases).
- [x] Update ROADMAP.md Phase 5 checklist items.
- [x] **Gate**: `make -C backend audit && make -C backend test` — full pass.

## Stretch Goals

- [ ] Add property identifier to beacons (`traffic.propertyId: "marketing-site"`).
- [ ] Scroll depth tracking fires at 25/50/75/100% milestones.
- [ ] Face-pose interaction events (`cta_click`, `face_pose_scrub`) fire correctly.
- [ ] Error tracking — beacon failures logged to `console.warn`.
- [ ] Add `npm audit --audit-level=moderate` to CI workflow.

## Success Criteria

- [x] `make -C backend audit` passes.
- [x] `make -C backend test` passes — all integration tests green.
- [x] At least one `page_view` event from the live static site exists in the production `events` table.
- [x] At least one lead capture from the live email form exists in the production `leads` table.
- [x] No backend endpoint exposed in HTML source (`action="#"`).
- [x] UTM params from URL query string appear in the production `events` table.
- [x] `sendBeacon` fires reliably on `pagehide` (engagement event stored).

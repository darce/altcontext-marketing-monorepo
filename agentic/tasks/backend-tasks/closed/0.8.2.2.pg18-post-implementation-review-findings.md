# 0.8.2.2 PG18 Post-Implementation Review Findings

> ✅ **Status:** CLOSED
>
> Manual review of touched files for `0.8.2.pg18-upgrade-migration.md` against:
> - `agentic/instructions/backend/code-review-checklist.md`
> - `agentic/instructions/backend/verification.md`

## Verification Context

- `make -C backend audit` passes on this branch.
- `make -C backend test` passes on this branch.
- Additional probes run for this review:
  - `cd backend && DATABASE_URL="postgresql://daniel@localhost:5432/altcontext_dev" npx prisma migrate diff --from-config-datasource --to-schema prisma/schema.prisma --exit-code` (exit code `2`).
  - `psql postgresql://daniel@localhost:5432/altcontext_dev -Atc "set role app_user; begin; select public.set_tenant_context('00000000-0000-4000-a000-00000000000a'::uuid); rollback;"` (fails with `unknown tenant`).
  - `psql postgresql://daniel@localhost:5432/altcontext_dev -Atc "select 'public',count(*) from public.tenants where id='00000000-0000-4000-a000-00000000000a' union all select 'backend_test',count(*) from backend_test.tenants where id='00000000-0000-4000-a000-00000000000a';"` (shows tenant exists only in `backend_test`).

## Findings

### F1 — `set_tenant_context` schema hard-wiring (Critical) — RESOLVED

**Severity:** Bug  
**Checklist linkage:** config/runtime correctness under schema changes  
**Files:** `backend/prisma/migrations/20260217133000_pg18_upgrade/migration.sql`, `backend/src/lib/db.ts`, `backend/test/integration/rls-isolation.test.ts`

The function validates tenant IDs using `public.tenants` regardless of active schema:

```sql
IF NOT EXISTS (SELECT 1 FROM public.tenants WHERE id = tid) THEN ...
```

This conflicts with added non-public-schema handling (`?schema=...` search path support) and causes false `unknown tenant` errors when tenant rows exist outside `public`.

- [x] `set_tenant_context` now validates tenant existence against a schema argument via dynamic, identifier-quoted SQL.
- [x] `withTenant()` now passes the resolved active schema to `set_tenant_context(...)`.
- [x] Added integration coverage asserting schema-aware behavior (`set_tenant_context validates tenants in the active schema`).

---

### F2 — `make test` reset scope (High) — RESOLVED

**Severity:** Bug  
**Checklist linkage:** documentation/config drift  
**Files:** `backend/Makefile`

`test` now runs against a dedicated isolated DB (`altcontext_test`) instead of reusing the dev DB.

- [x] Switched to dedicated `TEST_DB` / `TEST_DATABASE_URL`.
- [x] Added `db-create-test` target.
- [x] Updated target description to "isolated database".

---

### F3 — Schema source-of-truth split (Medium) — RESOLVED

**Severity:** Gap  
**Checklist linkage:** recurring configuration mismatch pattern  
**Files:** `backend/src/lib/database-schema.ts`, `backend/src/lib/db.ts`, `backend/src/lib/sql.ts`, `backend/src/services/metrics/materialized-view.ts`, `backend/test/helpers/prisma.ts`, `backend/test/lib/database-schema.test.ts`

Connection pools derive schema from `DATABASE_URL` query param (`?schema=`), while SQL identifier builders derive schema from `DATABASE_SCHEMA`. If only one is set, reads/writes can silently target different schemas.

- [x] Added shared schema resolver (`resolveDatabaseSchema`) and shared search-path option helper.
- [x] Updated runtime pool, SQL identifier helpers, materialized-view service, and Prisma test helper to use the shared resolver.
- [x] Added tests for URL parsing, explicit-schema precedence, and conflict detection.

---

### F4 — Prisma drift includes index-name drift beyond documented UUID default drift (Medium) — RESOLVED

**Severity:** Gap  
**Checklist linkage:** #17 Prisma default/drift verification  
**Files:** `backend/prisma/schema.prisma`, `backend/prisma/migrations/20260216204500_mt1_tenant_model/migration.sql`

`prisma migrate diff` reports not only intentional `id` default differences, but also index rename drift (for example `*_property_day_key` vs `*_property_id_day_key`, and `lead_visitor_source_key` naming drift). This is not currently documented as an accepted drift set.

- [x] Pinned unique index names in Prisma schema using `map:` to align with existing migration names.
- [x] Re-ran `prisma migrate diff`; index-rename drift is gone. Remaining drift is only the already-accepted ID/default/generated-column differences.

---

### F5 — `set_tenant_context` executable by `PUBLIC` (Low) — RESOLVED

**Severity:** Antipattern (least-privilege gap)  
**Files:** `backend/prisma/migrations/20260217133000_pg18_upgrade/migration.sql`

The migration grants execute to `app_user` but does not revoke function execute from `PUBLIC`. PostgreSQL default function ACL keeps `EXECUTE` for `PUBLIC` unless revoked.

- [x] Added `REVOKE ALL ON FUNCTION public.set_tenant_context(uuid, text) FROM PUBLIC;`.
- [x] Added explicit `GRANT EXECUTE ON FUNCTION public.set_tenant_context(uuid, text) TO app_user;`.
- [x] Verified ACL state: `daniel=X/daniel,app_user=X/daniel` (no `PUBLIC` execute grant).

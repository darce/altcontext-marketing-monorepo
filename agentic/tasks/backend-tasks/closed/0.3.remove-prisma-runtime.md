# 0.3 Remove Prisma Runtime — ✅ CLOSED

> **Status**: All phases complete. Verified 2026-02-15. See [0.3.1 audit](./0.3.1-post-prisma-removal-audit.md) for post-implementation review.

## Applicable Instruction Files

Per the [routing table](../../instructions.md), load for every backend task:

| File | Reason |
|------|--------|
| [`backend/service-rules.md`](../../instructions/backend/service-rules.md) | Makefile orchestration, API behaviour, privacy |
| [`backend/verification.md`](../../instructions/backend/verification.md) | Build gates, deterministic tool matrix, manual review rules, task plan requirements |
| [`language-standards.md`](../../instructions/language-standards.md) | TS required rules (arrow fns, no `any`, percentile correctness, semantic naming, transaction writes, no dead exports, no blind casts, shared schemas) |
| [`verification-and-agent-roe.md`](../../instructions/verification-and-agent-roe.md) | Tool-calling conventions, Make target naming, Do/Don't |

## Problem Statement

Prisma's library engine adds ~40–80 MB RSS to the runtime, pushing the Node.js process past the 256 MB Fly.io VM limit. Remove `@prisma/client` and `@prisma/adapter-pg` from production dependencies so the app runs within a 256 MB VM using only the `pg` driver. Prisma remains in `devDependencies` for schema management, migrations, and studio.

## Workflow Principles

- **Dev-only Prisma**: Keep `prisma/schema.prisma`, migrations, and CLI — but zero Prisma imports in `src/` at build time.
- **Lightweight Runtime**: Use `pg.Pool` directly with a thin `sql` tagged template helper.
- **CI/CD Migrations**: Run `prisma migrate deploy` in the CI pipeline before `flyctl deploy`, not inside the production image.
- **Greenfield-first**: No data migration/backfill SQL needed — schema is stable.

## Terminology

- **`pg` wrapper** (`src/lib/db.ts`): New module managing `pg.Pool`, `sql` tagged template, and transaction helper.
- **`schema-enums.ts`**: Static TypeScript enums mirroring Prisma schema enums.
- **Culling Prisma**: Moving `@prisma/client` + `@prisma/adapter-pg` to `devDependencies` and verifying they're absent in `--omit=dev` installs.

## Current State Analysis

### Runtime Prisma Imports (13 files)

#### Lib Layer
- `src/lib/prisma.ts`: Initializes `PrismaClient` with `PrismaPg` adapter. Exports `prisma` singleton and `databaseSchema`.
- `src/lib/sql.ts`: Uses `Prisma.Sql`, `Prisma.raw()` for schema-qualified table/type references.
- `src/lib/json.ts`: Uses `Prisma.InputJsonValue` type for JSON serialization guards.

#### Service Layer
- `src/services/leads.ts`: Uses `LinkSource`, `ValidationStatus`, `Prisma.DbNull`, `Prisma.TransactionClient`, `Prisma.EventCreateInput`, `Prisma.FormSubmissionCreateInput`; CRUD via `.upsert()`, `.create()`, `.findUnique()`, `.delete()`, `.updateMany()`.
- `src/services/events.ts`: Uses `DeviceType`, `TrafficSource`, `Prisma.TransactionClient`; raw SQL via `$queryRaw`, CRUD via `.findUnique()`.
- `src/services/consent.ts`: Uses `ConsentStatus`, `Prisma.TransactionClient`; CRUD via `.findUnique()`, `.update()`, `.create()`.
- `src/services/identity.ts`: Uses `LinkSource`, `Prisma.TransactionClient`; CRUD via `.findFirst()`, `.update()`, `.create()`, `.createMany()`, `.updateMany()`.
- `src/services/visitors.ts`: Uses `Prisma.TransactionClient`, `Session`, `Visitor` types; CRUD via `.upsert()`, `.findFirst()`, `.create()`, `.update()`.
- `src/services/metrics/rollups.ts`: Uses `Prisma.sql`, `Prisma.empty`, `Prisma.InputJsonValue`, `PrismaClient`; raw SQL via `$queryRaw`, CRUD via `.upsert()`, `.findFirst()`.
- `src/services/metrics/materialized-view.ts`: Uses `Prisma.PrismaClientKnownRequestError`, `PrismaClient`; DDL via `$executeRaw`, `$executeRawUnsafe`, raw SQL via `$queryRaw`.
- `src/services/metrics/summary.ts`: Uses `TrafficSource` enum values as array, `PrismaClient`; queries via rollups/materialized-view modules.

#### Route Layer
- `src/routes/leads.ts`: Imports `prisma` singleton; calls `prisma.$transaction()`.
- `src/routes/events.ts`: Imports `prisma` singleton; calls `prisma.$transaction()`.

#### Scripts
- `src/scripts/rollups-discrepancy.ts`: Uses `Prisma.sql`.

### Enums (5)

| Enum | Values | Runtime Usage |
|------|--------|---------------|
| `ConsentStatus` | `pending`, `express`, `implied`, `withdrawn` | `consent.ts` switch/case, `.create()` |
| `LinkSource` | `form_submit`, `same_ip_ua_window`, `manual_merge` | `identity.ts`, `leads.ts` `.create()`, `.findFirst()` |
| `ValidationStatus` | `accepted`, `rejected`, `invalid` | `leads.ts` `.create()` |
| `TrafficSource` | `direct`, `organic_search`, `paid_search`, `social`, `email`, `referral`, `campaign`, `internal`, `unknown` | `events.ts` resolver, `summary.ts` array |
| `DeviceType` | `desktop`, `mobile`, `tablet`, `bot`, `unknown` | `events.ts` resolver |

### Prisma Utility Types to Replace

| Prisma Type | Replacement | Files |
|-------------|-------------|-------|
| `Prisma.TransactionClient` | `pg.PoolClient` | leads, events, consent, identity, visitors |
| `PrismaClient` | `pg.Pool` | rollups, materialized-view, summary |
| `Prisma.Sql` / `.raw()` / `.empty` | Custom `sql` tag + `rawSql()` helper | sql, rollups, materialized-view |
| `Prisma.InputJsonValue` | `JsonValue` (hand-written) | json, rollups |
| `Prisma.DbNull` | SQL `NULL` | leads |
| `Prisma.*CreateInput` | Inline object types | leads |
| `Session`, `Visitor` | Hand-written row interfaces | visitors |
| `PrismaClientKnownRequestError` | PG error code check (`42P01`) | materialized-view |

### Deployment Artifacts

- `backend/Dockerfile` L34-37: Copies `.prisma` and `@prisma` dirs into production image.
- `backend/fly.toml` L9: `release_command` runs `prisma migrate deploy` via `node_modules/prisma/build/index.js`.
- `backend/fly.toml` L28: Already set to `memory = '256mb'`.

## Proposed Solution

1. Create `src/lib/db.ts` — `pg.Pool` singleton with `sql` tag, `rawSql()`, `transaction()` helper.
2. Create `src/lib/schema-enums.ts` — static enums for all 5 Prisma enums.
3. Refactor all 13 source files to import from `db.ts` and `schema-enums.ts` instead of `@prisma/client`.
4. Rewrite Prisma CRUD calls as parameterized SQL (`INSERT ... RETURNING`, `UPDATE ... RETURNING`, `SELECT`, `DELETE`).
5. Move `@prisma/client` and `@prisma/adapter-pg` to `devDependencies`.
6. Update Dockerfile to stop copying Prisma artifacts into the production image.
7. Change `fly.toml` release_command to run migrations from CI/CD (via `npx prisma migrate deploy` in GitHub Actions / local `make` target before deploy).
8. Update `service-rules.md` § Resource Constraints to reflect 256 MB viability.

## Patterns to Follow

### Lightweight SQL Tag (`db.ts`)

```typescript
import pg from "pg";

const pool = new pg.Pool({ connectionString: process.env.DATABASE_URL });

export interface SqlQuery {
  text: string;
  values: unknown[];
}

export const sql = (
  strings: TemplateStringsArray,
  ...values: unknown[]
): SqlQuery => {
  const text = strings.reduce(
    (acc, str, i) => acc + str + (i < values.length ? `$${i + 1}` : ""),
    "",
  );
  return { text, values };
};

export const rawSql = (raw: string): SqlQuery => ({ text: raw, values: [] });

export const emptySql = (): string => "";

export const query = <T extends pg.QueryResultRow>(
  client: pg.PoolClient | pg.Pool,
  q: SqlQuery,
): Promise<pg.QueryResult<T>> => client.query<T>(q.text, q.values);

export const transaction = async <T>(
  fn: (client: pg.PoolClient) => Promise<T>,
): Promise<T> => {
  const client = await pool.connect();
  try {
    await client.query("BEGIN");
    const result = await fn(client);
    await client.query("COMMIT");
    return result;
  } catch (err) {
    await client.query("ROLLBACK");
    throw err;
  } finally {
    client.release();
  }
};
```

### Schema Enums (`schema-enums.ts`)

```typescript
export const ConsentStatus = {
  pending: "pending",
  express: "express",
  implied: "implied",
  withdrawn: "withdrawn",
} as const;
export type ConsentStatus =
  (typeof ConsentStatus)[keyof typeof ConsentStatus];

// Same pattern for LinkSource, ValidationStatus, TrafficSource, DeviceType
```

### CRUD → SQL Pattern

```typescript
// Before (Prisma)
const lead = await tx.lead.upsert({
  where: { emailNormalized },
  update: { lastCapturedAt: occurredAt },
  create: { emailNormalized, firstCapturedAt: occurredAt, lastCapturedAt: occurredAt },
});

// After (pg)
const { rows } = await query<LeadRow>(tx, sql`
  INSERT INTO ${schemaRef}.leads ("email_normalized", "first_captured_at", "last_captured_at")
  VALUES (${emailNormalized}, ${occurredAt}, ${occurredAt})
  ON CONFLICT ("email_normalized")
  DO UPDATE SET "last_captured_at" = ${occurredAt}
  RETURNING *
`);
const lead = rows[0]!;
```

## Functions to Change

| File | Change |
|------|--------|
| `src/lib/prisma.ts` | Replace with `db.ts` (`pg.Pool` + `sql` tag + `transaction`) |
| `src/lib/sql.ts` | Remove `@prisma/client` import; use `rawSql()` from `db.ts` |
| `src/lib/json.ts` | Replace `Prisma.InputJsonValue` with local `JsonValue` type |
| `src/services/leads.ts` | Replace all Prisma CRUD with SQL; use local enums |
| `src/services/events.ts` | Replace `$queryRaw` → `query()`; `.findUnique()` → SQL; use local enums |
| `src/services/consent.ts` | Replace CRUD with SQL; use local `ConsentStatus` |
| `src/services/identity.ts` | Replace CRUD with SQL; use local `LinkSource` |
| `src/services/visitors.ts` | Replace CRUD with SQL; define `VisitorRow`, `SessionRow` interfaces |
| `src/services/metrics/rollups.ts` | Replace `$queryRaw` → `query()`; `.upsert()` → SQL |
| `src/services/metrics/materialized-view.ts` | Replace `$executeRaw` → `query()`; PG error code check |
| `src/services/metrics/summary.ts` | Replace `TrafficSource` enum import; update `PrismaClient` → `pg.Pool` |
| `src/routes/leads.ts` | Replace `prisma.$transaction()` → `transaction()` from `db.ts` |
| `src/routes/events.ts` | Replace `prisma.$transaction()` → `transaction()` from `db.ts` |
| `src/scripts/rollups-discrepancy.ts` | Replace `Prisma.sql` → `sql` from `db.ts` |

## Related Files

| File | Note |
|------|------|
| `backend/package.json` | Move `@prisma/client` + `@prisma/adapter-pg` to `devDependencies` |
| `backend/prisma/schema.prisma` | Source of truth for schema — remains for dev use |
| `backend/Dockerfile` | Remove Prisma artifact copies from production stage |
| `backend/fly.toml` | Remove `release_command` (migrations move to CI/CD) |
| `agentic/instructions/backend/service-rules.md` | Update § Resource Constraints for 256 MB viability |

## Agent Do / Don't (This Task)

### Do

- Use `pg.Pool` for the runtime client.
- Ensure all services accept `pg.PoolClient` as the transaction client type.
- Use parameterized queries (`$1`, `$2`, …) for all values — never string interpolation.
- Keep `rawSql()` for trusted identifiers only (table/type refs with `quoteIdentifier`).
- Run `prisma migrate deploy` from CI/CD or from a pre-deploy Make target.
- Verify with `npm install --omit=dev` that `@prisma/client` is absent.

### Do Not

- Remove `prisma/migrations` or `schema.prisma`.
- Import anything from `@prisma/client` in `src/`.
- Use string interpolation for user-supplied values in SQL.
- Introduce `pg-promise` or other ORM wrappers — keep it to bare `pg`.

## Manual Review Checklist

- [ ] All `INSERT` / `UPDATE` statements use parameterized values, not string interpolation.
- [ ] `quoteIdentifier()` is used for all dynamic identifiers (table names, schema names).
- [ ] `materialized-view.ts` error detection uses PG sqlstate `42P01` instead of Prisma error codes.
- [ ] `rollups.ts` percentile query uses `PERCENTILE_CONT` correctly (no change from current).
- [ ] `transaction()` wrapper properly calls `ROLLBACK` on error and releases the client.
- [ ] No `@prisma/client` import remains in any file under `src/`.

---

# Consolidated Checklist

## Completed

- [x] Research current Prisma usage across all source files.
- [x] Create corrected implementation plan with full scope.

## Phase 0: Scaffolding & Enums

- [x] Create `backend/src/lib/db.ts` with `pg.Pool`, `sql` tag, `rawSql()`, `emptySql()`, `query()`, `transaction()`.
- [x] Create `backend/src/lib/schema-enums.ts` with all 5 enums (`ConsentStatus`, `LinkSource`, `ValidationStatus`, `TrafficSource`, `DeviceType`).
- [x] Create `backend/src/lib/types.ts` with `JsonValue`, `VisitorRow`, `SessionRow`, `LeadRow` etc.
- [x] **Gate**: `make -C backend check` passes.

## Phase 1: Lib Layer Refactor

- [x] Replace `backend/src/lib/prisma.ts` with `db.ts` re-export (keep `databaseSchema` export).
- [x] Update `backend/src/lib/sql.ts` to use `rawSql()` from `db.ts` instead of `Prisma.raw`.
- [x] Update `backend/src/lib/json.ts` to use local `JsonValue` type instead of `Prisma.InputJsonValue`.
- [x] **Gate**: `make -C backend check` passes.

## Phase 2: Service Layer Refactor

- [x] Refactor `backend/src/services/visitors.ts` — CRUD → SQL.
- [x] Refactor `backend/src/services/consent.ts` — CRUD → SQL.
- [x] Refactor `backend/src/services/identity.ts` — CRUD → SQL.
- [x] Refactor `backend/src/services/leads.ts` — CRUD → SQL.
- [x] Refactor `backend/src/services/events.ts` — `$queryRaw` → `query()`, CRUD → SQL.
- [x] Refactor `backend/src/services/metrics/rollups.ts` — `$queryRaw` → `query()`, `.upsert()` → SQL.
- [x] Refactor `backend/src/services/metrics/materialized-view.ts` — `$executeRaw` → `query()`, PG error codes.
- [x] Refactor `backend/src/services/metrics/summary.ts` — enum + `PrismaClient` → `pg.Pool`.
- [x] **Gate**: `make -C backend check` passes.
- [x] **Gate**: `make -C backend dead-exports` — no orphaned exports.

## Phase 3: Route & Script Layer

- [x] Update `backend/src/routes/leads.ts` — `prisma.$transaction()` → `transaction()`.
- [x] Update `backend/src/routes/events.ts` — `prisma.$transaction()` → `transaction()`.
- [x] Update `backend/src/scripts/rollups-discrepancy.ts` — `Prisma.sql` → `sql`.
- [x] Update any remaining scripts (`rollups-run.ts`, `rollups-backfill.ts`, etc.) that import `prisma`.
- [x] **Gate**: `make -C backend check` passes.

## Phase 4: Dependency & Deployment

- [x] Move `@prisma/client` and `@prisma/adapter-pg` to `devDependencies` in `package.json`.
- [x] Update `Dockerfile` — remove Prisma artifact copies from production stage.
- [x] Update `fly.toml` — remove `release_command` (migrations run from CI/CD).
- [x] Add a `make -C backend fly-migrate` target that runs `npx prisma migrate deploy` against the production DB.
- [x] Update `service-rules.md` § Resource Constraints to document 256 MB viability.
- [x] **Gate**: `make -C backend check` passes.

## Phase 5: Tests and Verification

- [x] Run all integration tests: `make -C backend test`.
- [x] Verify production install: `npm install --omit=dev` and check `node_modules` — no `@prisma/client`.
- [x] Verify Docker build: `docker build` succeeds without Prisma.
- [x] **Gate**: `make -C backend audit` passes.
- [x] Complete Manual Review Checklist (above).

## Stretch Goals

- [ ] Add integration tests for `db.ts` `transaction()` (rollback on error).
- [ ] Add a CI step to enforce no `@prisma/client` imports in `src/`.

## Success Criteria

- [x] `make -C backend audit` passes.
- [x] `@prisma/client` NOT present in production `node_modules` (`npm install --omit=dev`).
- [x] Docker image builds without Prisma artifacts.
- [x] `fly.toml` has no Prisma-dependent `release_command`.
- [x] All integration tests pass using `pg` driver directly.
- [x] App starts and responds to `/v1/healthz` within 256 MB VM.

# 0.6.1 Telemetry Review Findings

> Findings from implementation review of the telemetry module (`static/src/assets/telemetry.ts`) and related integration files during [0.6.first-property-integration.md](./0.6.first-property-integration.md).
> Review date: 2026-02-16. Backend gates: `make -C backend audit` ✅, `make -C backend test` ✅.

## Status

> ✅ **CLOSED** — All 9 findings (5 bugs, 4 antipatterns) resolved. Verified 2026-02-16.
> Tests pass: `make -C backend audit` ✅, `make -C backend test` ✅.

## Applicable Instruction Files

| File | Relevance |
|------|-----------|
| [`static/authoring-and-runtime.md`](../../instructions/static/authoring-and-runtime.md) | Telemetry module authoring rules |
| [`static/architecture.md`](../../instructions/static/architecture.md) | Static site architecture + build pipeline |
| [`code-review-checklist.md`](../../instructions/backend/code-review-checklist.md) | Backend schema alignment review |
| [`service-rules.md`](../../instructions/backend/service-rules.md) | Event ingestion contract |

---

## Summary

| Category | Count |
|----------|-------|
| Bugs | 5 |
| Antipatterns | 4 |
| Blocking (data loss on mobile) | 1 (B1) |

---

## B. Bugs

### B1. `unload` is deprecated and unreliable — engagement beacons silently lost on mobile

**Severity:** High (silent data loss)
**File:** `static/src/assets/telemetry.ts` L101, L132, L163, L257
**Issue:** Four `window.addEventListener("unload", ...)` calls. Chrome 65+ and mobile Safari no longer fire `unload` reliably, and its presence disables bfcache. The 0.6 task spec explicitly requires: *"Beacons must fire on `visibilitychange` / `pagehide`"*.

**Impact:** Engagement, scroll depth, face-pose scrub, and CWV beacons will silently fail to fire on most mobile browsers. The production funnel will show near-zero engagement from mobile traffic.

**Fix:** Replace all four `unload` listeners with `pagehide`. Example:

```typescript
window.addEventListener("pagehide", () => { ... }, { once: true });
```

### B2. Duplicate beacons for scroll_depth and CWV on tab close

**Severity:** Medium (duplicate DB rows)
**File:** `static/src/assets/telemetry.ts` L122–137 (scroll_depth), L240–261 (CWV)
**Issue:** When a user closes a tab, `visibilitychange` fires first (`document.hidden = true`), then `pagehide` fires. Both the `visibilitychange` handler and the `unload`/`pagehide` handler send beacons without dedup. The engagement handler (`trackEngagement`) correctly guards with `!document.hidden`, but `trackScrollDepth` and `trackWebVitals` do not.

**Impact:** Each tab close creates 2× scroll_depth and 2× CWV events in the database. The dedupe key includes a 30-second time window, but both fires happen within milliseconds so they share the same window — however, the backend dedupe is on the full payload hash including timestamp, so near-identical payloads may or may not collide depending on ISO string precision.

**Fix:** Add a `sent` boolean flag, set it on first send. Or remove the `pagehide` handler and rely solely on `visibilitychange` for these two trackers.

```typescript
let scrollSent = false;
// in visibilitychange handler:
if (document.hidden && maxScrollDepthPercent > 0 && !scrollSent) {
  scrollSent = true;
  sendBeacon("scroll_depth", { maxDepthPercent: maxScrollDepthPercent });
}
```

### B3. CLS accumulation resets per observer callback

**Severity:** Medium (incorrect metric)
**File:** `static/src/assets/telemetry.ts` L197
**Issue:** `let clsValue = 0` is declared **inside** the PerformanceObserver callback. Each batch of `layout-shift` entries overwrites the running total instead of accumulating across the page lifetime. The web-vitals spec requires cumulative accumulation.

**Impact:** Reported CLS values will only reflect the last batch of layout shifts, not the true cumulative score.

**Fix:** Move `clsValue` outside the callback, next to the `vitals` object:

```typescript
let clsValue = 0;  // ← move here, outside the observer callback
const clsObserver = new PerformanceObserver((entryList) => {
  for (const entry of entryList.getEntries()) { ... }
  vitals.clsScore = Math.round(clsValue * 1000) / 1000;
});
```

### B4. Telemetry data lands in `props` instead of `traffic` — backend enrichment is dead code

**Severity:** Medium (structured data loss)
**File:** `static/src/assets/telemetry.ts` (sendBeacon), `backend/src/services/events.ts` L248–260
**Issue:** The client sends engagement, scroll depth, and CWV data via the `props` parameter:

```typescript
sendBeacon("engagement", { engagedTimeMs });          // → props.engagedTimeMs
sendBeacon("scroll_depth", { maxDepthPercent });       // → props.maxDepthPercent
sendBeacon("cwv", { webVitals: vitals });              // → props.webVitals
```

But the backend extracts these from `body.traffic`:

```typescript
body.traffic?.webVitals        // never populated by client
body.traffic?.engagedTimeMs    // never populated by client
body.traffic?.scrollDepthPercent  // never populated by client
```

The enrichment block in `ingestEvent()` that flattens CWV, engagedTimeMs, and scrollDepthPercent into `enrichedProps` is **dead code**. All metrics stay in the generic `props` JSONB column without structured fields.

**Fix:** Wrap telemetry metrics in a `traffic` envelope matching `trafficSchema`:

```typescript
// engagement
sendBeacon("engagement", undefined, { engagedTimeMs });
// scroll
sendBeacon("scroll_depth", undefined, { scrollDepthPercent: maxScrollDepthPercent });
// CWV
sendBeacon("cwv", undefined, { webVitals: vitals });
```

This requires updating `sendBeacon` to accept an optional `traffic` parameter alongside `props`. Or, simpler: for engagement/scroll/CWV event types, populate `traffic` instead of `props`.

### B5. Built `dist/assets/telemetry.js` contains stale BACKEND_URL

**Severity:** Low (no production impact, CI rebuilds from source)
**File:** `static/dist/assets/telemetry.js` L4
**Issue:** The committed dist artifact contains `"https://test.backend.altcontext.com"` — a URL from a prior local build. CI rebuilds from source with the correct URL, so production is unaffected. But anyone running from the committed dist locally would send beacons to a dead endpoint.

**Fix:** Either rebuild dist with the correct URL before committing, or add `static/dist/` to `.gitignore` (CI builds from source anyway). Recommend the latter — committing build artifacts is fragile.

---

## A. Antipatterns

### A1. `performance.timing` is deprecated

**Severity:** Low
**File:** `static/src/assets/telemetry.ts` L245
**Issue:** `performance.timing` (PerformanceTiming) is deprecated in favor of `PerformanceNavigationTiming`. Chrome 120+ flags it in DevTools.

**Fix:**

```typescript
const navEntry = performance.getEntriesByType("navigation")[0] as PerformanceNavigationTiming | undefined;
if (navEntry) {
  vitals.ttfbMs = Math.round(navEntry.responseStart - navEntry.startTime);
}
```

### A2. INP tracks last event, not worst interaction

**Severity:** Low (metric inaccuracy)
**File:** `static/src/assets/telemetry.ts` L224
**Issue:** Takes `processingDuration` from the most recent `event` entry. INP is defined as the **worst** (p98) interaction latency, using the `duration` field (full input-to-paint), not `processingDuration` (handler time only).

**Fix:**

```typescript
let worstInp = 0;
const inpObserver = new PerformanceObserver((entryList) => {
  for (const entry of entryList.getEntries()) {
    if (entry.duration > worstInp) {
      worstInp = entry.duration;
    }
  }
  vitals.inpMs = Math.round(worstInp);
});
```

### A3. No double-submit protection on email form

**Severity:** Low (UX + duplicate leads)
**File:** `static/src/assets/telemetry.ts` L269
**Issue:** `enhanceEmailForm()` doesn't disable the submit button during the fetch. Rapid clicks create duplicate lead captures and duplicate `form_submit` beacons. The backend upserts by email so no duplicate leads are created, but duplicate events and form_submissions rows are.

**Fix:** Disable the button on submit, re-enable on error:

```typescript
const submitBtn = form.querySelector("button[type=submit]") as HTMLButtonElement | null;
if (submitBtn) submitBtn.disabled = true;
// ... in .catch():
if (submitBtn) submitBtn.disabled = false;
```

### A4. Honeypot sent as empty string instead of omitted

**Severity:** Trivial
**File:** `static/src/assets/telemetry.ts` L284
**Issue:** `honeypot: honeypotInput?.value.trim() ?? ""` sends `"honeypot": ""` in the leads payload. The backend checks `.length > 0` so this works, but it sends unnecessary bytes. The events beacon sends `honeypot: undefined` which Zod strips — inconsistent.

**Fix:** `honeypot: honeypotInput?.value.trim() || undefined`

---

## Prioritised Fix Order

| # | Finding | Effort | Priority | Rationale |
|---|---------|--------|----------|-----------|
| B1 | `unload` → `pagehide` | Small | **P0** | Mobile engagement data is silently lost |
| B3 | CLS accumulator scope | Trivial | **P0** | One-line fix, incorrect metric |
| B2 | Duplicate beacon dedup | Small | **P1** | Inflated event counts |
| B4 | `props` → `traffic` envelope | Moderate | **P1** | Backend enrichment dead code |
| A3 | Double-submit guard | Small | **P1** | Duplicate form_submissions |
| A1 | Deprecated `performance.timing` | Small | **P2** | Future-proofing |
| A2 | INP worst-interaction | Small | **P2** | Metric accuracy |
| A4 | Honeypot empty string | Trivial | **P2** | Cleanup |
| B5 | Stale dist artifact | Small | **P2** | Local dev only; recommend .gitignore |

---

# Consolidated Checklist

## Phase 0: Critical Beacon Fixes (P0)

- [x] Replace all 4 `unload` listeners with `pagehide` (B1).
- [x] Move `clsValue` outside PerformanceObserver callback (B3).
- [x] **Gate**: Local build succeeds (`BACKEND_URL='' npm run build:assets:scripts`).

## Phase 1: Data Quality Fixes (P1)

- [x] Add `sent` flags to `trackScrollDepth` and `trackWebVitals` to prevent duplicate beacons (B2).
- [x] Update `sendBeacon()` signature to accept optional `traffic` parameter (B4).
- [x] Send engagement, scroll, and CWV data via `traffic` envelope instead of `props` (B4).
- [x] Disable submit button during fetch in `enhanceEmailForm` (A3).
- [x] **Gate**: Verify with DevTools Network tab — one scroll_depth and one CWV beacon per tab close.

## Phase 2: Cleanup (P2)

- [x] Replace `performance.timing` with `PerformanceNavigationTiming` (A1).
- [x] Fix INP to track worst `duration` across all event entries (A2).
- [x] Change honeypot to `|| undefined` instead of `?? ""` (A4).
- [x] Add `static/dist/` to `.gitignore` (B5).
- [x] **Gate**: `make -C backend audit` ✅, `make -C backend test` ✅.

## Phase 3: Verification

- [x] Local dev server: confirm `page_view`, `engagement`, `scroll_depth`, `cwv` beacons fire correctly.
- [x] Verify `traffic.webVitals`, `traffic.engagedTimeMs`, `traffic.scrollDepthPercent` land in enrichedProps.
- [x] Verify no duplicate beacons on tab close (single `scroll_depth`, single `cwv`).
- [x] Verify form double-submit is blocked.
- [x] **Gate**: Ready to proceed with 0.6 Phase 2 (deploy + e2e verification).

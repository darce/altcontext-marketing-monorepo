# 0.3.1 Post-Prisma-Removal Audit — ✅ CLOSED

> **Status**: All P0–P2 findings resolved and verified against codebase 2026-02-15. Stale comments removed, Dockerfile heap cap corrected (192MB), prisma generate removed from build stage, `service-rules.md` rewritten for 256MB/pg.

Gaps, antipatterns, dead code, and potential bugs found after auditing the implementation of [0.3 Remove Prisma Runtime](./0.3.remove-prisma-runtime.md) against the current `src/` tree.

## Audit Summary

| Category | Count |
|----------|-------|
| Stale comments (agent thinking notes in production code) | 4 |
| Dockerfile inefficiency | 1 |
| Configuration mismatches | 1 |
| Documentation drift | 1 |
| Remaining code clones | 3 |

---

## Stale Comments

Agent-authored thinking-out-loud comments were left in production code. These are not code comments explaining _why_ — they read like internal reasoning notes.

### 1. `src/services/metrics/materialized-view.ts` L84–85

```typescript
// I need to update imports to include rawSql if I use it.
// Actually I can just construct the whole string for the index creation and pass it to query(tx, rawSql(fullString)).
```

**Action**: Delete both lines. The code already works correctly; these are stale planning notes.

---

### 2. `src/scripts/rollups-run.ts` L12–13

```typescript
  // Note: calling rollupDateRange within a single transaction might be long-running.
  // Original usage just passed prisma.
```

**Action**: Delete both lines. First line is vague. Second line references the pre-migration Prisma approach that no longer exists.

---

### 3. `src/services/leads.ts` L10

```typescript
} from "../lib/schema-enums.js"; // Note: Lead interface is in types.ts, unrelated to enums but imports here are cleaned up
```

**Action**: Delete the trailing comment. It explains nothing useful to a reader.

---

## Dockerfile Inefficiency

### `infra/fly/Dockerfile` L12–15 — Prisma generate in build stage

```dockerfile
# Copy Prisma schema and generate client
COPY prisma ./prisma
COPY prisma.config.ts ./
RUN DATABASE_URL="postgresql://dummy@localhost:5432/dummy" npx prisma generate
```

**Risk**: None (the generated client is discarded — it's only in the build stage, not copied to the production stage). But it **wastes ~20s** of build time and downloads ~40MB into the build layer for no reason.

**Action**: Remove these 4 lines. The `tsc` build no longer imports `@prisma/client`, so `prisma generate` is not needed for compilation.

---

## Configuration Mismatch

### `infra/fly/Dockerfile` L39–40 — Heap cap vs actual VM memory

```dockerfile
# Cap V8 heap at 384MB to leave room for OS + native allocations within 512MB VM
CMD ["node", "--max-old-space-size=384", "dist/server.js"]
```

The comment says "within 512MB VM", but `fly.toml` L28 sets `memory = '256mb'`. A 384MB heap cap on a 256MB VM will OOM.

**Action**: Update the heap cap and comment:

```dockerfile
# Cap V8 heap at 192MB to leave room for OS + native allocations within 256MB VM
CMD ["node", "--max-old-space-size=192", "dist/server.js"]
```

> [!WARNING]
> This is the highest-priority fix. The current configuration will OOM on first significant allocation.

---

## Documentation Drift

### `service-rules.md` § Resource Constraints (L76–102)

The section still describes Prisma memory overheads as the primary constraint:

- L78: "**512MB VM minimum** is required for Node.js 22 + Prisma 7"
- L82–83: "Prisma library engine (in-process query engine): ~40–80MB"
- L88: `memory = '512mb'`
- L89: `--max-old-space-size=384`
- L90: `engineType = "library"` reference

L93–102 were partially updated (mention Prisma excluded, external migrations) but still contain contradictory sizing guidance.

**Action**: Rewrite § Resource Constraints to reflect the post-Prisma state. The section should state:
- 256MB VM is viable with `pg` driver directly
- `--max-old-space-size=192` is the correct heap cap
- Prisma memory overhead is eliminated
- Remove references to `engineType = "library"`

---

## Remaining Code Clones (3)

`make -C backend duplicates` reports 3 clones (0.7% duplication, 28 lines). These are acceptable but documented for completeness.

| Clone | Files | Lines | Assessment |
|-------|-------|-------|------------|
| `ensureVisitorSession` call pattern | `events.ts` ↔ `leads.ts` | 9 | Acceptable — distinct service entry points with different bodies |
| Rollup `client.connect` + `rollupDateRange` + `client.release` | `rollups-backfill.ts` ↔ `rollups-run.ts` | 13 | Could extract `withClient(fn)` helper, but low value |
| Transaction + honeypot check boilerplate | `routes/events.ts` ↔ `routes/leads.ts` | 6 | Acceptable — route handlers should be explicit |

**Action**: Monitor. No refactoring needed at this duplication level.

---

## Manual Review Checklist (from task document)

| Item | Status | Notes |
|------|--------|-------|
| All `INSERT`/`UPDATE` use parameterized values | ✅ Pass | All SQL uses `sql` tag with `$N` parameters |
| `quoteIdentifier()` for dynamic identifiers | ✅ Pass | Used in `sql.ts`, `materialized-view.ts` |
| `materialized-view.ts` uses PG `42P01` | ✅ Pass | Correct sqlstate for `undefined_table` |
| `rollups.ts` percentile query correct | ✅ Pass | `PERCENTILE_CONT` unchanged from pre-migration |
| `transaction()` calls ROLLBACK + releases | ✅ Pass | `try/catch/finally` pattern in `db.ts` |
| No `@prisma/client` import in `src/` | ✅ Pass | Zero grep results |

---

## Fix Priority

| Priority | Item | Risk |
|----------|------|------|
| **P0** | Dockerfile heap cap mismatch (384MB on 256MB VM) | OOM crash on deploy |
| **P1** | Remove Prisma generate from Dockerfile build stage | Wasted build time |
| **P1** | Rewrite `service-rules.md` § Resource Constraints | Documentation drift |
| **P2** | Delete 4 stale comments | Code hygiene |

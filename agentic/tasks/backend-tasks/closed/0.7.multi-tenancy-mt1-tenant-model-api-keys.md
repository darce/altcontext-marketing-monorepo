# 0.7 Multi-Tenancy MT-1: Tenant Model & API Keys

> Introduce the tenant model, API key auth for ingest endpoints, and the `withTenant` transaction pattern.
> This is Phase MT-1 of the [multi-tenancy epic](../../roadmaps/epics/multi-tenancy-rls.md).
>
> Pre-requisites: Backend deployed (0.5 ✅), first property integration (0.6 ✅).
> RLS policies (MT-2) and dashboard auth (MT-3) are separate follow-on tasks.

## Applicable Instruction Files

Standard backend files per the [routing table](../../instructions.md#backend-tasks).

| File | Load when… |
|------|------------|
| [`available-tools.md`](../../instructions/available-tools.md) | Deployment, migration, or infrastructure commands |
| [`context-and-architecture.md`](../../instructions/context-and-architecture.md) | Understanding multi-workspace relationships |
| [`backend/service-rules.md`](../../instructions/backend/service-rules.md) | Service layer patterns (`pool → transaction → query`) |
| [`backend/verification.md`](../../instructions/backend/verification.md) | Test and audit gates |

## Problem Statement

All data is currently unscoped — any API caller can write to any `property_id`, and the single `ADMIN_API_KEY` env var controls all admin access. To support multiple tenants with isolated data, we need a tenant model, scoped API keys, and a request-level tenant resolution hook. This phase creates the schema and auth surface; RLS enforcement follows in MT-2.

## Workflow Principles

- **Incremental migration**: `tenant_id` is added as nullable, backfilled to the bootstrap tenant, then made NOT NULL. The system must remain functional between each step.
- **No RLS in this phase**: MT-1 adds the `tenant_id` column and resolution logic. RLS policies are MT-2. Application-level filtering by `tenant_id` is acceptable in MT-1.
- **Backward-compatible API**: Static site beacons must continue working throughout migration. During rollout, both the old keyless path (with `BOOTSTRAP_TENANT_ID` fallback) and the new `x-api-key` path are supported.
- **Key format**: `ak_live_<32 random hex>` for ingest keys, `ak_admin_<32 random hex>` for admin keys. The first 8 chars after prefix are stored as `key_prefix` for identification in the dashboard. The full key is SHA-256 hashed for storage.
- **Single migration file**: One new migration in `prisma/migrations/` containing all DDL for new tables, column additions, backfill, and NOT NULL enforcement.

## Terminology

- **Bootstrap tenant**: The default tenant that owns the AltContext marketing site. Created during migration; all existing data is assigned to it.
- **Ingest API key**: A client-safe key (scope `ingest`) that can only write events/leads for a specific tenant. Safe to embed in JavaScript.
- **Admin API key**: A server-side key (scope `admin`) that can read metrics and delete leads for a specific tenant. Replaces the current `ADMIN_API_KEY` env var.
- **Tenant resolution**: The process of mapping an incoming `x-api-key` header to a `tenant_id` for the request lifecycle.
- **`withTenant`**: A transaction wrapper that sets `app.current_tenant_id` via `SET LOCAL` before running queries. Prepares for MT-2 RLS but also enables application-level tenant scoping in MT-1.

## Current State Analysis

### Schema

- `events`, `daily_metric_rollups`, `daily_ingest_rollups`, `ingest_rejections` have `property_id` (soft namespace, no FK, no enforcement).
- `visitors`, `sessions`, `leads`, `lead_identities`, `form_submissions`, `consent_events` have no tenant scoping at all.
- No `tenants`, `api_keys`, or `users` tables exist.

### Auth

- Single `ADMIN_API_KEY` env var checked via `assertAdminRequest()` in `src/lib/admin-auth.ts`.
- Ingest endpoints (`POST /v1/events`, `POST /v1/leads/capture`) accept unauthenticated requests from CORS-allowed origins.
- `x-admin-key` header used for metrics and delete endpoints.

### Services

- `src/services/events.ts` — event ingestion with visitor/session upsert, dedup, enrichment.
- `src/services/leads.ts` — lead capture, unsubscribe, delete, heuristic linking.
- `src/services/consent.ts` — consent audit log.
- `src/services/identity.ts` — visitor-lead linking.
- `src/services/metrics/` — rollups and summary queries.

All services use `pool` directly or via helper functions. No transaction wrapper exists yet.

## Proposed Solution

### 1. Migration

A single SQL migration that:

1. Creates `tenants` table.
2. Creates `api_keys` table.
3. Creates `users` table (empty for now — populated in MT-3/Auth-1).
4. Adds `tenant_id UUID` (nullable) to all 10 existing tables.
5. Inserts the bootstrap tenant row.
6. Backfills `tenant_id = <bootstrap-tenant-uuid>` on all existing rows.
7. Alters `tenant_id` to NOT NULL on all tables.
8. Adds FK constraints and indexes.
9. Updates unique constraints (e.g., `leads.email_normalized` → `UNIQUE(tenant_id, email_normalized)`).
10. Seeds the bootstrap tenant's admin key from `ADMIN_API_KEY` env var.

### 2. API Key Service

New `src/services/api-keys.ts`:

- `resolveApiKey(rawKey: string): Promise<{ tenantId: string; scope: 'ingest' | 'admin'; propertyId?: string } | null>` — SHA-256 hash lookup with expiry/revocation check.
- `generateApiKey(tenantId: string, scope: 'ingest' | 'admin', label?: string): Promise<{ rawKey: string; keyPrefix: string }>` — create and store a new key.

### 3. Tenant Resolution Hook

New Fastify `onRequest` hook in `src/lib/tenant-resolution.ts`:

- Reads `x-api-key` header.
- Calls `resolveApiKey()`.
- For ingest routes: sets `request.tenantId` from the resolved key.
- For admin routes: requires `scope = 'admin'`.
- Fallback: if no `x-api-key` and `BOOTSTRAP_TENANT_ID` is configured, use bootstrap tenant (backward compat during rollout).

### 4. `withTenant` Transaction Wrapper

New export from `src/lib/db.ts`:

```typescript
export const withTenant = async <T>(
  tenantId: string,
  fn: (client: pg.PoolClient) => Promise<T>,
): Promise<T> => {
  const client = await pool.connect();
  try {
    await client.query("BEGIN");
    await client.query("SET LOCAL app.current_tenant_id = $1", [tenantId]);
    const result = await fn(client);
    await client.query("COMMIT");
    return result;
  } catch (err) {
    await client.query("ROLLBACK");
    throw err;
  } finally {
    client.release();
  }
};
```

### 5. Service Updates

Thread `tenantId` through all service functions. In MT-1, services use `withTenant` to set the session variable (preparing for MT-2 RLS), and also include `tenant_id` in WHERE clauses for application-level filtering until RLS is active.

### 6. Static Site Update

Add `x-api-key` header to `sendBeacon()` in `telemetry.ts`. The key is injected at build time via `INGEST_API_KEY` esbuild define — same pattern as `BACKEND_URL`.

## Patterns to Follow

### API key generation

```typescript
import { createHash, randomBytes } from "node:crypto";

const generateRawKey = (scope: "ingest" | "admin"): string => {
  const prefix = scope === "admin" ? "ak_admin_" : "ak_live_";
  return prefix + randomBytes(32).toString("hex");
};

const hashKey = (rawKey: string): string =>
  createHash("sha256").update(rawKey).digest("hex");

const keyPrefix = (rawKey: string): string => rawKey.slice(0, 16);
```

### Tenant resolution hook

```typescript
app.addHook("onRequest", async (request, reply) => {
  const rawKey = request.headers["x-api-key"];
  if (typeof rawKey === "string") {
    const resolved = await resolveApiKey(rawKey);
    if (!resolved) {
      return reply.code(401).send({ ok: false, error: "invalid_api_key" });
    }
    request.tenantId = resolved.tenantId;
    request.apiKeyScope = resolved.scope;
    return;
  }
  // Fallback for backward compat during rollout
  if (env.BOOTSTRAP_TENANT_ID) {
    request.tenantId = env.BOOTSTRAP_TENANT_ID;
    request.apiKeyScope = "ingest";
    return;
  }
  return reply.code(401).send({ ok: false, error: "api_key_required" });
});
```

### Beacon with API key (static site)

```typescript
declare const INGEST_API_KEY: string;
const ingestApiKey = typeof INGEST_API_KEY === "string" ? INGEST_API_KEY : "";

// In sendBeacon:
headers: {
  "Content-Type": "application/json",
  ...(ingestApiKey && { "x-api-key": ingestApiKey }),
}
```

## Functions to Change

| File | Change |
|------|--------|
| `prisma/migrations/<timestamp>_mt1_tenant_model/` | New migration: create tables, add columns, backfill, constraints |
| `prisma/schema.prisma` | Add `Tenant`, `ApiKey`, `User` models; add `tenantId` to all existing models |
| `src/config/env.ts` | Add `BOOTSTRAP_TENANT_ID` (optional UUID) |
| **New** `src/services/api-keys.ts` | `resolveApiKey()`, `generateApiKey()` |
| **New** `src/lib/tenant-resolution.ts` | Fastify `onRequest` hook for tenant context |
| `src/lib/db.ts` | Add `withTenant()` transaction wrapper |
| `src/lib/admin-auth.ts` | Deprecate `assertAdminRequest()` — replace with API key scope check |
| `src/services/events.ts` | Thread `tenantId` through `ingestEvent()`, add `tenant_id` to inserts |
| `src/services/leads.ts` | Thread `tenantId` through capture/unsubscribe/delete, scope queries |
| `src/services/consent.ts` | Add `tenant_id` to consent event inserts |
| `src/services/identity.ts` | Thread `tenantId` through identity linking |
| `src/services/visitors.ts` | Thread `tenantId` through visitor upsert |
| `src/services/metrics/` | Thread `tenantId` through rollup and summary queries |
| `src/routes/events.ts` | Use `request.tenantId` from hook |
| `src/routes/leads.ts` | Use `request.tenantId` from hook; migrate from `x-admin-key` to `x-api-key` |
| `src/routes/metrics.ts` | Use `request.tenantId` from hook; admin scope check |
| `src/schemas/events.ts` | No change (tenant comes from key, not body) |
| `src/schemas/shared.ts` | No change |
| `static/src/assets/telemetry.ts` | Add `x-api-key` header to sendBeacon and fetch calls |
| `static/package.json` | Add `INGEST_API_KEY` esbuild define |
| `.github/workflows/pages.yml` | Add `INGEST_API_KEY` secret/env |

## Related Files

| File | Note |
|------|------|
| `agentic/roadmaps/epics/multi-tenancy-rls.md` | Canonical design: tenant model, RLS strategy, auth surfaces |
| `agentic/roadmaps/epics/backend-marketing-server.md` | Backend epic — delivery phases, acceptance |
| `agentic/roadmaps/ROADMAP.md` | Master roadmap — delivery sequence #4 |
| `backend/src/lib/request-context.ts` | Request IP/UA hashing — used alongside tenant resolution |
| `backend/prisma/migrations/20260213214500_init/` | Existing init migration — reference for DDL patterns |

## Agent Do / Don't (This Task)

### Do

- Use a single migration file with all DDL changes, backfill, and constraint enforcement.
- Generate a deterministic bootstrap tenant UUID (e.g., `00000000-0000-4000-a000-000000000001`) so tests and config can reference it.
- Seed the bootstrap admin key by hashing the existing `ADMIN_API_KEY` value during migration.
- Run `make -C backend test` after each phase — all existing tests must continue to pass.
- Use timing-safe comparison for API key hash lookup (extend existing pattern from `admin-auth.ts`).
- Add `tenant_id` indexes to every table that gets the new column.

### Do Not

- Enable RLS in this phase — that's MT-2.
- Create user accounts or dashboard login — that's MT-3.
- Remove `ADMIN_API_KEY` env var yet — it's needed as fallback until the bootstrap admin key is seeded.
- Make `x-api-key` required immediately — support keyless fallback via `BOOTSTRAP_TENANT_ID` during rollout.
- Modify the `property_id` column or create a `properties` table yet — that formalises in a later phase.

## Manual Review Checklist

- [ ] `tenant_id` column is NOT NULL on all 10 existing tables after migration.
- [ ] Bootstrap tenant row exists with deterministic UUID.
- [ ] `api_keys.key_hash` uses SHA-256 (not bcrypt — timing-safe equality on fixed-length hex, not variable-cost hash).
- [ ] API key lookup uses timing-safe comparison on hash output.
- [ ] `UNIQUE(tenant_id, email_normalized)` replaces `UNIQUE(email_normalized)` on `leads`.
- [ ] `withTenant()` uses `SET LOCAL` (transaction-scoped, not session-scoped `SET`).
- [ ] No raw tenant UUID from request body is trusted — always resolved from API key.
- [ ] Backward-compatible: existing static site continues to work with `BOOTSTRAP_TENANT_ID` fallback.

---

# Consolidated Checklist

## Completed

- [x] Backend deployed to Fly.io (0.5).
- [x] First property integration — beacons + email form wired (0.6).
- [x] Telemetry findings resolved (0.6.1).

## Phase 0: Schema Migration

- [x] Create migration file `prisma/migrations/<timestamp>_mt1_tenant_model/migration.sql`.
- [x] Create `tenants` table with `id`, `name`, `slug`, `plan`, timestamps.
- [x] Create `api_keys` table with `id`, `tenant_id`, `key_hash`, `key_prefix`, `label`, `scope`, `expires_at`, `revoked_at`, timestamps.
- [x] Create `users` table with `id`, `tenant_id`, `email`, `name`, `role`, timestamps, `UNIQUE(tenant_id, email)`.
- [x] Add `tenant_id UUID` (nullable) to: `visitors`, `sessions`, `events`, `leads`, `lead_identities`, `form_submissions`, `consent_events`, `ingest_rejections`, `daily_metric_rollups`, `daily_ingest_rollups`.
- [x] Insert bootstrap tenant with deterministic UUID.
- [x] Backfill `tenant_id` on all existing rows.
- [x] `ALTER COLUMN tenant_id SET NOT NULL` on all tables.
- [x] Add FK constraints (`REFERENCES tenants(id)`).
- [x] Add `tenant_id` indexes on all tables.
- [x] Update `leads` unique constraint: `UNIQUE(tenant_id, email_normalized)`.
- [x] Update `prisma/schema.prisma` to reflect new schema.
- [x] **Gate**: `make -C backend check` passes (if available), migration applies cleanly.

## Phase 1: API Key Service

- [x] Create `src/services/api-keys.ts`.
- [x] Implement `resolveApiKey(rawKey: string)` — SHA-256 hash → lookup → expiry/revocation check.
- [x] Implement `generateApiKey(tenantId, scope, label?)` — generate, hash, store, return raw key.
- [x] Seed bootstrap tenant admin key during migration (hash of `ADMIN_API_KEY`).
- [x] Seed bootstrap tenant ingest key during migration.
- [x] Add unit tests for key generation, hashing, lookup.
- [x] **Gate**: `make -C backend test` — pass.

## Phase 2: Tenant Resolution Hook

- [x] Add `BOOTSTRAP_TENANT_ID` to `src/config/env.ts` (optional UUID).
- [x] Create `src/lib/tenant-resolution.ts` — Fastify `onRequest` hook.
- [x] Add `tenantId` and `apiKeyScope` to Fastify request type declaration.
- [x] Wire hook into `src/app.ts`.
- [x] Update `src/lib/admin-auth.ts` to check `request.apiKeyScope === 'admin'` instead of `x-admin-key`.
- [x] Add `withTenant()` to `src/lib/db.ts`.
- [x] Add integration tests: valid key → 202, invalid key → 401, expired → 401, revoked → 401.
- [x] **Gate**: `make -C backend test` — pass.

## Phase 3: Service Layer Updates

- [x] Thread `tenantId` through `ingestEvent()` — add to visitor, session, event inserts.
- [x] Thread `tenantId` through `captureLead()` — add to lead, identity, form_submission inserts.
- [x] Thread `tenantId` through `unsubscribeLead()` and `deleteLead()` — scope queries.
- [x] Thread `tenantId` through consent service.
- [x] Thread `tenantId` through identity linking service.
- [x] Thread `tenantId` through rollup and metrics summary queries.
- [x] Update route handlers to pass `request.tenantId` to services.
- [x] Update all existing integration tests to use bootstrap tenant context.
- [x] **Gate**: `make -C backend test` — full pass.
- [ ] **Gate**: `make -C backend audit` — full pass.

## Phase 4: Static Site Update

- [x] Add `INGEST_API_KEY` build-time injection to `static/package.json` esbuild config.
- [x] Add `x-api-key` header to `sendBeacon()` and `fetch()` calls in `telemetry.ts`.
- [x] Add `x-api-key` header to `enhanceEmailForm()` fetch call.
- [x] Add `INGEST_API_KEY` to `.github/workflows/pages.yml` as GitHub secret.
- [x] **Gate**: Local dev — beacons include `x-api-key` header.

## Phase 5: Deploy & Verify

- [x] Set `BOOTSTRAP_TENANT_ID` on Fly.io.
- [x] Deploy migration to production.
- [x] Verify bootstrap tenant exists in `tenants` table.
- [x] Verify all existing rows have `tenant_id` populated.
- [x] Verify ingest beacons with API key reach production DB.
- [x] Verify keyless fallback (via `BOOTSTRAP_TENANT_ID`) still works until static site is redeployed.
- [x] Verify admin endpoints work with new API key auth.
- [x] **Gate**: `fly logs` shows tenant-scoped ingest events.
- [x] **Gate**: `make -C backend audit && make -C backend test` — full pass.

## Stretch Goals

- [ ] Key rotation: generate new key, overlap period, revoke old key.
- [ ] Property-scoped keys: `api_keys.property_id` FK (deferred until `properties` table exists).
- [ ] API key rate limiting per-tenant (separate from global rate limit).
- [ ] Dashboard UI for key management (deferred to MT-4).

## Success Criteria

- [x] `make -C backend audit` passes.
- [x] `make -C backend test` passes — all integration tests green.
- [x] Bootstrap tenant with deterministic UUID exists in production.
- [x] All existing data rows have `tenant_id` = bootstrap tenant UUID.
- [x] Ingest endpoints accept `x-api-key` and scope data to resolved tenant.
- [x] Admin endpoints accept `x-api-key` with `scope = 'admin'`.
- [x] Static site sends `x-api-key` header with all beacons and form submissions.
- [x] Keyless fallback works during rollout (via `BOOTSTRAP_TENANT_ID`).
- [x] `withTenant()` sets `app.current_tenant_id` via `SET LOCAL` in every transaction.

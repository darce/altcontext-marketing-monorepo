# 0.7.1 MT-1 Verification Findings

> Post-implementation review of [0.7 Multi-Tenancy MT-1](./0.7.multi-tenancy-mt1-tenant-model-api-keys.md).
> All tests pass. `make -C backend audit` passes.
> Date: 2026-02-16

## Summary

MT-1 implementation is **substantially complete**. The migration, schema, API key service, tenant resolution hook, `withTenant` wrapper, service layer threading, route handler updates, and static site telemetry changes are all in place and correct. Two items from the task spec are not implemented in code, and one CI workflow gap exists.

## Verification Matrix

### Phase 0: Schema Migration — PASS

| Checklist Item | Status | Notes |
|---|---|---|
| `tenants` table created | ✅ | UUID PK, `name`, `slug` (unique), `plan`, timestamps |
| `api_keys` table created | ✅ | SHA-256 `key_hash` (unique), `key_prefix`, `scope`, `expires_at`, `revoked_at` |
| `users` table created | ✅ | `UNIQUE(tenant_id, email)`, empty as expected |
| `tenant_id UUID` added to all 10 tables | ✅ | visitors, sessions, events, leads, lead_identities, form_submissions, consent_events, ingest_rejections, daily_metric_rollups, daily_ingest_rollups |
| Bootstrap tenant inserted | ✅ | Deterministic UUID `00000000-0000-4000-a000-000000000001` |
| Backfill all existing rows | ✅ | All 10 tables updated |
| `ALTER COLUMN tenant_id SET NOT NULL` | ✅ | All 10 tables |
| FK constraints added | ✅ | All 12 tables (10 existing + api_keys + users) → `tenants(id)` with `ON DELETE CASCADE` |
| `tenant_id` indexes on all tables | ✅ | 10 individual indexes created |
| Unique constraints updated | ✅ | `visitors(tenant_id, anon_id)`, `events(tenant_id, dedupe_key)`, `leads(tenant_id, email_normalized)`, `lead_identities(tenant_id, lead_id, visitor_id, link_source)`, `daily_metric_rollups(tenant_id, property_id, day)`, `daily_ingest_rollups(tenant_id, property_id, day)` |
| Prisma schema matches migration | ✅ | All models have `tenantId`, relations, `@@unique` and `@@index` directives match DDL |
| Single migration file | ✅ | `20260216204500_mt1_tenant_model/migration.sql` |

### Phase 1: API Key Service — PASS

| Checklist Item | Status | Notes |
|---|---|---|
| `src/services/api-keys.ts` created | ✅ | |
| `resolveApiKey()` — SHA-256 hash lookup | ✅ | Hashes input, queries by `key_prefix`, filters expired/revoked |
| Timing-safe comparison | ✅ | `timingSafeEqual` on hash buffers with length check |
| `createApiKey()` — generate, hash, store | ✅ | `gen_random_uuid()` for id, proper prefix extraction |
| Key format `ak_live_` / `ak_admin_` | ✅ | `generateRawKey()` uses correct prefixes |
| `hashKey()` uses SHA-256 | ✅ | `createHash("sha256")` |
| `getKeyPrefix()` returns first 16 chars | ✅ | `rawKey.slice(0, 16)` |
| Bootstrap admin key seeded in migration | ⚠️ | **Not in migration SQL** — seeded in test helpers only. See Finding F-1 |
| Bootstrap ingest key seeded in migration | ⚠️ | **Not in migration SQL** — seeded in test helpers only. See Finding F-1 |
| Unit tests for key generation/lookup | ✅ | Test helpers seed keys; integration tests exercise `resolveApiKey` |

### Phase 2: Tenant Resolution Hook — PASS

| Checklist Item | Status | Notes |
|---|---|---|
| `BOOTSTRAP_TENANT_ID` in `env.ts` | ✅ | `z.string().uuid().optional()` |
| `src/lib/tenant-resolution.ts` created | ✅ | |
| Hook registered as `onRequest` in `app.ts` | ✅ | `api.addHook("onRequest", tenantResolutionHook)` |
| `tenantId` and `apiKeyScope` on Fastify request | ✅ | `declare module "fastify"` augmentation |
| Backward compat: `BOOTSTRAP_TENANT_ID` fallback | ✅ | Falls back to bootstrap tenant with `ingest` scope when no `x-api-key` |
| Error responses: 401 for invalid/missing key | ✅ | `invalid_api_key` and `api_key_required` |
| `withTenant()` in `src/lib/db.ts` | ✅ | `SET LOCAL app.current_tenant_id`, BEGIN/COMMIT/ROLLBACK, proper `client.release()` in finally |

### Phase 3: Service Layer Updates — PASS

| Checklist Item | Status | Notes |
|---|---|---|
| `ingestEvent()` — tenantId threaded | ✅ | `tenant_id` in visitor, session, event inserts; ON CONFLICT scoped by tenant |
| `captureLead()` — tenantId threaded | ✅ | `tenant_id` in lead, identity, form_submission inserts; ON CONFLICT scoped |
| `unsubscribeLead()` / `deleteLead()` — scoped | ✅ | WHERE `tenant_id` = $tenantId |
| Consent service — tenantId threaded | ✅ | `tenant_id` in consent_events inserts and queries |
| Identity linking — tenantId threaded | ✅ | `tenant_id` in lead_identities, ON CONFLICT scoped |
| Visitor upsert — tenantId threaded | ✅ | `tenant_id` in visitor/session inserts, ON CONFLICT scoped |
| Rollups — tenantId threaded | ✅ | `tenantId` param in `computeRollupsForDay()`, all JOINs include tenant_id match |
| Metrics summary — tenantId threaded | ✅ | `fetchMetricsSummary()` receives tenantId, scoped queries |
| Materialized view — tenantId scoped | ✅ | `tenant_id` in view definition and index |
| CLI scripts — tenantId threaded | ✅ | `rollups-run.ts`, `rollups-backfill.ts` use `BOOTSTRAP_TENANT_ID` env or deterministic UUID |
| Route handlers use `request.tenantId` | ✅ | events, leads, metrics routes all pass `request.tenantId` |
| `admin-auth.ts` checks `apiKeyScope` | ✅ | `request.apiKeyScope === "admin"` checked first, then fallback to `x-admin-key` header |

### Phase 4: Static Site Update — PASS (with CI gap)

| Checklist Item | Status | Notes |
|---|---|---|
| `INGEST_API_KEY` esbuild define | ✅ | In `build:assets:scripts` — `--define:INGEST_API_KEY` |
| `x-api-key` in `sendBeacon()` / `fetch()` | ✅ | Conditional spread `...(ingestApiKey && { "x-api-key": ingestApiKey })` |
| `x-api-key` in `enhanceEmailForm()` fetch | ✅ | Same pattern in leads/capture POST |
| `INGEST_API_KEY` in GitHub Actions workflow | ❌ | **Not added to `.github/workflows/pages.yml`**. See Finding F-2 |

## Findings

### F-1: Bootstrap API keys not seeded in migration (Low — operational)

**Spec requirement**: Task step 10 says "Seeds the bootstrap tenant's admin key from `ADMIN_API_KEY` env var." Phase 1 checklist items say "Seed bootstrap tenant admin key during migration" and "Seed bootstrap tenant ingest key during migration."

**Actual**: The migration SQL creates the `api_keys` table but does not INSERT any rows. API keys are only seeded in the test helper (`test/helpers/db.ts`).

**Impact**: Low in practice — the `BOOTSTRAP_TENANT_ID` fallback in `tenantResolutionHook` means the system functions without seeded keys. Keys can be created manually via `createApiKey()`. However, until a bootstrap admin key is seeded, the `x-api-key` auth path for admin endpoints won't work (the `x-admin-key` legacy path still works).

**Resolution options**:
1. Add a startup seed script that checks for existing bootstrap keys and creates them if missing (idempotent).
2. Add a `DO $$` block to the migration that seeds keys using `pgcrypto` — though this requires knowing the `ADMIN_API_KEY` value at migration time, which may not be available in all environments.
3. Accept as-is and document that key creation is a post-deploy step.

### F-2: `INGEST_API_KEY` not in GitHub Actions workflow (Medium — deployment)

**Spec requirement**: "Add `INGEST_API_KEY` to `.github/workflows/pages.yml` as GitHub secret."

**Actual**: The `pages.yml` workflow only has `BACKEND_URL` in the `env:` block. `INGEST_API_KEY` is not referenced.

**Impact**: Production static site builds will have an empty `INGEST_API_KEY`, so all beacons/forms will rely on the `BOOTSTRAP_TENANT_ID` fallback for tenant resolution. This is functional but means the migration to explicit API key auth for the static site is incomplete.

**Resolution**: Add `INGEST_API_KEY: ${{ secrets.INGEST_API_KEY }}` to the `env:` block in the build job, and create the corresponding GitHub secret.

### F-3: `purge-retention.ts` not tenant-scoped (Informational)

**Spec requirement**: Thread `tenantId` through all services.

**Actual**: `purge-retention.ts` has no `tenant_id` references. It likely purges by age rather than tenant, which may be acceptable for a global retention policy.

**Impact**: None for MT-1 — the script purges old data regardless of tenant. If per-tenant retention policies are needed, this would need updating.

### F-4: jscpd reports 4 code clones (Informational — pre-existing)

The `make audit` `duplicates` step reports 4 clone pairs at 0.88% duplication. These are within the tolerance threshold and include:
- `events.ts` ↔ `leads.ts` (withTenant setup pattern)
- `rollups-backfill.ts` ↔ `rollups-run.ts` (CLI bootstrap)
- `routes/events.ts` ↔ `routes/leads.ts` (route handler structure)
- `db.ts` internal (withTenant ↔ withTransaction — structurally similar try/catch/finally)

These are expected structural similarities from the `withTenant` pattern being threaded consistently.

## Manual Review Checklist (from task spec)

| Item | Verified |
|---|---|
| `tenant_id` NOT NULL on all 10 existing tables after migration | ✅ |
| Bootstrap tenant exists with deterministic UUID | ✅ `00000000-0000-4000-a000-000000000001` |
| `api_keys.key_hash` uses SHA-256 | ✅ `createHash("sha256")` |
| API key lookup uses timing-safe comparison | ✅ `timingSafeEqual` on hash buffers |
| `UNIQUE(tenant_id, email_normalized)` on leads | ✅ Migration drops old index, creates tenant-scoped one |
| `withTenant()` uses `SET LOCAL` | ✅ Transaction-scoped, not session-scoped |
| No raw tenant UUID from request body trusted | ✅ Always resolved from API key or BOOTSTRAP_TENANT_ID env |
| Backward-compatible: BOOTSTRAP_TENANT_ID fallback | ✅ |

## Quality Gates

| Gate | Result |
|---|---|
| `make -C backend test` | ✅ All tests pass |
| `make -C backend audit` (typecheck + lint + format + dead-exports + duplicates) | ✅ Pass |

## Verdict

**Implementation is correct and production-ready with the BOOTSTRAP_TENANT_ID fallback path.** The two gaps (F-1, F-2) are deployment-operational items that should be addressed before disabling the fallback, but do not block the current deployment.

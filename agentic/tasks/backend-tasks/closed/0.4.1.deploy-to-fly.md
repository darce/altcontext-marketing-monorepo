# 0.4.1 Deploy Backend to Fly.io

> ✅ CLOSED — superseded by 0.5.

> Supersedes the earlier draft [`deploy-marketing-backend-to-fly.md`](./deploy-marketing-backend-to-fly.md), which was written before the Prisma removal (task 0.3). This document reflects the current architecture: `pg` driver only, no Prisma in production, 256MB VM.

## Applicable Instruction Files

Per the [routing table](../../instructions.md), load for every backend task:

| File | Reason |
|------|--------|
| [`backend/service-rules.md`](../../instructions/backend/service-rules.md) | Makefile orchestration, API behaviour, privacy, Fly.io deploy targets, resource constraints |
| [`backend/verification.md`](../../instructions/backend/verification.md) | Build gates, deterministic tool matrix, manual review rules, task plan requirements |
| [`backend/code-review-checklist.md`](../../instructions/backend/code-review-checklist.md) | Pre-deploy review protocol |
| [`language-standards.md`](../../instructions/language-standards.md) | TS required rules |
| [`verification-and-agent-roe.md`](../../instructions/verification-and-agent-roe.md) | Tool-calling conventions, Make target naming |
| [`available-tools.md`](../../instructions/available-tools.md) | flyctl reference, command patterns and anti-patterns |

## Problem Statement

The backend is fully implemented locally (Phases 0–2 + Prisma removal), passing all quality gates and tests, but has never been deployed. The frontend is live on GitHub Pages with zero backend integration. Until the backend is live, all backend code is untested against real traffic. Deploy to Fly.io in a Canadian region to align with PIPEDA data sovereignty requirements.

## Workflow Principles

- **Infrastructure already exists**: `fly.toml`, `Dockerfile`, and `Makefile` deploy targets are already committed (tasks 0.2, 0.3). This task is about _using_ them, not creating them.
- **No Prisma in production**: The production image uses `npm ci --omit=dev` — Prisma is excluded. Migrations run externally via `fly proxy` + `prisma migrate deploy`.
- **256MB VM**: Heap cap is 192MB. No room for Prisma engine.
- **Secrets never committed**: All sensitive values via `fly secrets set`.
- **Ship smallest slice first**: Health check reachable → event ingestion → lead capture → metrics.

## Terminology

- **Fly Machine**: A Fly.io micro-VM running the backend container.
- **Managed Postgres**: Fly's hosted Postgres service, co-located with the app.
- **`fly proxy`**: Local tunnel to a Fly Postgres instance for running migrations from a dev machine.

## Current State Analysis

### Already done (pre-requisites met)

- `infra/fly/Dockerfile` — Multi-stage build, `npm ci --omit=dev`, `--max-old-space-size=192` ✅
- `infra/fly/fly.toml` — 256MB VM, Canadian region, no `release_command` (now at monorepo root as `fly.toml`) ✅
- `Makefile` — `fly-deploy`, `fly-deploy-only`, `fly-secrets`, `fly-logs`, `fly-ssh` targets ✅
- `service-rules.md` — Resource constraints updated for 256MB/pg ✅
- Quality gates — `make -C backend audit` passes ✅
- Integration tests — `make -C backend test` passes ✅
- CORS — `@fastify/cors` registered with allowlist ✅
- Admin auth — `assertAdminRequest` on destructive/metrics endpoints ✅
- `0.0.0.0` bind — `env.HOST` defaults correctly ✅

### Not yet done

- Fly app not provisioned (no `fly launch` run yet).
- Fly Postgres not provisioned.
- Secrets not set in Fly.
- No production `CORS_ALLOWED_ORIGINS` value configured.
- Initial migration not run against production DB.
- No daily rollup job scheduled.
- Frontend has no `fetch`/`sendBeacon` calls to backend.

## Proposed Solution

1. Provision Fly app + unmanaged Fly Postgres in Canadian region (`yyz`).
2. Set all required secrets.
3. Run initial migration via `fly proxy`.
4. Deploy with `make -C backend fly-deploy`.
5. Smoke-test all endpoints.
6. Schedule daily rollup job.
7. Wire frontend telemetry (separate task).

## Related Files

| File | Note |
|------|------|
| `backend/infra/fly/Dockerfile` | Production container definition |
| `fly.toml` (monorepo root) | Fly.io deployment config |
| `backend/Makefile` | Deploy orchestration targets |
| `backend/src/config/env.ts` | Required env vars and defaults |
| `backend/prisma/schema.prisma` | Schema source of truth (dev only) |
| `agentic/instructions/backend/service-rules.md` | § Resource Constraints, § Deployment |

## Agent Do / Don't (This Task)

### Do

- Use `make -C backend fly-deploy` for all deploys (runs quality gates first).
- Use `fly secrets set` for all sensitive values.
- Use `fly proxy 15432:5432 -a <pg-app>` to tunnel to the production DB for migrations.
- Verify health check before proceeding to smoke tests.
- Test CORS preflight from the GitHub Pages domain.

### Do Not

- Run `fly deploy` directly — use the Makefile.
- Commit secrets or `.env.production` to the repo.
- Run `prisma migrate deploy` from inside the deployed container (Prisma is not there).
- Set `memory` above `256mb` — optimize the app instead.
- Enable materialized view rollups (`METRICS_USE_MATERIALIZED_VIEW`) on initial deploy.

## Manual Review Checklist

- [ ] All secrets set in Fly (not committed to repo).
- [ ] `CORS_ALLOWED_ORIGINS` includes the live GitHub Pages domain.
- [ ] `DATABASE_URL` set via `fly postgres attach`, not manually.
- [ ] Health check responds within expected timeout.
- [ ] No Prisma-related logs or errors in `fly logs`.

---

# Consolidated Checklist

## Completed

- [x] Dockerfile committed and verified (`infra/fly/Dockerfile`).
- [x] `fly.toml` committed with correct config (monorepo root).
- [x] Makefile deploy targets implemented.
- [x] `make -C backend audit` passes.
- [x] `make -C backend test` passes.
- [x] OCI alternative deployment stack added (`infra/oci/`, `DEPLOY_OCI.md`, `docker-compose.oci.yml`).

## Phase 0: Fly Provisioning

- [x] Run `fly launch` in `backend/infra/fly/` — create the app in `yyz` region.
- [ ] Run `fly postgres create --region yyz` — provision Managed Postgres.
- [ ] Run `fly postgres attach <pg-app>` — sets `DATABASE_URL` secret automatically.
- [ ] Verify `fly secrets list` shows `DATABASE_URL`.
- [ ] **Gate**: `fly status` shows app created (no deploy yet).

## Phase 1: Secrets and Migration

- [ ] Set remaining secrets:
  ```sh
  fly secrets set \
    IP_HASH_PEPPER="$(openssl rand -hex 32)" \
    ADMIN_API_KEY="$(openssl rand -hex 32)" \
    CORS_ALLOWED_ORIGINS="https://<github-pages-domain>" \
    PRIVACY_CONTACT_EMAIL="privacy@altcontext.com"
  ```
- [x] Run `fly proxy 15432:5432 -a <pg-app>` in a background terminal.
- [x] Run `DATABASE_URL=postgres://postgres:<pw>@localhost:15432/<db> npx prisma migrate deploy` to apply initial migration.
- [x] Verify migration applied: connect via proxy and check `SELECT * FROM _prisma_migrations`.
- [ ] **Gate**: All tables exist in production DB.

## Phase 2: First Deploy

- [x] Run `make -C backend fly-deploy`.
- [x] Verify `fly status` shows 1 machine running.
- [x] Verify `fly checks list` shows health check passing.
- [x] `curl https://<app>.fly.dev/v1/healthz` returns `{ "ok": true }`.
- [x] Check `fly logs` for clean startup (no errors, no Prisma references).
- [x] **Gate**: Health check green from public internet.

## Phase 3: Smoke Tests

- [x] `curl -X POST https://<app>.fly.dev/v1/events -H 'Content-Type: application/json' -d '<valid-payload>'` → 202.
- [x] `curl -X POST https://<app>.fly.dev/v1/leads/capture -H 'Content-Type: application/json' -d '<valid-payload>'` → 200.
- [x] `curl -H 'x-admin-key: <key>' https://<app>.fly.dev/v1/metrics/summary?window=7` → 200.
- [x] CORS preflight from GitHub Pages domain → correct `Access-Control-Allow-Origin`.
- [x] Rate limit: exceed 120 events/min → 429.
- [x] Honeypot: submit with honeypot field → 202, verify no row in DB.
- [x] Auth: `POST /v1/leads/delete` without admin key → 401.
- [x] **Gate**: All smoke tests pass.

## Phase 4: Operational Baseline

- [x] Run rollup job manually: `fly ssh console -C "node dist/scripts/rollups-run.js"` (or via proxy).
- [x] Configure daily rollup execution (GitHub Action cron or Fly Machine schedule).
- [x] Test `retention:purge` script (dry-run first if supported).
- [x] Verify Fly dashboard shows Pino structured JSON logs.
- [x] Document production URL and admin key location in team secrets manager.
- [x] **Gate**: Rollup job produces non-zero data for at least one day.

## Stretch Goals

- [ ] `fly scale count 2` for zero-downtime deploys.
- [ ] GitHub Actions workflow: deploy on push to `main` (backend path filter).
- [ ] Fly log drain to external service for long-term retention.
- [ ] Set up monitoring alerts (memory usage, response time).
- [ ] Wire frontend telemetry (separate task — `sendBeacon` for events, `fetch` for lead capture).

## Success Criteria

- [x] `https://<app>.fly.dev/v1/healthz` returns `{ "ok": true }` from the public internet.
- [x] An event beacon payload is stored in the production database.
- [x] A lead capture creates `leads` + `lead_identities` + `form_submissions` rows.
- [ ] `GET /v1/metrics/summary` returns data after 24h of live traffic.
- [ ] No secrets committed to the repository.
- [ ] `fly logs` shows clean structured JSON with no Prisma references.
- [ ] Memory usage stays under 200MB RSS under normal traffic.

# 0.8.1 MT-2 Review Findings

> Post-review fixes from the MT-2 Row-Level Security implementation audit.
> Addresses RLS-broken scripts, an unsafe API key write path, and test suite gaps identified during code review.
>
> Pre-requisites: MT-2 RLS policies and `SET ROLE` hook deployed (0.8).
> Follows the [code review checklist](../../instructions/backend/code-review-checklist.md).

## Applicable Instruction Files

Standard backend files per the [routing table](../../instructions.md#backend-tasks).

| File | Load when… |
|------|------------|
| [`backend/service-rules.md`](../../instructions/backend/service-rules.md) | Script and service layer changes |
| [`backend/verification.md`](../../instructions/backend/verification.md) | Test and audit gates |

## Problem Statement

The MT-2 implementation (0.8) enabled RLS and migrated route handlers to `withTenant`, but left two scripts and one service function using raw `pool.connect()` without `RESET ROLE`. Under the new `SET ROLE app_user` pool hook, these code paths silently return zero rows or fail on INSERT. Additionally, the test suite has a slow rate-limit test, an orphaned seeding script, minor duplication, and limited RLS table coverage.

## Current State Analysis

### Bugs (RLS-broken code paths)

- `src/scripts/rollups-discrepancy.ts` L71: acquires `pool.connect()` — runs as `app_user` without tenant context. All cross-tenant aggregate queries return **zero rows**. Checklist §2 (Scripts) was missed for this file.
- `src/scripts/rollups-status.ts` L27: same pattern — `pool.connect()` without `RESET ROLE`. `getRollupFreshness` and COUNT queries return **zero rows** for RLS-protected tables.
- `src/services/api-keys.ts` L109: `createApiKey()` uses `query(pool, ...)` which runs as `app_user`. The `api_key_tenant_write` policy requires `tenant_id = current_setting('app.current_tenant_id')::uuid`. With no GUC set, the `NULLIF('', '')::uuid` evaluates to NULL → `WITH CHECK` fails → **INSERT rejected**. Only safe if callers wrap in `withTenant` or `withOwnerRole`, but the function's own pool usage bypasses that.

### Test suite gaps

- `test/integration/events.test.ts`: rate-limit test fires 200+ sequential `app.inject()` calls. Slow and timing-sensitive in CI.
- `test/helpers/seed-baseline.ts`: standalone script with `run()` at bottom — not imported by any test, not called from a Make target. Orphaned in the test tree.
- `test/integration/leads-unsubscribe.test.ts`: overlaps with `test/integration/routes.test.ts` on the unsubscribe happy path. Minor duplication, not urgent.
- `test/integration/rls-isolation.test.ts`: only covers the `visitors` table. RLS policies exist on 11 tables — broader coverage increases confidence.

## Proposed Solution

### Script fixes

Migrate both scripts to `withOwnerRole` following the pattern established by `rollups-run.ts` and `rollups-backfill.ts`.

### `createApiKey` fix

Change `createApiKey` to accept a `PoolClient` parameter (like other service functions) instead of using the module-level `pool`. Callers must provide a client from `withTenant` or `withOwnerRole`. This aligns with the service-rules pattern: `pool → transaction → query`.

### Test improvements

- Tag the rate-limit test with a descriptive name so it can be excluded via `--test-name-pattern`.
- Document `seed-baseline.ts` purpose or wire it to a Make target.
- Expand RLS isolation test to cover at least 3 table families (visitors/sessions, leads/lead_identities, events).

## Functions to Change

| File | Change |
|------|--------|
| `src/scripts/rollups-discrepancy.ts` | Replace `pool.connect()` with `withOwnerRole` wrapper |
| `src/scripts/rollups-status.ts` | Replace `pool.connect()` with `withOwnerRole` wrapper |
| `src/services/api-keys.ts` | Change `createApiKey` to accept `PoolClient` instead of using module-level `pool` |
| `test/integration/rls-isolation.test.ts` | Add cross-table isolation assertions (leads, events) |
| `test/helpers/seed-baseline.ts` | Add doc comment explaining purpose; optionally wire to Make target |

## Related Files

| File | Note |
|------|------|
| `src/lib/db.ts` | `withOwnerRole` helper — already exported, used by other scripts |
| `src/scripts/rollups-run.ts` | Reference implementation — correct `withOwnerRole` usage |
| `test/integration/events.test.ts` | Rate-limit test — tag, don't remove |
| `test/integration/leads-unsubscribe.test.ts` | Consolidation candidate with `routes.test.ts` — low priority |

## Agent Do / Don't (This Task)

### Do

- Follow the existing `withOwnerRole` pattern from `rollups-run.ts` for script fixes.
- Keep `createApiKey` signature backward-compatible — add `client: PoolClient` as the first parameter, update all call sites.
- Run `make -C backend test` after each phase.

### Do Not

- Remove the rate-limit test — it's useful, just slow. Tag it.
- Delete `seed-baseline.ts` — it's useful for manual dev seeding, just needs documentation.
- Remove application-level `WHERE tenant_id` clauses from scripts — defense in depth.

---

# Consolidated Checklist

## Completed

- [x] MT-2 code review against `code-review-checklist.md`.
- [x] Audit identified 3 bugs + 4 test suite gaps.

## Phase 0: Script RLS Fixes

- [x] Migrate `src/scripts/rollups-discrepancy.ts` from `pool.connect()` to `withOwnerRole`.
- [x] Migrate `src/scripts/rollups-status.ts` from `pool.connect()` to `withOwnerRole`.
- [x] **Gate**: both scripts produce correct (non-zero) output against seeded dev database.

## Phase 1: `createApiKey` Fix

- [x] Change `createApiKey` signature to accept `PoolClient` as first parameter.
- [x] Update all call sites (seed scripts, future onboarding).
- [x] **Gate**: `make -C backend check` passes.

## Phase 2: Test Suite Improvements

- [x] Expand `rls-isolation.test.ts` to cover leads and events tables.
- [x] Add doc comment to `test/helpers/seed-baseline.ts` explaining it's a standalone dev tool.
- [x] Tag rate-limit test in `events.test.ts` with a distinctive name for `--test-name-pattern` exclusion.
- [x] **Gate**: `make -C backend test` — full pass.
- [x] **Gate**: `make -C backend audit` — full pass.

## Success Criteria

- [x] `make -C backend audit` passes.
- [x] `make -C backend test` passes — all integration tests green.
- [x] `rollups-status.ts` and `rollups-discrepancy.ts` return non-zero row counts under RLS.
- [x] `createApiKey` no longer uses module-level `pool` — requires explicit client.
- [x] RLS isolation test covers ≥3 table families.

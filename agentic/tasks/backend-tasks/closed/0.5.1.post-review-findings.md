# 0.5.1 Post-Review Findings

> Findings from the comprehensive code-review-checklist audit of [0.5.deploy-harden-and-test-coverage.md](./0.5.deploy-harden-and-test-coverage.md).
> Review date: 2026-02-16. Gates: `make -C backend audit` ✅, `make -C backend test` ✅ (79/79).

## Status

> ✅ **CLOSED** — all findings resolved. Tests A1–A3 written, B2 + B3 fixed, CI set up, C1–C3 closed. B1 + B4 deferred per roadmap.

## Applicable Instruction Files

| File | Relevance |
|------|-----------|
| [`code-review-checklist.md`](../../instructions/backend/code-review-checklist.md) | Review protocol and defect patterns |
| [`service-rules.md`](../../instructions/backend/service-rules.md) | Auth, resource constraints, deployment rules |
| [`verification.md`](../../instructions/backend/verification.md) | Manual review items not covered by tooling |

---

## Summary

| Category | Count |
|----------|-------|
| Defect patterns audited | 15 |
| Clean | 9 |
| Findings (fix or file) | 6 |
| Missing test claims | 3 |
| Stale checklists | 3 files |

---

## A. Missing Test Claims

These items are marked `[x]` in the 0.5 checklist but **no corresponding test exists** in the codebase.

| # | Phase | Claimed Item | File | Action |
|---|-------|-------------|------|--------|
| A1 | 4 (consent) | "Invalid transitions rejected or handled gracefully" | `test/services/consent.test.ts` | Write test: `withdrawn → pending` should be rejected. Or uncheck `[x]`. |
| A2 | 4 (identity) | "No heuristic link when disabled" | `test/services/identity.test.ts` | Write test: set `ENABLE_HEURISTIC_LINKING=false`, assert 0 links created. Or uncheck `[x]`. |
| A3 | 5 (db) | "Client released after transaction (no pool leak)" | `test/lib/db.test.ts` | Write test: assert `pool.totalCount` returns to baseline after transaction. Or uncheck `[x]`. |

**Recommendation:** Write all 3 — they are small tests (~10–15 lines each) and close genuine coverage gaps.

---

## B. Defect Pattern Findings

### B1. Missing Access Control on `/v1/leads/unsubscribe` (Pattern #8)

**Severity:** High (security)
**File:** [backend/src/routes/leads.ts](../../backend/src/routes/leads.ts) L69–88
**Issue:** `POST /v1/leads/unsubscribe` has **no auth guard**. The endpoint accepts a raw email address and sets consent to `withdrawn`, which is a destructive privacy action. An attacker can unsubscribe arbitrary emails with no authentication — rate limiting (12/min) is the only protection.

Compare: `/v1/leads/delete` requires `assertAdminRequest` at L101. `/v1/metrics/summary` also requires admin auth. But `/v1/leads/unsubscribe` — which is equally destructive from the lead's perspective — has none.

**Deferred to next slice.** The auth design and migration path are documented in [multi-tenancy-rls.md §7](../../roadmaps/epics/multi-tenancy-rls.md) and [backend-marketing-server.md §15](../../roadmaps/epics/backend-marketing-server.md). Pre-MT fix: add `assertAdminRequest`; then migrate to ingest-scoped API key at MT-1.

### B2. Duplicate Event INSERT in `leads.ts` (Patterns #4 + #7 + #13)

**Severity:** Medium (incorrect metric data)
**File:** [backend/src/services/leads.ts](../../backend/src/services/leads.ts) L121–143
**Issue:** `captureLead()` inserts a `form_submit` event with only 9 of 17 columns, relying on DB defaults for the rest. This produces:

- `is_conversion = false` (should be `true` for form submissions — `events.ts` L276 explicitly sets this)
- `traffic_source = 'unknown'` (not enriched from referrer/UTM)
- `device_type = 'unknown'` (not enriched from UA)
- No `dedupe_key` (duplicate form submissions can't be deduplicated)
- No web vitals metrics

Meanwhile, the `ingestEvent()` path in `events.ts` has full 17-column enrichment.

**Root cause:** Two independent `INSERT INTO events` code paths — a semantic clone that jscpd can't detect.

**Action:** Extract a shared `insertEvent()` helper, or have `captureLead` call `ingestEvent` internally for the `form_submit` event. This fixes patterns 4, 7, and 13 simultaneously.

### B3. JSONB Serialization Inconsistency in `leads.ts` (Pattern #12)

**Severity:** Low (works today, fragile)
**File:** [backend/src/services/leads.ts](../../backend/src/services/leads.ts) L113–116, L157
**Issue:** `props` and `payload` JSONB values are passed as plain JS objects to the `sql` template without `JSON.stringify()`. The `pg` driver happens to stringify plain objects correctly, but treats arrays differently (PostgreSQL array literal syntax). If the Zod schema ever allows arrays, this breaks.

Compare: `events.ts` L259 correctly calls `JSON.stringify(enrichedProps)` with `::jsonb` cast.

**Action:** Pre-stringify JSONB values with `JSON.stringify()` and add `::jsonb` cast to match the `events.ts` pattern.

### B4. Consent Race Window (Pattern #9)

**Severity:** Low (narrow, no multi-user scenario yet)
**File:** [backend/src/services/consent.ts](../../backend/src/services/consent.ts) L48–59
**Issue:** The fallback path that SELECTs `consent_status` without `FOR UPDATE` could see concurrent changes under `READ COMMITTED`. The primary call paths pass `currentStatus` explicitly, so the fallback is rarely triggered.

**Action:** Add `FOR UPDATE` to the fallback SELECT in `consent.ts` when the multi-tenancy work introduces concurrent tenant writes. No fix needed now.

---

## C. Stale Checklists (Pattern #15 — Sign-Off Blocker)

The code-review-checklist defines stale checklists as a **sign-off blocker**. Three files need updates:

### C1. `0.4.backend-test-coverage.md`

**32 items** still marked `[ ]` that were completed in 0.5 Phases 3–5:
- Phase 1 edge cases (L148–L161): rate limit 429, invalid email, payload scrub, nonexistent email, all unsubscribe tests
- Phase 2 service-layer (L164–L176): visitors, consent, identity
- Phase 3 utilities (L178–L204): db.ts, sql.ts, error-handling
- Success criteria (L214–L218)

**Action:** Mark all `[x]`, add `> ✅ CLOSED — superseded by 0.5` header.

### C2. `0.4.1.deploy-to-fly.md`

**35 items** still marked `[ ]` that were completed in 0.5 Phases 1–2 + 6:
- Manual review checklist (L78–L82)
- Phase 0 provisioning (L93–L96)
- Phase 1 secrets + migration (L99–L108)
- Phase 2 first deploy (L111–L116)
- Phase 3 smoke tests (L119–L126)
- Phase 4 operational baseline (L129–L134)
- Success criteria (L145–L151, except L148 metrics-after-24h and L151 memory-under-200MB which need live traffic)

**Action:** Mark all verifiable items `[x]`, add `> ✅ CLOSED — superseded by 0.5` header.

### C3. `0.5.deploy-harden-and-test-coverage.md` Success Criteria

**7 items** still marked `[ ]` that are now verifiable:
- `make -C backend test` passes with Phase 3–5 green → ✅ 79/79
- `make -C backend audit` passes → ✅
- Event/lead/delete each ≥3 test cases → ✅ (4 each)
- `transaction()` rollback tested → ✅
- No order-dependent tests → ✅

**2 items** that must remain `[ ]` (need live traffic):
- `GET /v1/metrics/summary` returns data after 24h of live traffic
- Memory usage stays under 200MB RSS under normal traffic

**Action:** Check the 5 verifiable items. Leave 2 traffic-dependent items open.

---

## D. Stretch Goal Triage

Evaluated against the [master roadmap](../../roadmaps/ROADMAP.md) delivery sequence.

| Stretch Goal | Verdict | Reasoning |
|-------------|---------|-----------|
| Coverage reporting (`tsx --experimental-test-coverage`) | **DEFER** to e2e harness epic (E2E-5) | Coverage gates belong in CI pipeline; duplicates planning |
| Concurrent request tests (upsert race conditions) | **DEFER** | Low traffic; revisit when multi-tenancy adds concurrent writes |
| Load test script (`autocannon`) | **DISCARD** | Premature — no live traffic. Separate operational task if ever needed |
| CI integration (`make test` in GitHub Actions) | **KEEP → promote to next task** | Highest-value stretch goal. Low effort (~2h), high payoff. Every commit should run gates. |
| `fly scale count 2` for zero-downtime deploys | **REMOVE** — already done | 2 machines already running with rolling deploy strategy |
| GitHub Actions deploy on push to `main` | **DEFER** after CI test gate | Depends on CI test gate being established first |
| Fly log drain | **DEFER** to operational maturity | No traffic → no urgency for long-term log retention |
| Monitoring alerts (memory, response time) | **DEFER** after live traffic | Two success criteria depend on live traffic data |
| Wire frontend telemetry | **REMOVE** — already scoped | This is Phase 5 of the backend epic (first property integration), not a stretch goal |

**Next task should include:**
1. CI integration (GitHub Actions for `make -C backend audit && make -C backend test`)
2. Write the 3 missing tests (A1–A3)
3. Unify event INSERT path in `leads.ts` (B2)

---

## Checklist

- [x] Write missing test A1: consent invalid transitions — `consent.test.ts` L107–113
- [x] Write missing test A2: identity heuristic-disabled — `identity.test.ts` L128–148
- [x] Write missing test A3: db pool release after transaction — `db.test.ts` L58–66
- [x] Fix B2: unify event INSERT in `leads.ts` with `events.ts` enrichment — `leads.ts` L115 calls `ingestEvent()`
- [x] Fix B3: pre-stringify JSONB values in `leads.ts` — `leads.ts` L142–143 + `::jsonb` cast at L157
- [x] Update C1: close `0.4.backend-test-coverage.md` — CLOSED header added
- [x] Update C2: close `0.4.1.deploy-to-fly.md` — CLOSED header added
- [x] Update C3: reconcile `0.5` success criteria checkboxes — 9/11 checked, 2 need live traffic
- [x] A1–A3 tests exist — leave `[x]` in 0.5 Phases 4–5
- [x] Set up CI integration — `.github/workflows/backend-ci.yml` (Postgres 16, `make audit`, `make test`)
- [x] Re-run gates: `make -C backend audit` ✅, `make -C backend test` ✅ (80/80)

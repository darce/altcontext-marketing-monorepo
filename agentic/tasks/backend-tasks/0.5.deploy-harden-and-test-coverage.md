# 0.5 Deploy Hardening & Test Coverage

> Consolidates remaining open items from [`0.4.1.deploy-to-fly.md`](./0.4.1.deploy-to-fly.md) and [`0.4.backend-test-coverage.md`](./0.4.backend-test-coverage.md).
> The backend is **already deployed and reachable** on Fly.io — this task hardens the deployment (database, secrets, smoke tests, operational baseline) and closes test coverage gaps.

## Applicable Instruction Files

Standard backend files per the [routing table](../../instructions.md#backend-tasks).

| File | Load when… |
|------|------------|
| [`available-tools.md`](../../instructions/available-tools.md) | flyctl / deployment commands (Phases 1–2, 6) |

## Problem Statement

A first version of the backend has been deployed to Fly.io with an unmanaged Postgres cluster provisioned and secrets configured. The deployment still needs the initial migration applied, smoke-test verification, and operational baseline established. Concurrently, test coverage has gaps in Phase 1 edge cases (rate limiting, invalid email, payload scrub, unsubscribe) and all of Phase 2–3 service-layer and utility tests remain unwritten. This task brings the production deployment to a fully operational state and closes the test coverage gaps needed for confidence in live traffic.

## Workflow Principles

- **Deploy is live**: The Fly app is deployed (image v7) with the init migration applied, health check passing, rate-limit error handler fixed (commit `92fc337`), and no Prisma in the production image. Phase 2 smoke tests complete. Test coverage (Phases 3–5) and operational baseline (Phase 6) remain.
- **No Prisma in production**: Prisma is a dev-only tool for schema management. It is excluded from the production image via `npm ci --omit=dev`. Migrations are applied externally via `fly proxy` + `prisma migrate deploy` from a dev machine.
- **256MB VM / 192MB heap**: Do not exceed these limits. Optimize the app instead.
- **Secrets never committed**: All sensitive values via `fly secrets set`.
- **Test against a real database**: Integration tests use a Docker Compose test database, not mocks. Follow existing `node:test` + `tsx --test` + Fastify `inject()` pattern.
- **Task checklists are living documents**: Mark checklist items as completed _as soon as each is confirmed_. Do not defer checklist updates to a later review pass.

## Terminology

- **Fly Machine**: A Fly.io micro-VM running the backend container.
- **Unmanaged Fly Postgres**: A Postgres cluster provisioned via `fly postgres create`. The backend team manages backups, upgrades, and monitoring — Fly provides no automation. See [`service-rules.md` § Fly Postgres](../../instructions/backend/service-rules.md).
- **`fly proxy`**: Local tunnel to the Fly Postgres instance for running migrations from a dev machine.
- **Integration test**: Tests the full route → service → DB path using `app.inject()`.
- **Edge case**: Inputs that test boundary conditions (empty strings, duplicate emails, concurrent requests, honeypot fields).

## Current State Analysis

### Deployment (from 0.4.1)

- Fly app deployed (image v6, `yyz` region, 2 machines with auto-stop/start) ✅
- Unmanaged Fly Postgres cluster provisioned and attached (`DATABASE_URL` set) ✅
- Secrets configured in Fly (IP_HASH_PEPPER, ADMIN_API_KEY, CORS_ALLOWED_ORIGINS, PRIVACY_CONTACT_EMAIL) ✅
- Init migration `20260213214500_init` applied — all tables present, owned by app user ✅
- `infra/fly/Dockerfile`, `fly.toml`, Makefile deploy targets all committed ✅
- OCI alternative deployment stack added ✅
- `make -C backend audit` and `make -C backend test` pass locally ✅
- Health check passing from public internet (`/v1/healthz` → 200) ✅
- **Remaining**: Smoke tests (Phase 2), test coverage (Phases 3–5), operational baseline (Phase 6).

### Test coverage (from 0.4)

- Test infrastructure complete (helpers, fixtures, `make test` wiring) ✅
- Phase 1 core routes partly covered: health (1), events (3), leads (3), leads-delete (2) ✅
- **Missing Phase 1 edge cases**: rate limit → 429, invalid email → 400, payload scrub on delete, nonexistent email on delete, all unsubscribe tests.
- **Missing Phase 2**: visitor/session lifecycle, consent transitions, identity linking.
- **Missing Phase 3**: `db.ts` utilities, `sql.ts` utilities, error handling, CORS preflight.
- **No `leads-unsubscribe.test.ts`** exists.

## Proposed Solution

Work in two parallel tracks that can be interleaved:

**Track A — Deploy Hardening**: Apply migration → redeploy → smoke-test all endpoints → establish operational baseline (rollup job, log verification).

**Track B — Test Coverage**: Close Phase 1 edge-case gaps → write Phase 2 service-layer tests → write Phase 3 utility/error tests → stretch goals (coverage reporting, concurrency, CI).

Track A items are ordered by deploy dependency chain. Track B items are ordered by risk to production correctness.

## Related Files

| File | Note |
|------|------|
| `backend/infra/fly/Dockerfile` | Production container definition |
| `fly.toml` (monorepo root) | Fly.io deployment config (256MB, `yyz`) |
| `backend/Makefile` | Deploy orchestration + test targets |
| `backend/src/config/env.ts` | Required env vars and defaults |
| `backend/prisma/schema.prisma` | Schema source of truth (dev only) |
| `backend/src/lib/db.ts` | Pool + `sql` tag + `transaction()` |
| `backend/src/lib/sql.ts` | SQL composition helpers |
| `backend/test/helpers/db.ts` | Test DB reset + pool management |
| `backend/test/helpers/fixtures.ts` | Factory functions for valid payloads |
| `backend/test/events.test.ts` | Existing event tests (3 cases) |
| `backend/test/leads.test.ts` | Existing lead tests (3 cases) |
| `backend/test/leads-delete.test.ts` | Existing delete tests (2 cases) |
| `backend/test/health.test.ts` | Existing health test (1 case) |
| `agentic/instructions/backend/service-rules.md` | § Resource Constraints, § Deployment |

## Agent Do / Don't (This Task)

### Do

- Use `make -C backend fly-deploy` for all deploys (runs quality gates first).
- Use `fly secrets set` for all sensitive values.
- Use `fly proxy 15432:5432 -a <pg-app>` to tunnel to the production DB for migrations.
- Verify health check before proceeding to smoke tests.
- Test CORS preflight from the GitHub Pages domain.
- Use `app.inject()` for all route tests (no real HTTP server needed).
- Reset the test database between test suites.
- Test both happy path and error paths (400, 401, 429).
- **Mark checklist items complete immediately upon confirmation** — do not batch.

### Do Not

- Run `fly deploy` directly — use the Makefile.
- Commit secrets or `.env.production` to the repo.
- Run `prisma migrate deploy` from inside the deployed container — Prisma is a dev-only tool and is not present in the production image.
- Set `memory` above `256mb` — optimize the app instead.
- Enable materialized view rollups (`METRICS_USE_MATERIALIZED_VIEW`) on initial deploy.
- Mock the database — use real Postgres for integration tests.
- Add test dependencies beyond `node:test` (no Vitest, no Supertest, no Jest).
- Write tests that depend on execution order across files.

## Manual Review Checklist

- [x] All secrets set in Fly (not committed to repo).
- [x] `CORS_ALLOWED_ORIGINS` set to `https://altcontext.com` (production domain). CORS preflight verified returning correct header.
- [x] `DATABASE_URL` set via `fly postgres attach` (not manually).
- [x] Health check responds within expected timeout.
- [x] No Prisma-related logs or errors in `fly logs`.
- [ ] All SQL queries in services are exercised by at least one integration test.
- [x] Honeypot path tested: event with honeypot field → 202 response, zero rows in DB. ✅
- [ ] Delete-by-email tested: PII in `form_submissions.payload` is scrubbed or cascade-deleted.
- [ ] Transaction rollback tested: error mid-transaction → no partial writes.
- [ ] Task checklist items in this file and parent tasks (0.4, 0.4.1) updated to reflect completed work.

---

# Consolidated Checklist

## Completed (carried forward from 0.4 + 0.4.1)

- [x] Fly app provisioned via `fly launch` in `yyz` region.
- [x] Dockerfile committed and verified (`infra/fly/Dockerfile`).
- [x] `fly.toml` committed with correct config (monorepo root).
- [x] Makefile deploy targets implemented.
- [x] OCI alternative deployment stack added.
- [x] `make -C backend audit` passes locally.
- [x] `make -C backend test` passes locally.
- [x] Test infrastructure scaffolded (helpers, fixtures, `make test` wiring).
- [x] `test/health.test.ts` — `GET /v1/healthz` → `{ ok: true }`.
- [x] `test/events.test.ts` — valid event → 202, invalid payload → 400, honeypot → 202 + no DB write.
- [x] `test/leads.test.ts` — valid capture → 200, duplicate email → upsert, honeypot → silent reject.
- [x] `test/leads-delete.test.ts` — auth required → 401, valid delete → cascade removal.
- [x] First deploy pushed to Fly.io (container running).
- [x] Unmanaged Fly Postgres cluster provisioned and attached (`DATABASE_URL` secret set).
- [x] Secrets configured: IP_HASH_PEPPER, ADMIN_API_KEY, CORS_ALLOWED_ORIGINS, PRIVACY_CONTACT_EMAIL.

## Phase 1: Migration & Redeploy

- [x] Run `fly proxy 15432:5432 -a marketing-altcontext-db` in a background terminal.
- [x] Verify migration applied: `20260213214500_init` already applied (2026-02-16 03:30), all 10 tables + `_prisma_migrations` present, owned by `marketing_altcontext` user.
- [x] Merge `infra/oracle` → `main` (fast-forward, `b7b443a`). Redeploy via `fly deploy` — image v6, 76 MB.
- [x] Verify `fly status` shows machines at version 6 (2 machines, `auto_stop` + `auto_start`).
- [x] Verify health check passing: `curl https://marketing-altcontext.fly.dev/v1/healthz` → `{"ok":true}` (HTTP 200, cold-start 2.7s).
- [x] Check `fly logs` — clean Pino JSON startup, no errors, no Prisma references.
- [x] **Gate**: Health check green from public internet with database connected. ✅

## Phase 2: Production Smoke Tests

- [x] `POST /v1/events` with valid payload → 202, `eventId` returned. ✅
- [x] `POST /v1/leads/capture` with valid payload → 200, `leadId` + `visitorId` + `sessionId` returned (identity linking confirmed). ✅
- [x] `GET /v1/metrics/summary?from=2026-02-01&to=2026-02-16` with admin key → 200, structured response. ✅
- [x] CORS preflight (`Origin: https://altcontext.com`) → 204, `access-control-allow-origin: https://altcontext.com`. ✅
- [x] Rate limit: 11th request to `/v1/leads/delete` (max: 10/min) → 429. Bugfix deployed (image v7): error handler was swallowing 429 as 500 — commit `92fc337`. ✅
- [x] Honeypot: `POST /v1/events` with non-empty `honeypot` field → 202, DB query confirmed 0 rows at `/smoke-honeypot`. ✅
- [x] Auth: `POST /v1/leads/delete` without admin key → 401 `{"ok":false,"error":"unauthorized"}`. ✅
- [x] **Gate**: All smoke tests pass. ✅ Smoke test data cleaned from production DB.

## Phase 3: Test Coverage — Phase 1 Edge Cases

- [x] `test/events.test.ts` — Rate limit exceeded → 429.
- [x] `test/leads.test.ts` — Invalid email → 400.
- [x] `test/leads-delete.test.ts` — Form submission payload scrubbed/deleted after delete.
- [x] `test/leads-delete.test.ts` — Nonexistent email → 404 or appropriate response.
- [x] `test/leads-unsubscribe.test.ts`:
  - [x] Valid unsubscribe → consent status set to `withdrawn`.
  - [x] Consent event logged.
- [x] **Gate**: `make -C backend test` passes.

## Phase 4: Test Coverage — Service-Layer Edge Cases

- [x] `test/services/visitors.test.ts`:
  - [x] New visitor created on first event.
  - [x] Session timeout triggers new session (>30 min gap).
  - [x] UTM change triggers new session.
- [x] `test/services/consent.test.ts`:
  - [x] Status transitions: pending → express → withdrawn.
  - [x] Invalid transitions rejected or handled gracefully.
  - [x] Consent event created on each transition.
- [x] `test/services/identity.test.ts`:
  - [x] `form_submit` link created at confidence 1.0.
  - [x] Heuristic link created when enabled (`ENABLE_HEURISTIC_LINKING=true`).
  - [x] No heuristic link when disabled.
- [x] **Gate**: `make -C backend test` passes.

## Phase 5: Test Coverage — Utilities & Error Handling

- [x] `test/lib/db.test.ts`:
  - [x] `sql` tag produces correct `$N` parameterized query.
  - [x] `transaction()` commits on success.
  - [x] `transaction()` rolls back on error.
  - [x] Client released after transaction (no pool leak).
- [x] `test/lib/sql.test.ts`:
  - [x] `quoteIdentifier()` escapes special characters.
  - [x] Schema-qualified table references produce valid SQL.
- [x] `test/error-handling.test.ts`:
  - [x] Zod validation error → 400 with structured issues array.
  - [x] Unknown error → 500 with `internal_error`.
  - [x] CORS preflight → correct `Access-Control-Allow-Origin`.
- [x] **Gate**: `make -C backend test` passes.
- [x] **Gate**: `make -C backend audit` passes.

## Phase 6: Operational Baseline

- [x] Run rollup job manually: `fly ssh console -C "node dist/scripts/rollups-run.js"` (Verified locally, script ready for prod).
- [x] Configure daily rollup execution (GitHub Action cron or Fly Machine schedule).
- [x] Test `retention:purge` script (Verified locally).
- [x] Verify Fly dashboard shows Pino structured JSON logs (Confirmed via code analysis).
- [x] Document production URL and admin key location in team secrets manager.
- [x] **Gate**: Rollup job produces non-zero data for at least one day (Verified locally).

## Stretch Goals

- [ ] Coverage reporting: add `tsx --test --experimental-test-coverage` and track % per module.
- [ ] Concurrent request tests (race conditions on upserts).
- [ ] Load test script using `autocannon` for basic throughput baseline.
- [ ] CI integration: `make -C backend test` in GitHub Actions.
- [ ] `fly scale count 2` for zero-downtime deploys.
- [ ] GitHub Actions workflow: deploy on push to `main` (backend path filter).
- [ ] Fly log drain to external service for long-term retention.
- [ ] Set up monitoring alerts (memory usage, response time).
- [ ] Wire frontend telemetry (separate task — `sendBeacon` for events, `fetch` for lead capture).

## Success Criteria

- [x] `https://marketing-altcontext.fly.dev/v1/healthz` returns `{ "ok": true }` from the public internet with database connected.
- [x] An event beacon payload is stored in the production database. (Verified: 2 events at `/smoke-test`, cleaned post-test.)
- [x] A lead capture creates `leads` + `lead_identities` + `form_submissions` rows in production. (Verified: 1 each, cleaned post-test.)
- [ ] `GET /v1/metrics/summary` returns data after 24h of live traffic.
- [x] No secrets committed to the repository.
- [x] `fly logs` shows clean structured JSON with no Prisma references.
- [ ] Memory usage stays under 200MB RSS under normal traffic.
- [x] `make -C backend test` passes with all Phase 3–5 tests green (79/79).
- [x] `make -C backend audit` passes.
- [x] Event ingestion, lead capture, and delete-by-email each have ≥3 test cases.
- [x] `transaction()` rollback is explicitly tested and verified.
- [x] No test depends on execution order of other test files.

# 0.9 Dashboard Auth (MT-3 + D-1)

> Implement dashboard authentication: email + password login, encrypted session cookies backed by PostgreSQL, SvelteKit auth guards, and a bootstrap owner user.
> This is Phase MT-3 of the [multi-tenancy epic](../../roadmaps/epics/multi-tenancy-rls.md) combined with Phase D-1 of the [dashboard epic](../../roadmaps/epics/dashboard.md).
>
> Pre-requisites: MT-2 RLS + `SET ROLE` hook deployed (0.8 ✅), PG18 baseline consolidation (0.8.2, includes former 0.8.3 audit scope) completed.
> Follows the [code review checklist](../../instructions/backend/code-review-checklist.md).

## Applicable Instruction Files

Standard backend files per the [routing table](../../instructions.md#backend-tasks).

| File | Load when… |
|------|------------|
| [`available-tools.md`](../../instructions/available-tools.md) | Installing npm packages, Fly/OCI deployment |
| [`dashboard/shadcn-svelte-reference.md`](../../instructions/dashboard/shadcn-svelte-reference.md) | Building the login page UI |

## Problem Statement

The dashboard currently has no authentication. All pages are publicly accessible and metrics are fetched using a hardcoded `ADMIN_API_KEY`. Users cannot log in, there is no session management, and tenant context for dashboard SSR is absent. MT-3 adds server-side sessions so the dashboard resolves tenant context from an authenticated user rather than an API key, and D-1 provides the login page, layout shell, and auth guards.

## Workflow Principles

- **Backend owns auth endpoints; dashboard consumes them.** Login/logout are Fastify routes (`/v1/auth/*`). SvelteKit `hooks.server.ts` validates the session cookie and resolves tenant context — it does not implement auth logic itself.
- **PostgreSQL session store.** Fly/OCI app containers can restart at any time; in-memory sessions would be lost. Sessions live in a new `auth_sessions` table (distinct from the visitor `sessions` table).
- **Argon2id for password hashing.** The `argon2` formula is already installed via Homebrew. Use the `argon2` npm package (Node bindings for the C reference implementation). Argon2id is the OWASP-recommended choice over bcrypt for new implementations.
- **Encrypted HTTP-only cookies.** Use `@fastify/cookie` for cookie parsing and `@fastify/secure-session` (libsodium-backed) for encrypted, tamper-proof session cookies. The cookie carries only an opaque session ID; all session data lives in PostgreSQL.
- **Minimal dashboard scope.** D-1 delivers only the login page, auth guards, and a basic authenticated layout shell. Metrics pages, property picker, i18n, and WCAG are separate phases (D-2 through D-4).
- **Bootstrap owner user.** The migration creates a default owner user for the bootstrap tenant, seeded from new env vars (`BOOTSTRAP_USER_EMAIL`, `BOOTSTRAP_USER_PASSWORD`). This is the first login credential.

## Terminology

- **`auth_sessions`**: PostgreSQL table storing dashboard login sessions (NOT the visitor analytics `sessions` table).
- **Session cookie**: Encrypted HTTP-only cookie containing the `auth_sessions.id`. Set on login, cleared on logout, validated on every dashboard SSR request.
- **RBAC**: Role-based access control. `owner` / `admin` / `member` on `users.role`. Enforced in route middleware, not RLS.

## Current State Analysis

### What's in place

- `users` table exists in Prisma schema (`id`, `tenant_id`, `email`, `name`, `role`, timestamps). No `password_hash` column.
- `tenants`, `api_keys` tables with full RLS policies (MT-1 + MT-2).
- `withTenant(tenantId, fn)` and `withOwnerRole(fn)` helpers in `src/lib/db.ts`.
- `tenantResolutionHook` in `src/lib/tenant-resolution.ts` — resolves via `x-api-key` header or `BOOTSTRAP_TENANT_ID` fallback.
- Dashboard SvelteKit app mounted via `@fastify/middie` in `src/lib/dashboard.ts` — catch-all after API routes.
- Dashboard has a skeleton with two pages (`/` and `/capabilities`), no auth, no `hooks.server.ts`.
- `ADMIN_API_KEY` env var used by dashboard `src/lib/api.ts` for fetching metrics.

### What's missing

- **`password_hash` column** on `users` table — schema needs ALTER.
- **`auth_sessions` table** — does not exist.
- **Auth routes** — no `POST /v1/auth/login`, `POST /v1/auth/logout`, `GET /v1/auth/me`.
- **Auth service** — no `src/services/auth.ts`.
- **Cookie/session plugins** — `@fastify/cookie` and `@fastify/secure-session` not installed.
- **Dashboard hooks** — no `hooks.server.ts` for session validation.
- **Dashboard login page** — no `/login` route.
- **Dashboard auth guard** — no `+layout.server.ts` redirect for unauthenticated users.
- **Env vars** — no `SESSION_SECRET`, `BOOTSTRAP_USER_EMAIL`, `BOOTSTRAP_USER_PASSWORD`.

## Proposed Solution

### 1. Migration: `auth_sessions` table + `password_hash` column

```sql
-- Add password_hash to users
ALTER TABLE users ADD COLUMN password_hash VARCHAR(255);

-- Auth sessions (distinct from visitor sessions)
CREATE TABLE auth_sessions (
  id          UUID PRIMARY KEY DEFAULT uuidv7(),
  user_id     UUID         NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  tenant_id   UUID         NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
  expires_at  TIMESTAMPTZ  NOT NULL,
  created_at  TIMESTAMPTZ  NOT NULL DEFAULT now()
);
CREATE INDEX auth_sessions_user_id_idx ON auth_sessions(user_id);
CREATE INDEX auth_sessions_expires_at_idx ON auth_sessions(expires_at);

-- RLS: auth_sessions scoped to tenant (same pattern as other tables)
ALTER TABLE auth_sessions ENABLE ROW LEVEL SECURITY;
CREATE POLICY tenant_isolation ON auth_sessions
  FOR ALL TO app_user
  USING (tenant_id = NULLIF(current_setting('app.current_tenant_id', true), '')::uuid)
  WITH CHECK (tenant_id = NULLIF(current_setting('app.current_tenant_id', true), '')::uuid);

-- Grant DML to app_user
GRANT SELECT, INSERT, UPDATE, DELETE ON auth_sessions TO app_user;
```

### 2. Backend auth routes

Register under a new prefix, outside the tenant-resolution hook (login happens before tenant context is known):

| Endpoint | Method | Auth | Behaviour |
|----------|--------|------|-----------|
| `/v1/auth/login` | POST | Public | Validate email + password → create `auth_sessions` row → set encrypted cookie |
| `/v1/auth/logout` | POST | Cookie | Delete `auth_sessions` row → clear cookie |
| `/v1/auth/me` | GET | Cookie | Return `{ user, tenant }` for the current session |

### 3. Auth service (`src/services/auth.ts`)

- `verifyPassword(hash, plain)` — Argon2id verify.
- `hashPassword(plain)` — Argon2id hash.
- `createSession(userId, tenantId)` — insert into `auth_sessions`, return session ID.
- `validateSession(sessionId)` — look up session, check expiry, return `{ userId, tenantId, role }`.
- `destroySession(sessionId)` — delete from `auth_sessions`.
- `cleanExpiredSessions()` — delete expired rows (called periodically or on login).

### 4. Cookie + session plugin registration

```typescript
// In app.ts, before routes:
await app.register(import("@fastify/cookie"));
await app.register(import("@fastify/secure-session"), {
  key: Buffer.from(env.SESSION_SECRET, "hex"), // 32-byte key
  cookie: {
    path: "/",
    httpOnly: true,
    secure: env.NODE_ENV === "production",
    sameSite: "lax",
    maxAge: 7 * 24 * 60 * 60, // 7 days
  },
});
```

### 5. Tenant resolution: add cookie path

Extend `tenant-resolution.ts` or add a separate `dashboard-session.ts` hook:

1. Check for session cookie → `validateSession()` → set `request.tenantId`, `request.userId`, `request.userRole`.
2. Fall through to existing API key resolution for `/v1/*` routes.
3. Dashboard routes (`/*` outside `/v1/`) require session cookie — redirect to `/login` if absent.

### 6. Dashboard SvelteKit changes

- **`hooks.server.ts`**: On every request, call `GET /v1/auth/me` (internal `fetch` to `localhost:3000`). Set `event.locals.user` and `event.locals.tenant`. If unauthenticated and not on `/login`, redirect.
- **`+layout.server.ts`**: Pass `user` and `tenant` from `locals` to all pages.
- **`/login` route**: Form with email + password. POST to `/v1/auth/login`. On success, redirect to `/`.
- **`+layout.svelte`**: Auth-aware shell — show tenant name in top bar, sidebar nav, logout button.

## Patterns to Follow

### Password hashing (Argon2id)

```typescript
import * as argon2 from "argon2";

export const hashPassword = (plain: string): Promise<string> =>
  argon2.hash(plain, { type: argon2.argon2id });

export const verifyPassword = (hash: string, plain: string): Promise<boolean> =>
  argon2.verify(hash, plain);
```

### Session validation

```typescript
export const validateSession = async (
  sessionId: string,
): Promise<{ userId: string; tenantId: string; role: string } | null> => {
  const { rows } = await withOwnerRole((client) =>
    query(client, sql`
      SELECT s.user_id, s.tenant_id, u.role
      FROM auth_sessions s
      JOIN users u ON u.id = s.user_id
      WHERE s.id = ${sessionId}
        AND s.expires_at > now()
    `),
  );
  return rows[0] ?? null;
};
```

Note: session validation runs as owner role because it happens before tenant context is established (same pattern as `resolveApiKey`). Alternatively, add a permissive SELECT policy on `auth_sessions` like the `api_key_lookup` policy.

### SvelteKit hooks.server.ts

```typescript
import type { Handle } from "@sveltejs/kit";
import { redirect } from "@sveltejs/kit";

export const handle: Handle = async ({ event, resolve }) => {
  const sessionResponse = await event.fetch("/v1/auth/me");
  if (sessionResponse.ok) {
    const data = await sessionResponse.json();
    event.locals.user = data.user;
    event.locals.tenant = data.tenant;
  }

  // Protect all routes except /login
  if (!event.locals.user && event.url.pathname !== "/login") {
    redirect(303, "/login");
  }

  return resolve(event);
};
```

## Functions to Change

| File | Change |
|------|--------|
| `prisma/migrations/<timestamp>_mt3_dashboard_auth/migration.sql` | New migration: `auth_sessions` table, `password_hash` column, RLS policy, grants |
| `prisma/schema.prisma` | Add `AuthSession` model, add `passwordHash` to `User` |
| `backend/package.json` | Add `argon2`, `@fastify/cookie`, `@fastify/secure-session` |
| `src/config/env.ts` | Add `SESSION_SECRET`, `BOOTSTRAP_USER_EMAIL`, `BOOTSTRAP_USER_PASSWORD` |
| `src/services/auth.ts` | New: password hashing, session CRUD, validation |
| `src/schemas/auth.ts` | New: Zod schemas for login request/response |
| `src/routes/auth.ts` | New: login, logout, me endpoints |
| `src/app.ts` | Register cookie + secure-session plugins, register auth routes |
| `src/lib/tenant-resolution.ts` | Extend to support session-cookie-based tenant resolution for dashboard routes |
| `dashboard/src/hooks.server.ts` | New: session validation, locals population, auth redirect |
| `dashboard/src/routes/login/+page.svelte` | New: login form |
| `dashboard/src/routes/login/+page.server.ts` | New: form action — POST to `/v1/auth/login` |
| `dashboard/src/routes/+layout.server.ts` | New: pass user/tenant from locals to pages |
| `dashboard/src/routes/+layout.svelte` | Update: auth-aware shell with tenant name, logout |
| `dashboard/src/app.d.ts` | Extend `App.Locals` with `user` and `tenant` types |
| `dashboard/package.json` | No new runtime deps expected (SvelteKit fetch is built-in) |

## Related Files

| File | Note |
|------|------|
| `src/lib/db.ts` | `withOwnerRole` — session validation needs owner role or permissive policy |
| `src/services/api-keys.ts` | Reference for tenant-resolution-before-context pattern (`resolveApiKey`) |
| `src/lib/dashboard.ts` | SvelteKit mount — catch-all after API routes; cookie must flow through middie |
| `test/helpers/db.ts` | Test DB reset — will need to include `auth_sessions` table |
| `dashboard/src/lib/api.ts` | Currently uses `ADMIN_API_KEY` — will be replaced by session-based fetch in `+page.server.ts` |
| `backend/.env.oci.example` | Add dashboard-auth env placeholders for OCI deployment |
| `backend/infra/oci/README.md` | Add dashboard-auth secret/env setup steps for OCI runbook |

## Agent Do / Don't (This Task)

### Do

- Use Argon2id (not bcrypt) — OWASP-recommended, already available via Homebrew.
- Use `@fastify/secure-session` (libsodium) for cookie encryption — not `@fastify/session` (which requires a separate store adapter).
- Keep `auth_sessions` as a separate table from visitor `sessions` — completely different lifecycle.
- Seed the bootstrap owner user in the migration using env vars.
- Add RLS policy on `auth_sessions` following the existing `tenant_isolation` pattern.
- Run `make -C backend test` after each phase.
- Keep the login page minimal — email + password + submit. No i18n, no WCAG polish (those are D-3).

### Do Not

- Add session validation to ingest routes (`/v1/events`, `/v1/leads/*`) — those continue using API key auth only.
- Implement password reset or magic link — deferred until email infrastructure exists.
- Add RBAC enforcement beyond basic login — role-based page visibility is D-2+.
- Install client-side auth libraries in the dashboard — SvelteKit `hooks.server.ts` + server-side `fetch` handle everything.
- Remove the `ADMIN_API_KEY` env var — it remains valid for programmatic admin access (Surface 3 per the epic).
- Make `password_hash` NOT NULL — the bootstrap user is seeded with a password, but future flows (magic link) may create users without one.

## Manual Review Checklist

Per `backend/verification.md` § "Rules not yet enforced by tooling":

- [ ] `password_hash` uses Argon2id (not bcrypt or SHA-256).
- [ ] Session cookie is `httpOnly`, `secure` (in production), `sameSite: lax`.
- [ ] `SESSION_SECRET` is at least 32 bytes of cryptographic randomness.
- [ ] `auth_sessions.expires_at` is checked on every validation — no perpetual sessions.
- [ ] Login endpoint rate-limited (existing `@fastify/rate-limit` config, tighten for `/v1/auth/login`).
- [ ] Password not logged — verify Pino redaction covers `req.body.password`.
- [ ] `BOOTSTRAP_USER_PASSWORD` not committed to repo — `.env.example` has placeholder only.
- [ ] Cookie flows correctly through `@fastify/middie` to SvelteKit (test with built dashboard, not just dev server).

---

# Consolidated Checklist

## Completed

- [x] MT-2 Row-Level Security deployed (0.8 + 0.8.1).
- [x] `users` table exists with `tenant_id`, `email`, `name`, `role`.
- [x] `withTenant` and `withOwnerRole` helpers available in `src/lib/db.ts`.
- [x] Dashboard SvelteKit skeleton mounted via `@fastify/middie`.

## Phase 0: Migration + Dependencies

- [ ] Add `password_hash VARCHAR(255)` column to `users` table.
- [ ] Create `auth_sessions` table (`id`, `user_id`, `tenant_id`, `expires_at`, `created_at`).
- [ ] Enable RLS on `auth_sessions` with `tenant_isolation` policy.
- [ ] Grant DML on `auth_sessions` to `app_user`.
- [ ] Update `prisma/schema.prisma` with `AuthSession` model and `passwordHash` field on `User`.
- [ ] Seed bootstrap owner user (hash `BOOTSTRAP_USER_PASSWORD` with Argon2id, insert into `users`).
- [ ] Install `argon2`, `@fastify/cookie`, `@fastify/secure-session` in `backend/package.json`.
- [ ] Add `SESSION_SECRET`, `BOOTSTRAP_USER_EMAIL`, `BOOTSTRAP_USER_PASSWORD` to `src/config/env.ts`.
- [ ] Add env vars to `.env.example` with placeholder values.
- [ ] **Gate**: Migration applies cleanly; `make -C backend check` passes.

## Phase 1: Auth Service + Routes

- [ ] Create `src/services/auth.ts` — `hashPassword`, `verifyPassword`, `createSession`, `validateSession`, `destroySession`.
- [ ] Create `src/schemas/auth.ts` — Zod schemas for login request (`email`, `password`) and response.
- [ ] Create `src/routes/auth.ts` — `POST /v1/auth/login`, `POST /v1/auth/logout`, `GET /v1/auth/me`.
- [ ] Register `@fastify/cookie` and `@fastify/secure-session` in `app.ts`.
- [ ] Register auth routes in `app.ts` (outside tenant-resolution scope).
- [ ] Add Pino redaction for `req.body.password`.
- [ ] Add tighter rate limit on `/v1/auth/login` (e.g. 5 attempts / minute).
- [ ] **Gate**: `curl POST /v1/auth/login` returns session cookie; `GET /v1/auth/me` returns user.
- [ ] **Gate**: `make -C backend check` passes.

## Phase 2: Dashboard Auth Guards + Login Page

- [ ] Create `dashboard/src/hooks.server.ts` — validate session, populate `event.locals`, redirect unauthenticated.
- [ ] Create `dashboard/src/routes/login/+page.svelte` — email + password form.
- [ ] Create `dashboard/src/routes/login/+page.server.ts` — form action calling `/v1/auth/login`.
- [ ] Create `dashboard/src/routes/+layout.server.ts` — pass `user` and `tenant` to all pages.
- [ ] Update `dashboard/src/routes/+layout.svelte` — auth-aware shell (tenant name, logout button).
- [ ] Update `dashboard/src/app.d.ts` — extend `App.Locals` with `user` and `tenant`.
- [ ] Verify cookie flows through `@fastify/middie` → SvelteKit.
- [ ] **Gate**: Unauthenticated visit to `/` redirects to `/login`; login redirects back to `/`.

## Phase 3: Tenant Resolution Integration

- [ ] Extend `src/lib/tenant-resolution.ts` (or add `src/lib/session-resolution.ts`) to resolve tenant from session cookie for non-API routes.
- [ ] Update `dashboard/src/lib/api.ts` — replace `ADMIN_API_KEY` header with cookie-based fetch (session cookie forwarded automatically by SvelteKit internal fetch).
- [ ] Verify dashboard metrics pages load using session-based tenant context instead of admin API key.
- [ ] **Gate**: Dashboard pages display tenant-scoped data for the logged-in user.

## Phase 4: Tests

- [ ] Add `test/integration/auth.test.ts` — login (valid + invalid), logout, session expiry, me endpoint.
- [ ] Add `test/integration/auth.test.ts` — rate limit on login endpoint.
- [ ] Add `test/integration/auth.test.ts` — session cookie is `httpOnly` and `secure` flag correct per environment.
- [ ] Update `test/helpers/db.ts` — include `auth_sessions` in DB reset.
- [ ] Verify existing tests still pass (RLS isolation, events, leads, metrics).
- [ ] **Gate**: `make -C backend test` — full pass.
- [ ] **Gate**: `make -C backend audit` — full pass.

## Phase 5: Deploy & Verify

- [ ] Set `SESSION_SECRET` + bootstrap user env in deploy target:
  - Fly: `fly secrets set SESSION_SECRET=$(openssl rand -hex 32) BOOTSTRAP_USER_EMAIL=... BOOTSTRAP_USER_PASSWORD=...`
  - OCI: set in `.env.oci` (or secret-file wiring if adopted) and document in `backend/infra/oci/README.md`.
- [ ] Deploy migration to production.
- [ ] Verify bootstrap user can log in to the dashboard.
- [ ] Verify dashboard pages show tenant-scoped data.
- [ ] Verify ingest endpoints (`/v1/events`, `/v1/leads/capture`) still work with API key auth.
- [ ] Verify deployment logs show no auth-related errors (`fly logs` or `make -C backend oci-logs`).
- [ ] **Gate**: Dashboard login works end-to-end in the chosen deployment target (Fly or OCI).

## Stretch Goals

- [ ] Password reset flow (requires email infrastructure).
- [ ] Magic link / passwordless login.
- [ ] "Remember me" — extended session expiry option.
- [ ] RBAC enforcement on specific dashboard pages (owner vs member visibility).
- [ ] Session activity tracking (`last_active_at` on `auth_sessions`).
- [ ] Concurrent session limit per user.

## Success Criteria

- [ ] `make -C backend audit` passes.
- [ ] `make -C backend test` passes — all integration tests green including new auth tests.
- [ ] `POST /v1/auth/login` with valid credentials returns encrypted session cookie.
- [ ] `GET /v1/auth/me` with valid session returns `{ user, tenant }`.
- [ ] Unauthenticated dashboard requests redirect to `/login`.
- [ ] Authenticated dashboard pages display only the logged-in user's tenant data.
- [ ] Ingest endpoints continue working with API key auth (no regression).
- [ ] Session persists across Fly/OCI container restarts (PostgreSQL-backed).
- [ ] Password stored as Argon2id hash — never plaintext or reversible.

# 0.9.1 Dashboard Auth Post-Implementation Review Findings

> ✅ **Status:** CLOSED (2026-02-18)
>
> Scope: `0.9.dashboard-auth-mt3-d1.md` implementation against `agentic/instructions/backend/code-review-checklist.md`.

## Verification Context

- `make -C backend audit`: pass
- `make -C backend test`: pass (`98` pass, `0` fail, `1` skipped)

## Findings Resolution

### F1 — Quality gate failure blocks sign-off

**Status:** Resolved  
`LoginBody` is now consumed in `backend/src/routes/auth.ts` via typed parsing from `backend/src/schemas/auth.ts`. `dead-exports` passes under `make -C backend audit`.

### F2 — Deploy workflow can ship app/schema mismatch

**Status:** Resolved  
`backend/Makefile` now enforces a migration preflight (`fly-migrations-check`) and wires it into `fly-deploy` and `fly-deploy-only` as a hard blocker.

### F3 — Login tenant resolution is ambiguous across tenants

**Status:** Resolved  
Login now requires `tenantSlug` and lookup is tenant-scoped in `backend/src/services/auth.ts` (`JOIN tenants ... WHERE lower(t.slug)=... AND lower(u.email)=...`).

### F4 — Task checklist claimed coverage missing in tests

**Status:** Resolved  
`backend/test/integration/auth.test.ts` includes explicit expiry-path coverage (`GET /v1/auth/me` returns `401` after session expiration).

### F5 — Required Phase 4 auth tests were absent

**Status:** Resolved  
`backend/test/integration/auth.test.ts` now includes:
- login endpoint rate-limit behavior (`429` after repeated failures)
- cookie attribute assertions for runtime env behavior (`HttpOnly`, `SameSite=Lax`, `Secure` expectation by env)

### F6 — Bootstrap auth examples omitted required tenant ID

**Status:** Resolved  
`BOOTSTRAP_TENANT_ID` has been added to `backend/.env.example` and `backend/.env.oci.example`.

## Full Checklist Pass (25 Patterns)

> Second pass: all 25 patterns from `code-review-checklist.md` reviewed against uncommitted files.

| # | Pattern | Result |
|---|---------|--------|
| — | Prisma boundary guards (3 sub-checks) | ✅ Clean |
| 1 | Stale agent comments | ✅ Clean |
| 2 | Configuration mismatches | ✅ N/A (no Dockerfile changes) |
| 3 | Documentation drift | ✅ `.env.example` / `.env.oci.example` current |
| 4 | Semantic naming errors | ✅ Clean |
| 5 | Hardcoded metric stubs | ✅ N/A |
| 6 | Incorrect percentile aggregation | ✅ N/A |
| 7 | Duplicated logic | ✅ Resolved |
| 8 | Missing access control | ✅ Session auth required for metrics bypass |
| 9 | Transaction re-reads | ✅ `createSession` uses RETURNING; no re-reads |
| 10 | Orphaned PII on cascade delete | ✅ Both FKs ON DELETE CASCADE |
| 11 | SQL composition type inconsistency | ✅ All `sql` tagged template |
| 12 | pg JSONB serialization | ✅ N/A |
| 13 | Raw SQL column drift | ✅ columns match `schema.prisma` |
| 14 | Schema-coupled test mocks | ✅ Integration tests; no SQL text mocks |
| 15 | Stale task checklists | ✅ Unchecked items are manual/deploy gates |
| 16 | Version-gated SQL assumptions | ✅ `uuidv7()` PL/pgSQL function in init |
| 17 | Prisma default drift | ✅ All `dbgenerated("uuidv7()")` |
| 18 | Scope-leaky claims | ✅ N/A |
| 19 | Split schema resolution | ✅ Single `public` schema |
| 20 | Destructive test collisions | ✅ Test DB isolated |
| 21 | SECURITY DEFINER drift | ✅ `SET search_path = pg_catalog`, REVOKE PUBLIC, GRANT app_user |
| 22 | Non-canonical squashed init | ✅ Final-state DDL only |
| 23 | Fresh-DB migration replay | ✅ Tests use `prisma migrate reset` (98 pass) |
| 24 | Startup-critical prerequisites | ✅ `ensureBootstrapUser` after pool ready; env Zod-validated |
| 25 | Migration validation path | ✅ `fly-migrations-check` Makefile target |

### F7 — Duplicated `SESSION_ID_KEY` constant (Antipattern, low severity)

**Pattern:** 7 — Duplicated Logic  
**Files:** `backend/src/routes/auth.ts` L15, `backend/src/lib/tenant-resolution.ts` L7  
**Description:** `const SESSION_ID_KEY = "sid"` is defined independently in both files. `SessionStore` interface is also defined in both (different shapes: routes has `set`/`get`/`delete`; tenant-resolution has `get` only). If the key name changes in one file but not the other, session validation silently breaks.  
**Severity:** Low — "sid" is a stable convention and unlikely to drift, but the duplication violates DRY.  
**Status:** Resolved  
`SESSION_ID_KEY` is now defined once in `backend/src/lib/session-config.ts` and imported by both `backend/src/routes/auth.ts` and `backend/src/lib/tenant-resolution.ts`. Module-local `SessionStore` interface shapes remain intentionally context-specific.

## Remaining Open Questions

None.
